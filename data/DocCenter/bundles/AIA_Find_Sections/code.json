{
  "_metadata": {
    "bundle_id": "AIA_Find_Sections"
  },
  "objects": {
    "_a-0000ec36-59aa-8000-9be0-011c48011c48_53600": {
      "name": "AIA_Test_GetLatestExtractionModelVersion",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!modelVersion: a!refreshVariable(\n    value: rule!AIA_Extraction_GetModelVersionById(\n      identifier: index(\n        #\"SYSTEM_SYSRULES_queryRecordType_v4\"(\n          recordType: recordType!AIA Extraction Model Version,\n          fields: {\n            recordType!AIA Extraction Model Version.modelVersionId\n          },\n          pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n            startIndex: 1,\n            batchSize: 1,\n            sort: {\n              #\"SYSTEM_SYSRULES_sortInfo\"(\n                field: recordType!AIA Extraction Model Version.modelVersionId\n              )\n            }\n          )\n        ).data[recordType!AIA Extraction Model Version.modelVersionId],\n        1,\n        null\n      )\n    ),\n    refreshAlways: true\n  ),\n  local!modelVersion\n)"
    },
    "_a-0000ee3e-060c-8000-9bb8-011c48011c48_200505": {
      "name": "AIA_Extraction_GetPageRange",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!startPage: tointeger(ri!section.rule.startPage),\n  local!endPage: tointeger(ri!section.rule.endPage),\n  a!map(\n    startPage: if(\n      local!startPage > ri!numPages,\n      1,\n      ri!section.rule.startPage\n    ),\n    endPage: if(\n      local!endPage > ri!numPages,\n      ri!numPages,\n      local!endPage\n    ),\n  )\n)"
    },
    "_a-0000ec5c-9eda-8000-9bec-011c48011c48_117023": {
      "name": "AIA_Extraction_GetModelVersionById",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_queryRecordByIdentifier\"(\n  recordType: recordType!AIA Extraction Model Version,\n  fields: {\n    rule!AIA_EXTRACTION_MODEL_VERSION_FIELDS()\n  },\n  relatedRecordData: {\n    #\"SYSTEM_SYSRULES_relatedRecordData\"(\n      relationship: recordType!AIA Extraction Model Version.fields,\n      sort: #\"SYSTEM_SYSRULES_sortInfo\"(\n        field: recordType!AIA Extraction Model Version Field.order,\n        ascending: true\n      )\n    ),\n    #\"SYSTEM_SYSRULES_relatedRecordData\"(\n      relationship: recordType!AIA Extraction Model Version.fields,\n      sort: #\"SYSTEM_SYSRULES_sortInfo\"(\n        field: recordType!AIA Extraction Model Version Field.order,\n        ascending: true\n      )\n    )\n  },\n  identifier: ri!identifier\n)"
    },
    "_a-0000ec44-cb49-8000-9be6-011c48011c48_82400": {
      "name": "AIA_GetPageCount",
      "type": "Expression Rule",
      "sail_code": "rule!AIA_GetDocumentMetadata(\n  document: ri!document\n).pageCount"
    },
    "_a-0000ecea-6c5f-8000-9c4b-011c48011c48_186476": {
      "name": "AIA_Extraction_HasSectionRule",
      "type": "Expression Rule",
      "sail_code": "a!isNotNullOrEmpty(ri!sectionsMap[ri!ruleType])"
    },
    "_a-0000ecf1-11b9-8000-9c4e-011c48011c48_203145": {
      "name": "AIA_EXTRACTION_MODEL_VERSION_FIELDS",
      "type": "Expression Rule",
      "sail_code": "{\n  /* Base */\n  recordType!AIA Extraction Model Version.status,\n  recordType!AIA Extraction Model Version.updates,\n  recordType!AIA Extraction Model Version.role,\n  recordType!AIA Extraction Model Version.instructions,\n  recordType!AIA Extraction Model Version.modelId,\n  recordType!AIA Extraction Model Version.versionId,\n  recordType!AIA Extraction Model Version.llm,\n  recordType!AIA Extraction Model Version.useAiReview,\n  recordType!AIA Extraction Model Version.aiReviewLlm,\n  recordType!AIA Extraction Model Version.aiReviewRole,\n  recordType!AIA Extraction Model Version.aiReviewInstructions,\n  recordType!AIA Extraction Model Version.useConfidence,\n  recordType!AIA Extraction Model Version.confidenceThreshold,\n  recordType!AIA Extraction Model Version.useSampling,\n  recordType!AIA Extraction Model Version.samplingRate,\n  recordType!AIA Extraction Model Version.instanceCount,\n  /* Fields */\n  recordType!AIA Extraction Model Version.fields.sectionId,\n  recordType!AIA Extraction Model Version.fields.section,\n  recordType!AIA Extraction Model Version.fields.order,\n  recordType!AIA Extraction Model Version.fields.key,\n  recordType!AIA Extraction Model Version.fields.label,\n  recordType!AIA Extraction Model Version.fields.type,\n  recordType!AIA Extraction Model Version.fields.isMultiple,\n  recordType!AIA Extraction Model Version.fields.description,\n  recordType!AIA Extraction Model Version.fields.instructions,\n  recordType!AIA Extraction Model Version.fields.extractionType,\n  recordType!AIA Extraction Model Version.fields.optionRule,\n  recordType!AIA Extraction Model Version.fields.validationRule,\n  recordType!AIA Extraction Model Version.fields.extractionRule,\n  recordType!AIA Extraction Model Version.fields.postProcessRule,\n  recordType!AIA Extraction Model Version.fields.required,\n  recordType!AIA Extraction Model Version.fields.useVision,\n  recordType!AIA Extraction Model Version.fields.isHidden,\n  recordType!AIA Extraction Model Version.fields.isNotTracked,\n  recordType!AIA Extraction Model Version.fields.useAiReview,\n  /* Columns */\n  recordType!AIA Extraction Model Version.fields.columns.order,\n  recordType!AIA Extraction Model Version.fields.columns.key,\n  recordType!AIA Extraction Model Version.fields.columns.label,\n  recordType!AIA Extraction Model Version.fields.columns.type,\n  recordType!AIA Extraction Model Version.fields.columns.isMultiple,\n  recordType!AIA Extraction Model Version.fields.columns.isHidden,\n  recordType!AIA Extraction Model Version.fields.columns.isNotTracked,\n  recordType!AIA Extraction Model Version.fields.columns.description,\n  recordType!AIA Extraction Model Version.fields.columns.instructions,\n  recordType!AIA Extraction Model Version.fields.columns.extractionType,\n  recordType!AIA Extraction Model Version.fields.columns.optionRule,\n  recordType!AIA Extraction Model Version.fields.columns.validationRule,\n  recordType!AIA Extraction Model Version.fields.columns.extractionRule,\n  recordType!AIA Extraction Model Version.fields.columns.postProcessRule,\n  recordType!AIA Extraction Model Version.fields.columns.required,\n  /* Examples */\n  recordType!AIA Extraction Model Version.examples,\n  /* Sections */\n  recordType!AIA Extraction Model Version.sections.name,\n  recordType!AIA Extraction Model Version.sections.description,\n  recordType!AIA Extraction Model Version.sections.rule,\n  /* Validation Rules */\n  recordType!AIA Extraction Model Version.validationRules.name,\n  recordType!AIA Extraction Model Version.validationRules.message,\n  recordType!AIA Extraction Model Version.validationRules.severity,\n  recordType!AIA Extraction Model Version.validationRules.validations,\n  /* Extraction Model */\n  recordType!AIA Extraction Model Version.extractionModel,\n}"
    },
    "_a-0000ece6-6a5d-8000-9c49-011c48011c48_175458": {
      "name": "AIA_Extraction_FilterSections",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!fieldsWithoutSections: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!ModelVersion[recordType!AIA Extraction Model Version.fields],\n      if(\n        and(\n          a!isNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Field.sectionId]),\n          fv!item[recordType!AIA Extraction Model Version Field.extractionType] = cons!AIA_EXTRACTION_TYPES[1]\n        ),\n        fv!item,\n        null\n      )\n    )\n  ),\n  /* Remove sections that have no fields associated with them */\n  local!ruleMaps: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!ModelVersion[recordType!AIA Extraction Model Version.sections],\n      if(\n        contains(\n          ri!ModelVersion[recordType!AIA Extraction Model Version.fields.sectionId],\n          fv!item[recordType!AIA Extraction Model Version Section.id]\n        ),\n        a!map(\n          section: fv!item,\n          rule: if(\n            a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Section.rule]),\n            rule!AIA_ExtractJson(\n              json: fv!item[recordType!AIA Extraction Model Version Section.rule]\n            ),\n            {type: cons!AIA_SECTION_RULE_TYPES[4]}\n          )\n        ),\n        null\n      )\n    )\n  ),\n  /* Add generic section if any fields are missing a section */\n  local!ruleMapsWithFields: if(\n    a!isNotNullOrEmpty(local!fieldsWithoutSections),\n    append(\n      local!ruleMaps,\n      a!map(\n        rule: {\n          type: cons!AIA_SECTION_RULE_TYPES[4]\n        }\n      )\n    ),\n    local!ruleMaps\n  ),\n  local!ruleTypes: union(\n    local!ruleMapsWithFields.rule.type,\n    local!ruleMapsWithFields.rule.type\n  ),\n  reduce(\n    #\"urn:appian:function:v1:a:update\",\n    a!map(),\n    merge(\n      local!ruleTypes,\n      #\"SYSTEM_SYSRULES_forEach\"(\n        local!ruleTypes,\n        index(\n          local!ruleMapsWithFields,\n          wherecontains(\n            tostring(fv!item),\n            touniformstring(local!ruleMapsWithFields.rule.type)\n          )\n        )\n      )    \n    )\n  )\n)"
    },
    "_a-0000ec2d-5396-8000-9bdc-011c48011c48_40909": {
      "name": "AIA_ExtractJson",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!firstTry: rule!AIA_ExtractJsonInner(\n    json: ri!json\n  ),\n  local!result: if(\n    a!isNotNullOrEmpty(local!firstTry),\n    local!firstTry,\n    a!localVariables(\n      local!secondTry: rule!AIA_ExtractJsonInner(\n        json: index(split(ri!json, \"Appian's private AI\"), 1, null),\n      ),\n      if(\n        a!isNotNullOrEmpty(local!secondTry),\n        local!secondTry,\n        a!localVariables(\n          local!thirdTry: rule!AIA_ExtractJsonInner(\n            json: index(split(ri!json, \"Appian's private AI\"), 2, null),\n          ),\n          if(\n            a!isNotNullOrEmpty(local!thirdTry),\n            local!thirdTry,\n            a!localVariables(\n              local!forthTry: rule!AIA_ExtractJsonInner(\n                json: index(split(ri!json, \"<output>\"), 1, null),\n              ),\n              if(\n                a!isNotNullOrEmpty(local!forthTry),\n                local!forthTry,\n                a!localVariables(\n                  local!fifthTry: rule!AIA_ExtractJsonInner(\n                    json: index(split(ri!json, \"</entities>\"), 1, null),\n                  ),\n                  local!fifthTry\n                )\n              )\n            )\n          )\n        )\n      )\n    )\n  ),\n  local!finalResult: if(\n    a!isNullOrEmpty(local!result),\n    null,\n    if(\n      a!defaultValue(ri!returnList, true),\n      local!result,\n      if(\n        rule!SHRD_IsList(local!result),\n        null,\n        local!result\n      )\n    )\n  ),\n  /* Handle scenario where the result comes back as properties of a $schema */\n  if(\n    or(\n      a!defaultValue(ri!returnList, true),\n      a!isNullOrEmpty(local!finalResult),\n      not(contains(\n        a!keys(local!finalResult),\n        \"$schema\"\n      ))\n    ),\n    local!finalResult,\n    local!finalResult.properties\n  )\n)"
    },
    "000dece1-b0c3-8000-0545-7f0000014e7a": {
      "name": "AIA Find Sections",
      "type": "Process Model",
      "sail_code": "// Output: ?\nrule!AIA_Extraction_GetModelVersionById(\n  identifier: pv!ExtractionInstance[recordType!AIA Extraction Instance.modelVersionId]\n)\n\n// Output: ?\nrecordType!AIA Extraction Instance Section(\n  recordType!AIA Extraction Instance Section.instanceId: pv!ExtractionInstance[recordType!AIA Extraction Instance.id],\n  recordType!AIA Extraction Instance Section.sectionId: index(\n    pv!sectionsMap,\n    cons!AIA_SECTION_RULE_TYPES[4],\n    \"section\",\n    recordType!AIA Extraction Model Version Section.id,\n    null\n  ),\n  recordType!AIA Extraction Instance Section.startPage: 1,\n  recordType!AIA Extraction Instance Section.endPage: null,\n  recordType!AIA Extraction Instance Section.documentId: pv!ExtractionInstance[recordType!AIA Extraction Instance.documentId]\n)\n\n// Output: ?\nrule!AIA_Extraction_FilterSections(\n  ModelVersion: pv!ModelVersion\n)\n\n// Output: ?\nrule!AIA_GetPageCount(\n  document: pv!ExtractionInstance[recordType!AIA Extraction Instance.documentId]\n)\n\n// Output: ?\nreject(\n  fn!isnull,\n  a!flatten(\n    {\n      pv!tocSections,\n      pv!pageRangeSections,\n      pv!endDocSections,\n      pv!findTextSections,\n      pv!noSection\n    }\n  )\n)\n\n// Input: ?\n=pv!ExtractionInstance\n\n// Input: ?\n=pv!sectionsMap\n\n// Output: ?\nac!ProcessInfo.pv.SectionInstances\n\n// Input: ?\n=pv!ExtractionInstance\n\n// Input: ?\n=pv!sectionsMap\n\n// Output: ?\nac!ProcessInfo.pv.SectionInstances\n\n// Input: ?\n=#\"SYSTEM_SYSRULES_forEach\"( enumerate(count(pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[2]])), document( pv!ExtractionInstance[recordType!AIA Extraction Instance.documentId], \"name\") & \"_\" & =rule!AIA_Extraction_GetPageRange( section: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[2]][fv!index], numPages: pv!numPages).startPage & \"-\" & =rule!AIA_Extraction_GetPageRange( section: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[2]][fv!index], numPages: pv!numPages).endPage)\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.documentId]\n\n// Input: ?\n=#\"SYSTEM_SYSRULES_forEach\"( enumerate(count(pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[2]])), rule!AIA_Extraction_GetPageRange( section: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[2]][fv!index], numPages: pv!numPages).startPage)\n\n// Input: ?\n=#\"SYSTEM_SYSRULES_forEach\"( enumerate(count(pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[2]])), rule!AIA_Extraction_GetPageRange( section: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[2]][fv!index], numPages: pv!numPages).endPage)\n\n// Output: ?\n#\"SYSTEM_SYSRULES_forEach\"(\n  ac!NewDocumentsCreated,\n  recordType!AIA Extraction Instance Section(\n    recordType!AIA Extraction Instance Section.instanceId: pv!ExtractionInstance[recordType!AIA Extraction Instance.id],\n    recordType!AIA Extraction Instance Section.sectionId: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[2]][fv!index].section[recordType!AIA Extraction Model Version Section.id],\n    recordType!AIA Extraction Instance Section.startPage: ac!StartPages[fv!index],\n    recordType!AIA Extraction Instance Section.endPage: ac!EndPages[fv!index],\n    recordType!AIA Extraction Instance Section.documentId: fv!item\n  )\n)\n\n// Input: ?\n= #\"SYSTEM_SYSRULES_forEach\"( enumerate( count( pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[3]] ) ), document( pv!ExtractionInstance[recordType!AIA Extraction Instance.documentId], \"name\" ) & \"_\" & = rule!AIA_Extraction_GetPageRange( section: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[3]][fv!index], numPages: pv!numPages ).startPage & \"-\" & = rule!AIA_Extraction_GetPageRange( section: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[3]][fv!index], numPages: pv!numPages ).endPage)\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.documentId]\n\n// Input: ?\n= #\"SYSTEM_SYSRULES_forEach\"( enumerate( count( pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[3]] ) ), rule!AIA_Extraction_GetPageRange( section: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[3]][fv!index], numPages: pv!numPages ).startPage)\n\n// Input: ?\n= #\"SYSTEM_SYSRULES_forEach\"( enumerate( count( pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[3]] ) ), rule!AIA_Extraction_GetPageRange( section: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[3]][fv!index], numPages: pv!numPages ).endPage)\n\n// Output: ?\n#\"SYSTEM_SYSRULES_forEach\"(\n  ac!NewDocumentsCreated,\n  recordType!AIA Extraction Instance Section(\n    recordType!AIA Extraction Instance Section.instanceId: pv!ExtractionInstance[recordType!AIA Extraction Instance.id],\n    recordType!AIA Extraction Instance Section.sectionId: pv!sectionsMap[cons!AIA_SECTION_RULE_TYPES[3]][fv!index].section[recordType!AIA Extraction Model Version Section.id],\n    recordType!AIA Extraction Instance Section.startPage: ac!StartPages[fv!index],\n    recordType!AIA Extraction Instance Section.endPage: ac!EndPages[fv!index],\n    recordType!AIA Extraction Instance Section.documentId: fv!item\n  )\n)"
    },
    "_a-0000ee52-8983-8000-9ba6-011c48011c48_27887": {
      "name": "AIA_GetDocumentMetadata",
      "type": "Expression Rule",
      "sail_code": "try(\n  a!match(\n    value: lower(document(ri!document, \"extension\")),\n    equals: \"pdf\",\n    then: getpdfmetadata(document: ri!document),\n    equals: \"eml\",\n    then: a!map(\n      pageCount: try(\n        tointeger(\n          len(\n            #\"SYSTEM_SYSRULES_fromJson_v1\"(reademlfile(ri!document)).body\n          ) / cons!AIA_EML_PAGE_CHAR_COUNT\n        ),\n        1\n      )\n    ),\n    default: a!map(pageCount: 1)\n  ),\n  a!map(pageCount: 1)\n)"
    }
  }
}