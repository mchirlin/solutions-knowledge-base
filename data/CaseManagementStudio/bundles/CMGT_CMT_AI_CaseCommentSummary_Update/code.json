{
  "_metadata": {
    "bundle_id": "CMGT_CMT_AI_CaseCommentSummary_Update"
  },
  "objects": {
    "_a-0000e990-c462-8000-9ba7-011c48011c48_33778": {
      "name": "CMGT_UTIL_SetRecordFields",
      "type": "Expression Rule",
      "sail_code": "/*\nFuture enhancement ideas:\n1 Parameter to skip update if the field isn't present in the object\n--- This would also apply to nested fields, as in, don't set a relationship field if the entire relationship object isn't there because it will instantiate it\n2 Parameter to overwrite based on more enhanced logic\n3 Allow list types for the `value`\n4 Allow reuse to apply setting metadata for nested relationships, but using their own set metadata rule\n--- e.g. CMGT_Entity_SetMetaData can be used in both the Case process and the individual Entity process\n*/\nif(\n  a!isNullOrEmpty(ri!record),\n  ri!record,\n  a!localVariables(\n    local!allUpdates: rule!CMGT_UTIL_RejectBlank(a!flatten(\n      {\n        ri!alwaysOverwrite,\n        ri!childRelationships,\n        #\"SYSTEM_SYSRULES_forEach\"(\n          items: ri!neverOverwrite,\n          expression: #\"urn:appian:function:v1:a:update\"(\n            fv!item,\n            \"value\",\n            /*Specifically using this instead of a!defaultValue() to account for the `{null}` value*/\n            if(\n              rule!CMGT_UTIL_IsBlank(ri!record[fv!item.field]),\n              fv!item.value,\n              ri!record[fv!item.field]\n            )\n          )\n        )\n      }\n    )),\n    local!onlyChangedUpdates: a!flatten(\n      #\"SYSTEM_SYSRULES_forEach\"(\n        items: local!allUpdates,\n        expression: if(\n          or(\n            tostring(ri!record[fv!item.field]) = tostring(fv!item.value),\n            toboolean(fv!item.applyWhen) = false\n          ),\n          {},\n          fv!item\n        )\n      )\n    ),\n    if(\n      a!isNullOrEmpty(local!onlyChangedUpdates),\n      ri!record,\n      #\"urn:appian:function:v1:a:update\"(\n        data: ri!record,\n        index: local!onlyChangedUpdates.field,\n        value: local!onlyChangedUpdates.value\n      )\n    )\n  )\n)"
    },
    "_a-0000e98b-cfe0-8000-9ba5-011c48011c48_22352": {
      "name": "CMGT_UTIL_QueryRecord",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  /*Chosen return type*/\n  local!returnType: a!defaultValue(ri!returnType, \"OBJECT_ARRAY\"),\n  /*Determine the query parameters to use by the return type*/\n  local!queryParams: a!match(\n    value: local!returnType,\n    equals: \"OBJECT_ARRAY\",\n    then: a!map(\n      castToType: if(\n        a!isNullOrEmpty(ri!groupByFields),\n        #\"urn:appian:function:v1:a:listtype?okey=a!listType\"(ri!recordType),\n        'type!{http://www.appian.com/ae/types/2009}Map?list'\n      ),\n      fetchTotalCount: false,\n      isArray: true,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: 1,\n        batchSize: a!defaultValue(\n          ri!pagingInfo.batchSize,\n          cons!CMGT_INT_BATCH_SIZE_MAX\n        ),\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"SINGLE_OBJECT\",\n    then: a!map(\n      castToType: if(\n        a!isNullOrEmpty(ri!groupByFields),\n        ri!recordType,\n        'type!{http://www.appian.com/ae/types/2009}Map'\n      ),\n      fetchTotalCount: false,\n      isArray: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: 1,\n        batchSize: 1,\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"DATA_SUBSET\",\n    then: a!map(\n      castToType: 'type!{http://www.appian.com/ae/types/2009}DataSubset',\n      fetchTotalCount: true,\n      isArray: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: a!defaultValue(ri!pagingInfo.startIndex, 1),\n        batchSize: a!defaultValue(\n          ri!pagingInfo.batchSize,\n          cons!CMGT_INT_BATCH_SIZE_MAX\n        ),\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"TOTAL_COUNT\",\n    then: a!map(\n      castToType: 'type!{http://www.appian.com/ae/types/2009}Integer',\n      fetchTotalCount: true,\n      isArray: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(startIndex: 1, batchSize: 0)\n    ),\n    default: fn!error(\n      \"Invalid returnType, must be one of: OBJECT_ARRAY, SINGLE_OBJECT, DATA_SUBSET, TOTAL_COUNT\"\n    )\n  ),\n  if(\n    /*Early exit for skip execution*/\n    ri!executeWhen = false,\n    cast(\n      local!queryParams.castToType,\n      if(local!queryParams.isArray, {}, null)\n    ),\n    a!localVariables(\n      /*Run the query*/\n      local!queryResult: a!refreshVariable(\n        value: #\"SYSTEM_SYSRULES_queryRecordType_v2\"(\n          recordType: ri!recordType,\n          fields: if(\n            a!isNullOrEmpty(ri!groupByFields),\n            reject(\n              a!isNullOrEmpty,\n              a!flatten(\n                {\n                  ri!fields,\n                  index(ri!relatedRecordData, \"relationship\", {})\n                }\n              )\n            ),\n            #\"SYSTEM_SYSRULES_aggregationFields\"(\n              groupings: #\"SYSTEM_SYSRULES_forEach\"(\n                items: ri!groupByFields,\n                expression: #\"SYSTEM_SYSRULES_grouping\"(field: fv!item, alias: tostring(fv!item))\n              ),\n              measures: #\"SYSTEM_SYSRULES_measure\"(\n                field: ri!groupByFields[1],\n                function: \"COUNT\",\n                alias: \"count\"\n              )\n            )\n          ),\n          filters: #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n            operator: \"AND\",\n            ignoreFiltersWithEmptyValues: true,\n            logicalExpressions: {\n              ri!logicalExpressions,\n              if(\n                and(\n                  a!isNotNullOrEmpty(ri!searchFields),\n                  a!isNotNullOrEmpty(ri!searchTerm)\n                ),\n                #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n                  operator: \"AND\",\n                  logicalExpressions: #\"SYSTEM_SYSRULES_forEach\"(\n                    items: split(trim(ri!searchTerm), \" \"),\n                    expression: a!localVariables(\n                      local!splitSearchTerm: fv!item,\n                      #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n                        operator: \"OR\",\n                        filters: #\"SYSTEM_SYSRULES_forEach\"(\n                          items: ri!searchFields,\n                          expression: #\"SYSTEM_SYSRULES_queryFilter\"(\n                            field: fv!item,\n                            operator: \"includes\",\n                            value: local!splitSearchTerm\n                          )\n                        )\n                      )\n                    )\n                  )\n                ),\n                {}\n              )\n            },\n            filters: ri!filters\n          ),\n          pagingInfo: if(\n            a!isNullOrEmpty(ri!groupByFields),\n            local!queryParams.pagingInfo,\n            #\"urn:appian:function:v1:a:update\"(\n              local!queryParams.pagingInfo,\n              \"sort\",\n              null\n            )\n          ),\n          fetchTotalCount: local!queryParams.fetchTotalCount,\n          relatedRecordData: if(\n            a!isNullOrEmpty(ri!groupByFields),\n            ri!relatedRecordData,\n            {}\n          )\n        ),\n        refreshOnVarChange: ri!triggerRefresh,\n        refreshAfter: { \"RECORD_ACTION\" }\n      ),\n      /*Format the output*/\n      local!output: a!match(\n        value: local!returnType,\n        equals: \"OBJECT_ARRAY\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult.data\n        ),\n        equals: \"SINGLE_OBJECT\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult.data\n        ),\n        equals: \"DATA_SUBSET\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult\n        ),\n        equals: \"TOTAL_COUNT\",\n        then: local!queryResult.totalCount,\n        default: null\n      ),\n      local!output\n    )\n  )\n)"
    },
    "_a-0000e99c-1217-8000-9ba9-011c48011c48_58807": {
      "name": "CMGT_UTIL_TruncateText",
      "type": "Expression Rule",
      "sail_code": "if(\n  or(isnull(ri!text), isnull(ri!maxLength)),\n  ri!text,\n  if(\n    len(ri!text) > ri!maxLength,\n    left(\n      ri!text,\n      max(\n        search(\" \", ri!text, ri!maxLength + 1) - 1,\n        ri!maxLength\n      )\n    ) & \"...\",\n    ri!text\n  )\n)"
    },
    "_a-0000ec2b-3e9f-8000-9cd4-011c48011c48_2750705": {
      "name": "CMGT_CMT_AI_CaseCommentSummary_SetMetaData",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_forEach\"(\n  items: ri!caseCommentSummaries,\n  expression: rule!CMGT_UTIL_SetRecordFields(\n    record: fv!item,\n    alwaysOverwrite: {\n      a!map(\n        field: recordType!CMGT_CMT_AI_CaseCommentSummary.summary,\n        value: rule!CMGT_UTIL_TruncateText(\n          text: fv!item[recordType!CMGT_CMT_AI_CaseCommentSummary.summary],\n          maxLength: cons!CMGT_INT_MAX_CHAR_LIMIT_EXTRA_LARGE\n        ),\n        applyWhen: a!isNotNullOrEmpty(\n          fv!item[recordType!CMGT_CMT_AI_CaseCommentSummary.summary]\n        )\n      ),\n      a!map(\n        field: recordType!CMGT_CMT_AI_CaseCommentSummary.modifiedOn,\n        value: now()\n      ),\n      a!map(\n        field: recordType!CMGT_CMT_AI_CaseCommentSummary.modifiedBy,\n        value: ri!initiator\n      )      \n    },\n    neverOverwrite: {\n      a!map(\n        field: recordType!CMGT_CMT_AI_CaseCommentSummary.createdOn,\n        value: now()\n      ),\n      a!map(\n        field: recordType!CMGT_CMT_AI_CaseCommentSummary.createdBy,\n        value: ri!initiator\n      ),\n\n      a!map(\n        field: recordType!CMGT_CMT_AI_CaseCommentSummary.isActive,\n        value: true\n      )\n    }\n  )\n)"
    },
    "_a-0000ec2b-3e9f-8000-9cd4-011c48011c48_2750725": {
      "name": "CMGT_CMT_AI_ValidateCommentsForSummarization",
      "type": "Expression Rule",
      "sail_code": "if(\n  rule!CMGT_UTIL_IsBlank(ri!comments),\n  /*No comments, but there was a summary, deactivate*/\n  #\"urn:appian:function:v1:a:update\"(\n    ri!caseCommentSummary,\n    recordType!CMGT_CMT_AI_CaseCommentSummary.isActive,\n    false\n  ),\n  /*Comments but invalid*/\n  #\"urn:appian:function:v1:a:update\"(\n    ri!caseCommentSummary,\n    {\n      recordType!CMGT_CMT_AI_CaseCommentSummary.invalidSummaryReasoning,\n      recordType!CMGT_CMT_AI_CaseCommentSummary.isActive,\n      \n    },\n    {\n      if(\n        /*Length check on comments. If less than 500, we add validation error*/\n        sum(ri!comments.totalCommentCharCount) < cons!CMGT_CT_AI_MIN_LENGTH_TO_SUMMARIZE_COMMENT,\n        #\"urn:appian:translation-string:v1:83ea2067-f458-4519-a2ff-6fc509a651ef\",\n        \"\"\n      ),\n      true\n    }\n  )\n)"
    },
    "_a-0000ec2b-3e9f-8000-9cd4-011c48011c48_2732553": {
      "name": "CMGT_CMT_AI_constructCaseCommentSummary",
      "type": "Expression Rule",
      "sail_code": "recordType!CMGT_CMT_AI_CaseCommentSummary(\n  recordType!CMGT_CMT_AI_CaseCommentSummary.cmtAiCaseCommentSummaryId: null(),\n  recordType!CMGT_CMT_AI_CaseCommentSummary.caseId: ri!caseId,\n  recordType!CMGT_CMT_AI_CaseCommentSummary.createdOn: now(),\n  recordType!CMGT_CMT_AI_CaseCommentSummary.createdBy: ri!createdBy,\n  recordType!CMGT_CMT_AI_CaseCommentSummary.isActive: true\n)"
    },
    "_a-0000ec06-54a3-8000-9cca-011c48011c48_2508993": {
      "name": "CMGT_CMT_AI_QR_getCaseCommentSummary",
      "type": "Expression Rule",
      "sail_code": "rule!CMGT_UTIL_QueryRecord(\n  recordType: recordType!CMGT_CMT_AI_CaseCommentSummary,\n  returnType: ri!returnType,\n  executeWhen: ri!executeWhen,\n  triggerRefresh: ri!triggerRefresh,\n  filters: {\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_CMT_AI_CaseCommentSummary.caseId,\n      operator: \"=\",\n      value: ri!caseId\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_CMT_AI_CaseCommentSummary.isActive,\n      operator: \"=\",\n      value: ri!isActive\n    ),\n    ri!additionalFilters\n  },\n  fields: ri!fields,\n  pagingInfo: ri!pagingInfo,\n  /*sorted latest first by default*/\n  sort: a!defaultValue(\n    value: ri!sort,\n    default: #\"SYSTEM_SYSRULES_sortInfo\"(\n      field: recordType!CMGT_CMT_AI_CaseCommentSummary.cmtAiCaseCommentSummaryId,\n      ascending: false()\n    )\n  )\n)"
    },
    "000aec0b-fe6a-8000-124a-7f0000014e7a": {
      "name": "CMGT_CMT_AI_CaseCommentSummary_Update",
      "type": "Process Model",
      "sail_code": "// Output: ?\nrule!CMGT_CMT_AI_ValidateCommentsForSummarization(\n  comments: pv!commentDetails,\n  caseCommentSummary: pv!caseCommentSummary\n)\n\n// Input: ?\n=pv!commentDetails\n\n// Output: ?\nappian:record-field:v1:a97d7d5c-2a3e-4bc9-829d-ab1d818378ad/a64ddefe-e4b1-45e5-a20b-d987e338113b\"]:AC!Response\n\n// Output: ?\nappian:record-field:v1:a97d7d5c-2a3e-4bc9-829d-ab1d818378ad/e21ab505-8023-4e7a-8f43-5551df78f065\"]:true\n\n// Output: ?\nappian:record-field:v1:a97d7d5c-2a3e-4bc9-829d-ab1d818378ad/1940abec-4a93-493c-b8ef-e975736709d7\"]:if(\n  a!isNotNullOrEmpty(ac!ErrorMessage),\n  #\"urn:appian:translation-string:v1:4714c1ae-120e-4f65-8574-372dbcd819d2\",\n  null\n)\n\n// Input: ?\n=rule!CMGT_CMT_AI_TransformCommentsForPromptBuilder(caseId: pv!caseId)\n\n// Output: ?\na!defaultValue(\n  rule!CMGT_CMT_AI_QR_getCaseCommentSummary(caseId: pv!caseId),\n  rule!CMGT_CMT_AI_constructCaseCommentSummary(\n    caseId: pv!caseId,\n    createdBy: pp!initiator\n  )\n)\n\n// Input: ?\n={ {\n  rule!CMGT_CMT_AI_CaseCommentSummary_SetMetaData(\n    caseCommentSummaries: pv!caseCommentSummary,\n    initiator: pp!initiator\n  )\n}}\n\n// Input: ?\n={recordType!CMGT_CMT_AI_CaseCommentSummary}\n\n// Output: ?\nAC!RecordsUpdated"
    },
    "_a-0000ec34-784f-8000-9cd6-011c48011c48_2761984": {
      "name": "CMGT_CMT_AI_TransformCommentsForPromptBuilder",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!nestedComments: rule!CMGT_QR_GetComment(\n    returnType: \"OBJECT_ARRAY\",\n    caseId: ri!caseId,\n    pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(1, 1000),\n    includeChildComments: true(),\n    /*Since we are nesting child comments inside parent comments, querying only for parent comments*/\n    onlyParentComments: true(),\n    /*summarize only for active and private comments*/\n    additionalFilters: {\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!CMGT_Comment.isActive,\n        operator: \"=\",\n        value: true\n      ),\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!CMGT_Comment.isPrivate,\n        operator: \"=\",\n        value: true\n      ),\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!CMGT_Comment.taskId,\n        operator: \"is null\"\n      )\n    },\n    sort: #\"SYSTEM_SYSRULES_sortInfo\"(\n      recordType!CMGT_Comment.createdOn,\n      true\n    )\n  ),\n  #\"SYSTEM_SYSRULES_forEach\"(\n    items: local!nestedComments,\n    expression: a!map(\n      commenter: fv!item[#\"urn:appian:record-field:v1:e57250b0-f216-4a23-afd9-39e7d532d302-cmgt/f1bcb252-9f3e-40ce-bb79-5a8359cef95d-cmgt/SYSTEM_RECORD_TYPE_USER_FIELD_firstAndLastName\"],\n      createdOn: fv!item[recordType!CMGT_Comment.createdOn],\n      commentText: fv!item[recordType!CMGT_Comment.commentText],\n      childComments: #\"SYSTEM_SYSRULES_forEach\"(\n        items: fv!item[recordType!CMGT_Comment.childComments],\n        expression: a!map(\n          commenter: fv!item[#\"urn:appian:record-field:v1:e57250b0-f216-4a23-afd9-39e7d532d302-cmgt/f1bcb252-9f3e-40ce-bb79-5a8359cef95d-cmgt/SYSTEM_RECORD_TYPE_USER_FIELD_firstAndLastName\"],\n          createdOn: fv!item[recordType!CMGT_Comment.createdOn],\n          commentText: fv!item[recordType!CMGT_Comment.commentText]\n        )\n      ),\n      totalCommentCharCount: sum(tointeger(len(fv!item[recordType!CMGT_Comment.commentText])),tointeger(len(fv!item[recordType!CMGT_Comment.childComments.commentText])))\n\n    )\n  )\n)"
    },
    "_a-0000e990-c462-8000-9ba7-011c48011c48_25890": {
      "name": "CMGT_UTIL_IsBlank",
      "type": "Expression Rule",
      "sail_code": "length(a!flatten(ri!value)) = 0"
    },
    "_a-0000e990-c462-8000-9ba7-011c48011c48_29424-cmgt": {
      "name": "CMGT_QR_GetComment",
      "type": "Expression Rule",
      "sail_code": "rule!CMGT_UTIL_QueryRecord(\n  recordType: recordType!CMGT_Comment,\n  returnType: ri!returnType,\n  triggerRefresh: ri!triggerRefresh,\n  executeWhen: ri!executeWhen,\n  filters: {\n    ri!additionalFilters,\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Comment.caseId,\n      operator: \"=\",\n      value: ri!caseId\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Comment.taskId,\n      operator: \"=\",\n      value: ri!taskId\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Comment.commentId,\n      operator: \"in\",\n      value: ri!commentId\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Comment.parentCommentId,\n      operator: \"is null\",\n      applyWhen: ri!onlyParentComments = true\n    )\n  },\n  logicalExpressions: ri!additionalLogicalExpressions,\n  fields: {\n    ri!fields,\n    if(\n      ri!includeCase,\n      recordType!CMGT_Comment.case,\n      {}\n    ),\n    if(\n      ri!includeTask,\n      recordType!CMGT_Comment.task,\n      {}\n    ),\n    if(\n      ri!includeUserTagsAndDocumentMaps,\n      {\n        recordType!CMGT_Comment.userTags,\n        recordType!CMGT_Comment.userTags,\n        recordType!CMGT_Comment.commentDocumentMap,\n        recordType!CMGT_Comment.commentDocumentMap\n      },\n      {}\n    ),\n    if(\n      ri!includeChildComments,\n      {\n        recordType!CMGT_Comment.childComments,\n        if(\n          ri!includeUserTagsAndDocumentMaps,\n          {\n            recordType!CMGT_Comment.childComments,\n            #\"urn:appian:record-relationship:v1:e57250b0-f216-4a23-afd9-39e7d532d302-cmgt/3fbb8e70-35d5-460e-aee9-d05940b75a05/18e4567c-a0ea-4ba1-bcff-220a1ef13668-cmgt/e7ba3b0b-ab6f-4600-9551-ea4a0d70d530-cmgt\",\n            recordType!CMGT_Comment.childComments,\n            #\"urn:appian:record-relationship:v1:e57250b0-f216-4a23-afd9-39e7d532d302-cmgt/3fbb8e70-35d5-460e-aee9-d05940b75a05/4482fa71-8c71-40a5-98f2-773715556151/71840277-2340-479f-be2c-7d05e30ba12f\"\n          },\n          {}\n        )\n      },\n      {}\n    ),\n    recordType!CMGT_Comment.createdByUser\n  },\n  pagingInfo: ri!pagingInfo,\n  relatedRecordData: {\n    ri!relatedRecordData,\n    if(\n      ri!includeChildComments,\n      #\"SYSTEM_SYSRULES_relatedRecordData\"(\n        relationship: recordType!CMGT_Comment.childComments,\n        limit: 10,\n        sort: #\"SYSTEM_SYSRULES_sortInfo\"(\n          field: recordType!CMGT_Comment.createdOn,\n          ascending: true\n        )\n      ),\n      {}\n    )\n  },\n  groupByFields: ri!groupByFields,\n  searchTerm: ri!searchTerm,\n  searchFields: {\n    recordType!CMGT_Comment.commentText,\n    #\"urn:appian:record-field:v1:e57250b0-f216-4a23-afd9-39e7d532d302-cmgt/18e4567c-a0ea-4ba1-bcff-220a1ef13668-cmgt/e7ba3b0b-ab6f-4600-9551-ea4a0d70d530-cmgt/SYSTEM_RECORD_TYPE_USER_FIELD_firstAndLastName\",\n    if(\n      ri!includeChildComments,\n      {\n        recordType!CMGT_Comment.childComments.commentText,\n        #\"urn:appian:record-field:v1:e57250b0-f216-4a23-afd9-39e7d532d302-cmgt/3fbb8e70-35d5-460e-aee9-d05940b75a05/18e4567c-a0ea-4ba1-bcff-220a1ef13668-cmgt/e7ba3b0b-ab6f-4600-9551-ea4a0d70d530-cmgt/SYSTEM_RECORD_TYPE_USER_FIELD_firstAndLastName\"\n      },\n      {}\n    )\n  },\n  sort: ri!sort\n)"
    }
  }
}