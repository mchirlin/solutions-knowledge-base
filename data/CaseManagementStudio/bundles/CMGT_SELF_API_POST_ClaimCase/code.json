{
  "_metadata": {
    "bundle_id": "CMGT_SELF_API_POST_ClaimCase"
  },
  "objects": {
    "_a-0000e9d3-70bf-8000-9bbd-011c48011c48_180568": {
      "name": "CMGT_UTIL_IsNotBlank",
      "type": "Expression Rule",
      "sail_code": "not(rule!CMGT_UTIL_IsBlank(ri!input))"
    },
    "_a-0000e98b-cfe0-8000-9ba5-011c48011c48_22352": {
      "name": "CMGT_UTIL_QueryRecord",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  /*Chosen return type*/\n  local!returnType: a!defaultValue(ri!returnType, \"OBJECT_ARRAY\"),\n  /*Determine the query parameters to use by the return type*/\n  local!queryParams: a!match(\n    value: local!returnType,\n    equals: \"OBJECT_ARRAY\",\n    then: a!map(\n      castToType: if(\n        a!isNullOrEmpty(ri!groupByFields),\n        #\"urn:appian:function:v1:a:listtype?okey=a!listType\"(ri!recordType),\n        'type!{http://www.appian.com/ae/types/2009}Map?list'\n      ),\n      fetchTotalCount: false,\n      isArray: true,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: 1,\n        batchSize: a!defaultValue(\n          ri!pagingInfo.batchSize,\n          cons!CMGT_INT_BATCH_SIZE_MAX\n        ),\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"SINGLE_OBJECT\",\n    then: a!map(\n      castToType: if(\n        a!isNullOrEmpty(ri!groupByFields),\n        ri!recordType,\n        'type!{http://www.appian.com/ae/types/2009}Map'\n      ),\n      fetchTotalCount: false,\n      isArray: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: 1,\n        batchSize: 1,\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"DATA_SUBSET\",\n    then: a!map(\n      castToType: 'type!{http://www.appian.com/ae/types/2009}DataSubset',\n      fetchTotalCount: true,\n      isArray: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: a!defaultValue(ri!pagingInfo.startIndex, 1),\n        batchSize: a!defaultValue(\n          ri!pagingInfo.batchSize,\n          cons!CMGT_INT_BATCH_SIZE_MAX\n        ),\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"TOTAL_COUNT\",\n    then: a!map(\n      castToType: 'type!{http://www.appian.com/ae/types/2009}Integer',\n      fetchTotalCount: true,\n      isArray: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(startIndex: 1, batchSize: 0)\n    ),\n    default: fn!error(\n      \"Invalid returnType, must be one of: OBJECT_ARRAY, SINGLE_OBJECT, DATA_SUBSET, TOTAL_COUNT\"\n    )\n  ),\n  if(\n    /*Early exit for skip execution*/\n    ri!executeWhen = false,\n    cast(\n      local!queryParams.castToType,\n      if(local!queryParams.isArray, {}, null)\n    ),\n    a!localVariables(\n      /*Run the query*/\n      local!queryResult: a!refreshVariable(\n        value: #\"SYSTEM_SYSRULES_queryRecordType_v2\"(\n          recordType: ri!recordType,\n          fields: if(\n            a!isNullOrEmpty(ri!groupByFields),\n            reject(\n              a!isNullOrEmpty,\n              a!flatten(\n                {\n                  ri!fields,\n                  index(ri!relatedRecordData, \"relationship\", {})\n                }\n              )\n            ),\n            #\"SYSTEM_SYSRULES_aggregationFields\"(\n              groupings: #\"SYSTEM_SYSRULES_forEach\"(\n                items: ri!groupByFields,\n                expression: #\"SYSTEM_SYSRULES_grouping\"(field: fv!item, alias: tostring(fv!item))\n              ),\n              measures: #\"SYSTEM_SYSRULES_measure\"(\n                field: ri!groupByFields[1],\n                function: \"COUNT\",\n                alias: \"count\"\n              )\n            )\n          ),\n          filters: #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n            operator: \"AND\",\n            ignoreFiltersWithEmptyValues: true,\n            logicalExpressions: {\n              ri!logicalExpressions,\n              if(\n                and(\n                  a!isNotNullOrEmpty(ri!searchFields),\n                  a!isNotNullOrEmpty(ri!searchTerm)\n                ),\n                #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n                  operator: \"AND\",\n                  logicalExpressions: #\"SYSTEM_SYSRULES_forEach\"(\n                    items: split(trim(ri!searchTerm), \" \"),\n                    expression: a!localVariables(\n                      local!splitSearchTerm: fv!item,\n                      #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n                        operator: \"OR\",\n                        filters: #\"SYSTEM_SYSRULES_forEach\"(\n                          items: ri!searchFields,\n                          expression: #\"SYSTEM_SYSRULES_queryFilter\"(\n                            field: fv!item,\n                            operator: \"includes\",\n                            value: local!splitSearchTerm\n                          )\n                        )\n                      )\n                    )\n                  )\n                ),\n                {}\n              )\n            },\n            filters: ri!filters\n          ),\n          pagingInfo: if(\n            a!isNullOrEmpty(ri!groupByFields),\n            local!queryParams.pagingInfo,\n            #\"urn:appian:function:v1:a:update\"(\n              local!queryParams.pagingInfo,\n              \"sort\",\n              null\n            )\n          ),\n          fetchTotalCount: local!queryParams.fetchTotalCount,\n          relatedRecordData: if(\n            a!isNullOrEmpty(ri!groupByFields),\n            ri!relatedRecordData,\n            {}\n          )\n        ),\n        refreshOnVarChange: ri!triggerRefresh,\n        refreshAfter: { \"RECORD_ACTION\" }\n      ),\n      /*Format the output*/\n      local!output: a!match(\n        value: local!returnType,\n        equals: \"OBJECT_ARRAY\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult.data\n        ),\n        equals: \"SINGLE_OBJECT\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult.data\n        ),\n        equals: \"DATA_SUBSET\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult\n        ),\n        equals: \"TOTAL_COUNT\",\n        then: local!queryResult.totalCount,\n        default: null\n      ),\n      local!output\n    )\n  )\n)"
    },
    "_a-0000ebf3-df94-8000-9cc3-011c48011c48_2378423": {
      "name": "CMGT_QR_GetPortalCaseContact",
      "type": "Expression Rule",
      "sail_code": "rule!CMGT_UTIL_QueryRecord(\n  recordType: recordType!CMGT_Portal_CaseContact,\n  returnType: ri!returnType,\n  executeWhen: ri!executeWhen,\n  triggerRefresh: ri!triggerRefresh,\n  filters: {\n    ri!additionalFilters,\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.portalCaseContactId,\n      operator: \"in\",\n      value: ri!portalCaseContactId\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.caseId,\n      operator: \"=\",\n      value: ri!caseId\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.firstName,\n      operator: \"=\",\n      value: ri!firstName\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.lastName,\n      operator: \"=\",\n      value: ri!lastName\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.isActive,\n      operator: \"=\",\n      value: ri!isActive\n    )\n  },\n  fields: ri!fields,\n  pagingInfo: ri!pagingInfo,\n  sort: a!defaultValue(\n    value: ri!sort,\n    default: #\"SYSTEM_SYSRULES_sortInfo\"(\n      field: recordType!CMGT_Portal_CaseContact.portalCaseContactId,\n      ascending: true\n    )\n  ),\n  relatedRecordData: ri!relatedRecordData,\n  logicalExpressions: ri!additionalLogicalExpression,\n  groupByFields: ri!groupByFields,\n  searchTerm: ri!searchTerm,\n  searchFields: ri!searchFields\n)\n"
    },
    "68d25630-1cc6-4224-9b3d-3bacf8d35b31": {
      "name": "CMGT_SELF_API_POST_ClaimCase",
      "type": "Web API",
      "sail_code": "/* Returns any one of the below values for claimStatus\n  CASE_NOT_FOUND - When there is no matching case found for the given friendlyId and lastname for the initiator\n  CASE_ALREADY_CLAIMED - When the initiator has already claimed the case i.e. the initiator is a submitter\n  CASE_CLAIMED - When the case is claimed successfully\n  UNAUTHORIZED - When the initiator is not an External user\n  MISSING_REQUIRED_PARAMTERS - When required paramters are not passed\n  PROCESS_ERRORED - When the process errors to initiate\n*/\na!match(\n  value: http!request.queryParameters,\n  whenTrue: and(\n    rule!CMGT_UTIL_IsNotBlank(fv!value.friendlyId),\n    rule!CMGT_UTIL_IsNotBlank(fv!value.personLastName),\n    rule!CMGT_UTIL_IsNotBlank(fv!value.initiator),\n    isusernametaken(fv!value.initiator)\n  ),\n  then: a!localVariables(\n    local!caseAndContactInfo: rule!CMGT_SELF_GetCaseToClaim(\n      friendlyId: fv!value.friendlyId,\n      personLastName: fv!value.personLastName\n    ),\n    local!claimStatus:\n    rule!CMGT_SELF_ClaimStatusLogic(\n      caseAndContactInfo: local!caseAndContactInfo,\n      initiator: fv!value.initiator\n    ),\n    if(\n      local!claimStatus = \"CASE_CLAIMED\",\n      #\"SYSTEM_SYSRULES_startProcess\"(\n        processModel: cons!CMGT_SELF_PM_CLAIM_CASE,\n        processParameters: {\n          case: local!caseAndContactInfo[recordType!CMGT_Portal_CaseContact.case],\n          initiator: fv!value.initiator\n        },\n        onSuccess: #\"SYSTEM_SYSRULES_httpResponse_v1\"(\n          statusCode: 200,\n          headers: {\n            #\"SYSTEM_SYSRULES_httpHeader\"(\n              name: \"Content-Type\",\n              value: \"application/json\"\n            )\n          },\n          body: #\"SYSTEM_SYSRULES_toJson_v1\"(\n            a!map(\n              caseId: local!caseAndContactInfo[recordType!CMGT_Portal_CaseContact.case.caseId],\n              claimStatus: local!claimStatus\n            )\n          )\n        ),\n        onError: #\"SYSTEM_SYSRULES_httpResponse_v1\"(\n          statusCode: 500,\n          headers: {\n            #\"SYSTEM_SYSRULES_httpHeader\"(\n              name: \"Content-Type\",\n              value: \"application/json\"\n            )\n          },\n          body: #\"SYSTEM_SYSRULES_toJson_v1\"(\n            a!map(\n              caseId: null(),\n              claimStatus: \"PROCESS_ERRORED\"\n            )\n          )\n        )\n      ),\n      #\"SYSTEM_SYSRULES_httpResponse_v1\"(\n        statusCode: 200,\n        headers: {\n          #\"SYSTEM_SYSRULES_httpHeader\"(\n            name: \"Content-Type\",\n            value: \"application/json\"\n          )\n        },\n        body: #\"SYSTEM_SYSRULES_toJson_v1\"(\n          a!map(\n            caseId: null(),\n            claimStatus: local!claimStatus\n          )\n        )\n      )\n    )\n  ),\n  default: #\"SYSTEM_SYSRULES_httpResponse_v1\"(\n    statusCode: 400,\n    headers: {\n      #\"SYSTEM_SYSRULES_httpHeader\"(\n        name: \"Content-Type\",\n        value: \"application/json\"\n      )\n    },\n    body: #\"SYSTEM_SYSRULES_toJson_v1\"(\n      a!map(\n        caseId: null(),\n        claimStatus: \"MISSING_REQUIRED_PARAMETERS\"\n      )\n    )\n  )\n)"
    },
    "_a-0000ebf7-3bc0-8000-9cc4-011c48011c48_2391356": {
      "name": "CMGT_SELF_ClaimStatusLogic",
      "type": "Expression Rule",
      "sail_code": "a!match(\n  value: ri!caseAndContactInfo,\n  /* When there is no match for the friendlyId and lastName with the initiator*/\n  whenTrue: rule!CMGT_UTIL_IsBlank(fv!value),\n  then: \"CASE_NOT_FOUND\",\n  /* Already claimed                    */\n  whenTrue: rule!CMGT_UTIL_Filter(\n    records: fv!value[recordType!CMGT_Portal_CaseContact.case],\n    fieldValuePairs: {\n      a!map(\n        field: recordType!CMGT_Role.roleTypeId,\n        value: cons!CMGT_SELF_REFID_ROLE_TYPE_CLAIMANT\n      ),\n      a!map(\n        field: recordType!CMGT_Role.username,\n        value: ri!initiator\n      )\n    },\n    filterType: \"MATCH_COUNT\"\n  ) > 0,\n  then: \"CASE_ALREADY_CLAIMED\",\n  whenTrue: rule!CMGT_UTIL_Filter(\n    records: fv!value[recordType!CMGT_Portal_CaseContact.case],\n    fieldValuePairs: {\n      a!map(\n        field: recordType!CMGT_Role.roleTypeId,\n        value: cons!CMGT_SELF_REFID_ROLE_TYPE_CLAIMANT\n      )\n    },\n    filterType: \"MATCH_COUNT\"\n  ) > 0,\n  then: \"CASE_NOT_FOUND\",\n  default: \"CASE_CLAIMED\"\n)"
    },
    "_a-0000e990-c462-8000-9ba7-011c48011c48_25890": {
      "name": "CMGT_UTIL_IsBlank",
      "type": "Expression Rule",
      "sail_code": "length(a!flatten(ri!value)) = 0"
    },
    "af326a29-a1c8-4399-a28d-996f85819d9e": {
      "name": "CMGT_UTIL_Filter",
      "type": "Expression Rule",
      "sail_code": "with(\n  local!fieldValuePairs: a!defaultValue(\n    ri!fieldValuePairs,\n    apply(\n      rule!CMGT_UTIL_Filter_CreateFieldValuePair(\n        field: _,\n        value: ri!value,\n        allFields: a!flatten(ri!field)\n      ),\n      a!flatten(ri!field)\n    )\n  ),\n  local!matchingCriteria: a!defaultValue(\n    value: ri!matchingCriteria,\n    default: \"ALL\"\n  ),\n  local!matchType: a!defaultValue(value: ri!matchType, default: \"EXACT\"),\n  local!matchIndices: if(\n    a!isNullOrEmpty(a!flatten(ri!records)),\n    tointeger({}),\n    reduce(\n      rule!CMGT_UTIL_Filter_Reducer(\n        matchingCriteria: local!matchingCriteria,\n        previousIndices: _,\n        records: a!flatten(ri!records),\n        fieldValuePair: _,\n        matchType: local!matchType\n      ),\n      a!match(\n        value: local!matchingCriteria,\n        equals: \"ALL\",\n        then: enumerate(count(a!flatten(ri!records))) + 1,\n        equals: \"ANY\",\n        then: {},\n        default: fn!error(\n          \"Invalid matchingCriteria, must be one of: ALL, ANY\"\n        )\n      ),\n      local!fieldValuePairs\n    )\n  ),\n  local!rejectIndices: difference(\n    if(\n      a!isNullOrEmpty(ri!records),\n      tointeger({}),\n      enumerate(count(a!flatten(ri!records))) + 1\n    ),\n    local!matchIndices\n  ),\n  local!matches: cast(\n    runtimetypeof(ri!records),\n    index(ri!records, local!matchIndices, {})\n  ),\n  local!rejects: cast(\n    runtimetypeof(ri!records),\n    index(ri!records, local!rejectIndices, {})\n  ),\n  local!output: a!match(\n    value: a!defaultValue(ri!filterType, \"FILTER\"),\n    equals: \"FILTER\",\n    then: local!matches,\n    equals: \"REJECT\",\n    then: local!rejects,\n    equals: \"FIRST_MATCH\",\n    then: index(local!matches, 1, null),\n    equals: \"FIRST_REJECT\",\n    then: index(local!rejects, 1, null),\n    equals: \"MATCH_COUNT\",\n    then: count(local!matchIndices),\n    equals: \"REJECT_COUNT\",\n    then: count(local!rejectIndices),\n    equals: \"MATCH_INDICES\",\n    then: local!matchIndices,\n    equals: \"REJECT_INDICES\",\n    then: local!rejectIndices,\n    equals: \"FULL_RESULT\",\n    then: a!map(\n      matches: local!matches,\n      rejects: local!rejects,\n      firstMatch: index(local!matches, 1, null),\n      firstReject: index(local!rejects, 1, null),\n      matchCount: count(local!matchIndices),\n      rejectCount: count(local!rejectIndices),\n      matchIndices: local!matchIndices,\n      rejectIndices: local!rejectIndices\n    ),\n    default: fn!error(\n      \"Invalid filterType, must be one of: FILTER, REJECT, FIRST_MATCH, FIRST_REJECT, MATCH_COUNT, REJECT_COUNT, MATCH_INDICES, REJECT_INDICES, FULL_RESULT\"\n    )\n  ),\n  local!output\n)"
    },
    "_a-0000ebce-f0a8-8000-9cb7-011c48011c48_2213241": {
      "name": "CMGT_SELF_GetCaseToClaim",
      "type": "Expression Rule",
      "sail_code": "rule!CMGT_QR_GetPortalCaseContact(\n  returnType: \"SINGLE_OBJECT\",\n  additionalLogicalExpression: #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n    ignoreFiltersWithEmptyValues: true(),\n    operator: \"AND_ALL\",\n    filters: {\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!CMGT_Portal_CaseContact.lastName,\n        /* Case-insensitive filter       */\n        operator: \"in\",\n        value: { ri!personLastName }\n      ),\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!CMGT_Portal_CaseContact.case.friendlyId,\n        /* Case-insensitive filter       */\n        operator: \"in\",\n        value: { ri!friendlyId }\n      )\n    }\n  ),\n  fields: {\n    recordType!CMGT_Portal_CaseContact.case,\n    recordType!CMGT_Portal_CaseContact.case\n  }\n)"
    }
  }
}