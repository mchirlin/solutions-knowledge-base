{
  "uuid": "_a-0000ec44-cb49-8000-9be6-011c48011c48_77597",
  "name": "AIA_Extract_ExtractFieldsFromExtractedDataResponse",
  "type": "Expression Rule",
  "description": "Extract fields from extracted data response",
  "sail_code": "a!localVariables(\n  local!modelVersionFields: rule!AIA_Extraction_GetFieldsForModelVersionId(\n    modelVersionId: ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersionId]\n  ),\n  local!extractedFields: #\"SYSTEM_SYSRULES_forEach\"(\n    items: local!modelVersionFields,\n    expression: a!localVariables(\n      local!rows: if(\n        /* Table Type */\n        fv!item[recordType!AIA Extraction Model Version Field.type] = cons!AIA_EXTRACTION_FIELD_TYPE_TABLE,\n        /* ForEach of the returned results, create a row with the columns */\n        a!localVariables(\n          local!field: fv!item,\n          local!extractedRows: #\"SYSTEM_SYSRULES_forEach\"(\n            ri!ExtractedData[fv!item[recordType!AIA Extraction Model Version Field.key]],\n            recordType!AIA Extraction Instance Field Row(\n              recordType!AIA Extraction Instance Field Row.cells: a!localVariables(\n                local!row: fv!item,\n                #\"SYSTEM_SYSRULES_forEach\"(\n                  items: local!field[recordType!AIA Extraction Model Version Field.columns],\n                  expression: recordType!AIA Extraction Instance Field Row Cell(\n                    recordType!AIA Extraction Instance Field Row Cell.modelVersionFieldId: fv!item[recordType!AIA Extraction Model Version Field.fieldId],\n                    recordType!AIA Extraction Instance Field Row Cell.extractedValue: rule!AIA_TypeHelper(\n                      value: if(\n                        rule!AIA_IsObject(\n                          value: local!row[fv!item[recordType!AIA Extraction Model Version Field.key]],\n                        ),\n                        local!row[fv!item[recordType!AIA Extraction Model Version Field.key]].value,\n                        local!row[fv!item[recordType!AIA Extraction Model Version Field.key]]\n                      ),\n                      field: fv!item\n                    ),\n                    recordType!AIA Extraction Instance Field Row Cell.confidence: index(\n                      local!row[fv!item[recordType!AIA Extraction Model Version Field.key]],\n                      \"confidence\",\n                      null\n                    )\n                  )\n                )\n              )\n            )\n          ),\n          local!reconciledRows: #\"SYSTEM_SYSRULES_forEach\"(\n            ri!ReconciledData[fv!item[recordType!AIA Extraction Model Version Field.key]],\n            recordType!AIA Extraction Instance Field Row(\n              recordType!AIA Extraction Instance Field Row.cells: a!localVariables(\n                local!row: fv!item,\n                #\"SYSTEM_SYSRULES_forEach\"(\n                  items: local!field[recordType!AIA Extraction Model Version Field.columns],\n                  expression: recordType!AIA Extraction Instance Field Row Cell(\n                    recordType!AIA Extraction Instance Field Row Cell.modelVersionFieldId: fv!item[recordType!AIA Extraction Model Version Field.fieldId],\n                    recordType!AIA Extraction Instance Field Row Cell.overrideValue: rule!AIA_TypeHelper(\n                      value: local!row[fv!item[recordType!AIA Extraction Model Version Field.key]],\n                      field: fv!item\n                    )\n                  )\n                )\n              )\n            )\n          ),\n          if(\n            a!isNullOrEmpty(local!reconciledRows),\n            local!extractedRows,\n            a!flatten({\n              #\"SYSTEM_SYSRULES_forEach\"(\n                items: local!extractedRows,\n                expression: a!localVariables(\n                  local!extractedRow: fv!item,\n                  local!reconciledRow: index(local!reconciledRows, fv!index, null),\n                  if(\n                    a!isNullOrEmpty(local!reconciledRow),\n                    #\"urn:appian:function:v1:a:update\"(\n                      local!extractedRow,\n                      recordType!AIA Extraction Instance Field Row.overrideValue,\n                      cons!AIA_ROW_REMOVED\n                    ),\n                    a!localVariables(\n                      local!cells: #\"SYSTEM_SYSRULES_forEach\"(\n                        items: local!extractedRow[recordType!AIA Extraction Instance Field Row.cells],\n                        expression: a!localVariables(\n                          local!extractedCell: fv!item,\n                          local!reconciledCell: local!reconciledRow[recordType!AIA Extraction Instance Field Row.cells][fv!index],\n                          if(\n                            local!extractedCell[recordType!AIA Extraction Instance Field Row Cell.extractedValue] = local!reconciledCell[recordType!AIA Extraction Instance Field Row Cell.overrideValue],\n                            local!extractedCell,\n                            if(\n                              and(\n                                a!isNotNullOrEmpty(local!extractedCell[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                                a!isNullOrEmpty(local!reconciledCell[recordType!AIA Extraction Instance Field Row Cell.overrideValue])\n                              ),\n                              #\"urn:appian:function:v1:a:update\"(local!extractedCell, recordType!AIA Extraction Instance Field Row Cell.overrideNull, true),\n                              if(\n                                and(\n                                  a!isNotNullOrEmpty(local!extractedCell[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                                  a!isNotNullOrEmpty(local!reconciledCell[recordType!AIA Extraction Instance Field Row Cell.overrideValue])\n                                ),\n                                #\"urn:appian:function:v1:a:update\"(local!extractedCell, recordType!AIA Extraction Instance Field Row Cell.overrideValue, local!reconciledCell[recordType!AIA Extraction Instance Field Row Cell.overrideValue]),\n                                local!extractedCell\n                              )\n                            )\n                          )\n                        )\n                      ),\n                      #\"urn:appian:function:v1:a:update\"(\n                        #\"urn:appian:function:v1:a:update\"(\n                          local!extractedRow,\n                          recordType!AIA Extraction Instance Field Row.cells,\n                          local!cells\n                        ),\n                        recordType!AIA Extraction Instance Field Row.overrideValue,\n                        if(\n                          a!isNotNullOrEmpty(\n                            reject(\n                              fn!isnull,\n                              a!flatten({\n                                local!cells[recordType!AIA Extraction Instance Field Row Cell.overrideNull],\n                                local!cells[recordType!AIA Extraction Instance Field Row Cell.overrideValue]\n                              })\n                            )\n                          ),\n                          cons!AIA_ROW_OVERRIDDEN,\n                          null\n                      )\n                      )\n                    )\n                  )\n                )\n              ),\n              if(\n                length(local!reconciledRows) > length(local!extractedRows),\n                #\"SYSTEM_SYSRULES_forEach\"(\n                  items: ldrop(local!reconciledRows, length(local!extractedRows)),\n                  expression: #\"urn:appian:function:v1:a:update\"(\n                    fv!item,\n                    recordType!AIA Extraction Instance Field Row.overrideValue,\n                    cons!AIA_ROW_ADDED\n                  )\n                ),\n                {}\n              )\n            })\n          )\n        ),\n        null\n      ),\n      recordType!AIA Extraction Instance Field(\n        recordType!AIA Extraction Instance Field.modelVersionFieldId: fv!item[recordType!AIA Extraction Model Version Field.fieldId],\n        recordType!AIA Extraction Instance Field.extractedValue: a!match(\n          value: fv!item[recordType!AIA Extraction Model Version Field.extractionType],\n          equals: cons!AIA_EXTRACTION_TYPES[2],\n          then: if(\n            /* Table Type */\n            fv!item[recordType!AIA Extraction Model Version Field.type] = cons!AIA_EXTRACTION_FIELD_TYPES[7],\n            null,\n            rule!AIA_TypeHelper(\n              value: if(\n                rule!AIA_IsObject(\n                  value: ri!ExtractedData[fv!item[recordType!AIA Extraction Model Version Field.key]],\n                ),\n                ri!ExtractedData[fv!item[recordType!AIA Extraction Model Version Field.key]].value,\n                ri!ExtractedData[fv!item[recordType!AIA Extraction Model Version Field.key]],\n              ),\n              field: fv!item\n            )\n          ),\n          equals: cons!AIA_EXTRACTION_TYPES[3],\n          then: a!localVariables(\n            local!extractionRule: a!refreshVariable(\n              value: getrulereferencebyname(fv!item[recordType!AIA Extraction Model Version Field.extractionRule]),\n              refreshAlways: false\n            ),\n            local!extractionRule(input: a!map(\n              documentId: ri!ExtractionInstance[recordType!AIA Extraction Instance.documentId]\n            ))\n          ),\n          default: null\n        ),\n        recordType!AIA Extraction Instance Field.overrideValue: if(\n          a!isNullOrEmpty(ri!ReconciledData),\n          null,\n          if(\n            fv!item[recordType!AIA Extraction Model Version Field.type] = cons!AIA_EXTRACTION_FIELD_TYPE_TABLE,\n            if(\n              a!isNotNullOrEmpty(\n                reject(\n                  fn!isnull,\n                  local!rows[recordType!AIA Extraction Instance Field Row.overrideValue]\n                )\n              ),\n              cons!AIA_TABLE_UPDATED,\n              null\n            ),\n            if(\n              index(ri!ReconciledData, fv!item[recordType!AIA Extraction Model Version Field.key], null) = index(ri!ExtractedData, fv!item[recordType!AIA Extraction Model Version Field.key], null),\n              null,\n              if(\n                a!isNullOrEmpty(index(ri!ReconciledData, fv!item[recordType!AIA Extraction Model Version Field.key], null)),\n                null,\n                rule!AIA_TypeHelper(\n                  value: ri!ReconciledData[fv!item[recordType!AIA Extraction Model Version Field.key]],\n                  field: fv!item\n                )\n              )\n            )\n          )\n        ),\n        recordType!AIA Extraction Instance Field.overrideNull: if(\n          or(\n            a!isNullOrEmpty(ri!ReconciledData),\n            fv!item[recordType!AIA Extraction Model Version Field.type] = cons!AIA_EXTRACTION_FIELD_TYPE_TABLE\n          ),\n          null,\n          if(\n            index(ri!ReconciledData, fv!item[recordType!AIA Extraction Model Version Field.key], null) = index(ri!ExtractedData, fv!item[recordType!AIA Extraction Model Version Field.key], null),\n            null,\n            if(\n              a!isNullOrEmpty(index(ri!ReconciledData, fv!item[recordType!AIA Extraction Model Version Field.key], null)),\n              true,\n              null\n            )\n          )\n        ),\n        recordType!AIA Extraction Instance Field.confidence: a!defaultValue(\n          index(ri!ExtractedData[fv!item[recordType!AIA Extraction Model Version Field.key]], \"confidence\", null),\n          index(\n            ri!ConfidenceScores,\n            fv!item[recordType!AIA Extraction Model Version Field.key],\n            null\n          )\n        ),\n        recordType!AIA Extraction Instance Field.rows: local!rows\n      )\n    )\n  ),\n  local!extractedKeys: a!keys(ri!ExtractedData),\n  local!modelKeys: local!modelVersionFields[recordType!AIA Extraction Model Version Field.key],\n  local!additionalKeys: difference(local!extractedKeys, local!modelKeys),\n  local!missingKeys: difference(local!modelKeys, local!extractedKeys),\n  a!map(\n    extractedFields: local!extractedFields,\n    extraFields: local!additionalKeys,\n    missingFields: local!missingKeys,\n  )\n)",
  "calls": [
    {
      "name": "AIA_Extraction_GetFieldsForModelVersionId",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "AIA_TypeHelper",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "AIA_IsObject",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "AIA_EXTRACTION_FIELD_TYPE_TABLE",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "AIA_ROW_REMOVED",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "AIA_ROW_OVERRIDDEN",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "AIA_ROW_ADDED",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "AIA_EXTRACTION_TYPES",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "AIA_EXTRACTION_FIELD_TYPES",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "AIA_TABLE_UPDATED",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    }
  ],
  "called_by": []
}