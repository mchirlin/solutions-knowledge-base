{
  "_metadata": {
    "bundle_id": "AIA_Extraction_Execute_Prompt_Wrapper"
  },
  "objects": {
    "_a-0000ee5d-151c-8000-9ba8-011c48011c48_33090": {
      "name": "AIA_PROMPT_SECTION_DIVIDER",
      "type": "Expression Rule",
      "sail_code": "char(\n  10\n) & char(\n  10\n) & \"------------\" & char(\n  10\n) & char(\n  10\n)"
    },
    "_a-0000ed5d-bd1b-8000-9c80-011c48011c48_329747": {
      "name": "AIA_Extraction_GeneratePromptEntities",
      "type": "Expression Rule",
      "sail_code": "\"## Output Format\n\nYour final output must be a single **JSON object** representing the extracted data, with each field enriched to include its location. The schema for the response is as follows:\n\n\" &\n/*\"```json\" &*/\n\"\n\" & rule!AIA_Extraction_CreateJsonSchema(\n  fields: ri!fields,\n  mode: ri!mode,\n  returnJson: true\n) & \"\n\"&\n/*\"```\"&*/\n\"\""
    },
    "_a-0001eccb-4552-8000-9c3e-011c48011c48_159628": {
      "name": "AIA_Extraction_GetBoundingBoxByIdAndIndex",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n  recordType: recordType!AIA Extraction Bounding Boxes,\n  fields: {recordType!AIA Extraction Bounding Boxes.id},\n  filters: #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n    ignoreFiltersWithEmptyValues: true,\n    operator: \"AND\",\n    filters: {\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!AIA Extraction Bounding Boxes.batch,\n        operator: \">=\",\n        value: ri!batchId\n      ),\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!AIA Extraction Bounding Boxes.sectionId,\n        operator: \"=\",\n        value: ri!sectionId\n      ),\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!AIA Extraction Bounding Boxes.extractionId,\n        operator: \"=\",\n        value: ri!extractionId\n      )\n    }\n  ),\n  pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n    startIndex: 1,\n    batchSize: 0\n  ),\n  fetchTotalCount: true\n)"
    },
    "0002ecca-130a-8000-0477-7f0000014e7a": {
      "name": "AIA Extraction Execute Prompt Wrapper",
      "type": "Process Model",
      "sail_code": "// Output: ?\n=pv!batch + 1\n\n// Output: ?\nrule!AIA_Extraction_GetDataSubset(\n  promptType: pv!promptType,\n  ExtractionInstance: pv!ExtractionInstance,\n  SectionInstance: pv!SectionInstance,\n  batchId: pv!batch\n)\n\n// Output: ?\nif(\n  rule!AIA_Extraction_ShouldRunAdvancedIdp(\n    ExtractionInstance: pv!ExtractionInstance\n  ),\n  cons!AIA_PROMPT_DYNAMIC,\n  cons!AIA_PROMPT_STATIC\n)\n\n// Output: ?\nreject(\n  fn!isnull,\n  #\"SYSTEM_SYSRULES_forEach\"(\n    pv!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion],\n    if(\n      or(\n        a!isNullOrEmpty(pv!SectionInstance),\n        a!isNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Field.sectionId]),\n        fv!item[recordType!AIA Extraction Model Version Field.sectionId] = pv!SectionInstance[recordType!AIA Extraction Instance Section.sectionId]\n      ),\n      null,\n      fv!item[recordType!AIA Extraction Model Version Field.key]\n    )\n  )\n)\n\n// Output: ?\npv!responseJson\n\n// Input: ?\nrule!AIA_JoinJsonInput(\n  responseJsons: pv!responseJsons\n)\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.id]\n\n// Input: ?\ncons!AIA_MODEL_TYPE_VALUES[1]\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.llm]\n\n// Input: ?\n=#\"urn:appian:translation-string:v1:ba31e932-c9cd-4d01-86cd-b9d19886b7c1\" & \" - \" & pv!ExtractionInstance[recordType!AIA Extraction Instance.id]\n\n// Input: ?\nrule!AIA_JoinJsonPrompt(\n  originalPrompt: rule!AIA_Extraction_GeneratePrompt(\n    ExtractionInstance: pv!ExtractionInstance,\n    modelVersion: pv!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion],\n    sectionInstance: pv!SectionInstance,\n    batch: pv!batch,\n    hasBoundingBoxes: pv!ExtractionInstance[recordType!AIA Extraction Instance.hasBoundingBoxes],\n  )\n)\n\n// Output: ?\nac!ProcessInfo.pv.responseJson\n\n// Output: ?\nrule!AIA_Extraction_AddTokens(ExtractionInstance: pv!ExtractionInstance, inputTokens: ac!ProcessInfo.pv.inputTokens, outputTokens: ac!ProcessInfo.pv.outputTokens)\n\n// Input: ?\nrule!AIA_ExtractionInput(\n  ExtractionInstance: pv!ExtractionInstance,\n  SectionInstance: pv!SectionInstance,\n  batch: pv!batch\n)\n\n// Input: ?\nrule!AIA_DecideSkillToRun(\n  Instance: pv!ExtractionInstance\n)\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.id]\n\n// Input: ?\ncons!AIA_MODEL_TYPE_VALUES[1]\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.llm]\n\n// Input: ?\ncons!AIA_PROMPT_OPERATION_MODE_TEXT\n\n// Input: ?\n=#\"urn:appian:translation-string:v1:ae9a7ca9-3e53-46ea-ade4-94c52c690440\"\n\n// Input: ?\nrule!AIA_Extraction_GeneratePrompt(\n  ExtractionInstance: pv!ExtractionInstance,\n  modelVersion: pv!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion],\n  sectionInstance: pv!SectionInstance,\n  batch: pv!batch,\n  hasBoundingBoxes: pv!ExtractionInstance[recordType!AIA Extraction Instance.hasBoundingBoxes],\n)\n\n// Output: ?\nrule!AIA_Extraction_AddTokens(ExtractionInstance: pv!ExtractionInstance, inputTokens: ac!ProcessInfo.pv.inputTokens, outputTokens: ac!ProcessInfo.pv.outputTokens)\n\n// Output: ?\nrule!AIA_Extraction_RemoveNonSectionFields(\n  responseJson: ac!ProcessInfo.pv.responseJson,\n  keysToRemove: pv!keysToRemove\n)"
    },
    "_a-0000ee86-b6b0-8000-9ba7-011c48011c48_47348": {
      "name": "AIA_Classification_ShouldRunText",
      "type": "Expression Rule",
      "sail_code": "or(\n  and(\n    a!isNullOrEmpty(ri!document),\n    a!isNotNullOrEmpty(ri!ClassificationInstance[recordType!AIA Classification Instance.inputText])\n  ),\n  rule!AIA_IsDocumentExtension(\n    document: ri!document,\n    extensions: cons!AIA_TEXT_BASED_EXTENSIONS\n  ) \n)"
    },
    "_a-0000ee5d-151c-8000-9ba8-011c48011c48_31384": {
      "name": "AIA_FieldJsonSchema",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!isMultiple: a!defaultValue(\n    ri!item.isMultiple,\n    false\n  ),\n  local!baseType: #\"53aa98e0-80da-4eb1-88f9-a989a8fe1aee\"(\n    type: ri!item.type\n  ),\n  local!baseField: a!map(\n    title: ri!item.label,\n    description: ri!item.description,\n    type: local!baseType.type,\n    format: local!baseType.format\n  ),\n  local!schemaType: displayValue(\n    ri!mode,\n    rule!AIA_ENUM_FieldSchemas().name,\n    rule!AIA_ENUM_FieldSchemas(),\n    null\n  ),\n  local!type: #\"53aa98e0-80da-4eb1-88f9-a989a8fe1aee\"(\n    type: ri!item.type,\n    isMultiple: local!isMultiple,\n    includeArrays: ri!includeArrays,\n    mode: ri!mode\n  ),\n  local!enum: rule!AIA_Extraction_GetFieldOptions(ModelVersionField: ri!item),\n  local!columns: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!item.columns,\n      a!match(\n        value: fv!item,\n        whenTrue: a!isNullOrEmpty(index(fv!value, \"key\", null)),\n        then: null,\n        whenTrue: and(\n          ri!operation = cons!AIA_PROMPT_OPERATION_MODE_MULTIMODAL,\n          a!defaultValue(fv!value.useVision, false) = true\n        ),\n        then: fv!item,\n        whenTrue: and(\n          ri!operation = cons!AIA_PROMPT_OPERATION_MODE_TEXT,\n          a!defaultValue(fv!value.useVision, false) = false\n        ),\n        then: fv!item,\n        default: fv!item\n      )\n    )\n  ),\n  local!properties: if(\n    and(\n      a!isNotNullOrEmpty(local!schemaType.fields),\n      or(\n        and(\n          not(local!isMultiple),\n          a!isNullOrEmpty(local!columns),\n        ),\n        not(a!defaultValue(ri!includeArrays, true))\n      )\n    ),\n    reduce(\n      #\"urn:appian:function:v1:a:update\",\n      a!map(),\n      merge(\n        local!schemaType.fields.key,\n        a!flatten({\n          #\"SYSTEM_SYSRULES_forEach\"(\n            local!schemaType.fields,\n            a!map(\n              type: a!defaultValue(fv!item.type, local!baseField.type),\n              description: fv!item.description,\n              format: if(\n                fv!item.useFormat,\n                local!baseField.format,\n                null\n              ),\n              items: if(\n                and(\n                  a!isNullOrEmpty(fv!item.type),\n                  ri!includeArrays = false\n                ),\n                rule!AIA_FieldJsonSchema(\n                  item: ri!item,\n                  mode: cons!AIA_SCHEMA_MODE_PLAIN,\n                  operation: ri!operation,\n                  includeArrays: true\n                ).items,\n                null\n              ),\n              enum: if(\n                fv!item.useFormat,\n                index(local!enum, \"options\", null),\n                null\n              ),\n            )\n          )\n        })\n      )\n    ),\n    null\n  ),\n  local!required: if(\n    and(\n      a!isNotNullOrEmpty(local!schemaType.fields),\n      a!isNullOrEmpty(local!columns),\n      not(local!isMultiple)\n    ),\n    reject(\n      fn!isnull,\n      index(\n        local!schemaType.fields.key,\n        where(local!schemaType.fields.required)\n      )\n    ),\n    null\n  ),\n  local!items: a!match(\n    value: ri!includeArrays,\n    equals: false,\n    then: null,\n    whenTrue: and(\n      a!isNotNullOrEmpty(local!columns),\n      ri!includeArrays\n    ),\n    then: a!map(\n      type: \"object\",\n      properties: reduce(\n        #\"urn:appian:function:v1:a:update\",\n        a!map(),\n        merge(\n          local!columns.key,\n          #\"SYSTEM_SYSRULES_forEach\"(\n            local!columns,\n            rule!AIA_FieldJsonSchema(\n              item: fv!item,\n              mode: ri!mode\n            )\n          )\n        )\n      ),\n      required: reject(\n        fn!isnull,\n        index(\n          local!columns.key,\n          where(local!columns.required)\n        )\n      )\n    ),\n    whenTrue: local!isMultiple,\n    then: a!localVariables(\n      local!item: rule!AIA_FieldJsonSchema(\n        item: #\"urn:appian:function:v1:a:update\"(\n          ri!item, \n          {\"label\", \"description\", \"isMultiple\"},\n          {null, null, false}\n        ),\n        mode: ri!mode\n      ),\n      if(\n        and(\n          a!isNullOrEmpty(local!schemaType.fields),\n          a!isNotNullOrEmpty(local!enum)\n        ),\n        #\"urn:appian:function:v1:a:update\"(\n          local!item,\n          \"enum\",\n          index(local!enum, \"options\", null),\n        ),\n        local!item\n      )\n    ),\n    default: null\n  ),\n  a!map(\n    title: local!baseField.title,\n    description: local!baseField.description,\n    type: local!type.type,\n    format: local!type.format,\n    properties: local!properties,\n    items: local!items,\n    required: local!required\n  )\n)"
    },
    "_a-0000ed96-b933-8000-9c8f-011c48011c48_921741": {
      "name": "AIA_DecideSkillToRun",
      "type": "Expression Rule",
      "sail_code": "if(\n  runtimetypeof(ri!Instance) = typeof(recordType!AIA Extraction Instance()),\n  a!match(\n    value: ri!Instance,\n    whenTrue: rule!AIA_Extraction_ShouldRunText(ExtractionInstance: ri!Instance),\n    then: cons!AIA_INPUT_TYPE_TEXT,\n    default: cons!AIA_INPUT_TYPE_DOC\n  ),\n  if(\n    runtimetypeof(ri!Instance) = typeof(recordType!AIA Classification Instance()),\n    a!match(\n      value: ri!Instance,\n      whenTrue: rule!AIA_Classification_ShouldRunText(\n        ClassificationInstance: ri!Instance,\n        document: a!defaultValue(ri!document, ri!Instance[recordType!AIA Classification Instance.documentId])\n      ),\n      then: cons!AIA_INPUT_TYPE_TEXT,\n      default: cons!AIA_INPUT_TYPE_DOC\n    ),\n    null\n  )\n)"
    },
    "_a-0000ec2d-5396-8000-9bdc-011c48011c48_43077": {
      "name": "AIA_Extraction_GetInstanceById",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_queryRecordByIdentifier\"(\n  recordType: recordType!AIA Extraction Instance,\n  identifier: ri!identifier,\n  fields: a!flatten(\n    {\n      /* Extraction Instance */\n      recordType!AIA Extraction Instance.modelVersionId,\n      recordType!AIA Extraction Instance.documentId,\n      recordType!AIA Extraction Instance.statusId,\n      recordType!AIA Extraction Instance.hasBoundingBoxes,\n      recordType!AIA Extraction Instance.boundingBoxesDocumentId,\n      recordType!AIA Extraction Instance.validationErrors,\n      recordType!AIA Extraction Instance.accuracy,\n      recordType!AIA Extraction Instance.precision,\n      recordType!AIA Extraction Instance.f1,\n      recordType!AIA Extraction Instance.recall,\n      recordType!AIA Extraction Instance.createdOn,\n      /* Extraction Fields */\n      recordType!AIA Extraction Instance.fields.modelVersionFieldId,\n      recordType!AIA Extraction Instance.fields.extractedValue,\n      recordType!AIA Extraction Instance.fields.overrideValue,\n      recordType!AIA Extraction Instance.fields.overrideNull,\n      recordType!AIA Extraction Instance.fields.boundingBox,\n      recordType!AIA Extraction Instance.fields.confidence,\n      /* Extraction Fields > Rows */\n      recordType!AIA Extraction Instance.fields.rows.overrideValue,\n      recordType!AIA Extraction Instance.fields.rows.boundingBox,\n      /* Extraction Fields > Rows > Cells */\n      recordType!AIA Extraction Instance.fields.rows.cells.modelVersionFieldId,\n      recordType!AIA Extraction Instance.fields.rows.cells.extractedValue,\n      recordType!AIA Extraction Instance.fields.rows.cells.overrideValue,\n      recordType!AIA Extraction Instance.fields.rows.cells.overrideNull,\n      recordType!AIA Extraction Instance.fields.rows.cells.confidence,\n      /* Extraction Fields > Model Field */\n      recordType!AIA Extraction Instance.fields.modelVersionField.key,\n      recordType!AIA Extraction Instance.fields.modelVersionField.columns.key,\n      /* Extraction Fields > Rows > Cells > Column */\n      recordType!AIA Extraction Instance.fields.rows.cells.column.key,\n      a!defaultValue(ri!additionalFields, {})\n    },\n    \n  )\n)"
    },
    "_a-0000ec36-59aa-8000-9be0-011c48011c48_53600": {
      "name": "AIA_Test_GetLatestExtractionModelVersion",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!modelVersion: a!refreshVariable(\n    value: rule!AIA_Extraction_GetModelVersionById(\n      identifier: index(\n        #\"SYSTEM_SYSRULES_queryRecordType_v4\"(\n          recordType: recordType!AIA Extraction Model Version,\n          fields: {\n            recordType!AIA Extraction Model Version.modelVersionId\n          },\n          pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n            startIndex: 1,\n            batchSize: 1,\n            sort: {\n              #\"SYSTEM_SYSRULES_sortInfo\"(\n                field: recordType!AIA Extraction Model Version.modelVersionId\n              )\n            }\n          )\n        ).data[recordType!AIA Extraction Model Version.modelVersionId],\n        1,\n        null\n      )\n    ),\n    refreshAlways: true\n  ),\n  local!modelVersion\n)"
    },
    "_a-0000ed96-b933-8000-9c8f-011c48011c48_921761": {
      "name": "AIA_Extraction_GetSectionsByBatch",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n  recordType: recordType!AIA Extraction Instance Section,\n  filters: #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n    ignoreFiltersWithEmptyValues: true,\n    operator: \"AND\",\n    filters: {\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!AIA Extraction Instance Section.batchId,\n        operator: \">=\",\n        value: ri!batchId\n      ),\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!AIA Extraction Instance Section.sectionId,\n        operator: \"=\",\n        value: ri!sectionId,\n        applyWhen: a!isNotNullOrEmpty(ri!sectionId)\n      ),\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!AIA Extraction Instance Section.instanceId,\n        operator: \"=\",\n        value: ri!extractionId\n      )\n    }\n  ),\n  pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n    startIndex: 1,\n    batchSize: 1,\n    sort: #\"SYSTEM_SYSRULES_sortInfo\"(\n      field: recordType!AIA Extraction Instance Section.startPage,\n      ascending: true\n    )\n  ),\n  fetchTotalCount: true\n)"
    },
    "_a-0000ecea-6c5f-8000-9c4b-011c48011c48_193367": {
      "name": "AIA_Extraction_GeneratePromptExamples",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!examples: rule!AIA_GetModelVersionExamples(\n    modelVersion: ri!modelVersion,\n    fields: ri!fields\n  ),\n  if(\n    /*even if there are no bounding boxes, still include the examples*/\n    a!isNullOrEmpty(local!examples),\n    \"\",\n    \"\n\nHere are some examples:\n\" & joinarray(\n      #\"SYSTEM_SYSRULES_forEach\"(\n        local!examples,\n        \"\n  <example>\n    <input>\" & fv!item[recordType!AIA Model Version Example.input] & \"</input>\n    <output>\" & fv!item[recordType!AIA Model Version Example.output] & \"</output>\n  </example>\"\n      ),\n      \"\n\"\n    )\n  )\n)"
    },
    "_a-0000eea3-15ee-8000-9bd4-011c48011c48_134521": {
      "name": "AIA_ExtractionInput",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!document: a!match(\n    value: ri!ExtractionInstance[recordType!AIA Extraction Instance.documentId],\n    whenTrue: rule!AIA_IsDocumentExtension(\n      document: fv!value,\n      extensions: cons!AIA_TEXT_BASED_EXTENSIONS\n    ),\n    then: todocument(ri!ExtractionInstance[recordType!AIA Extraction Instance.documentId]),\n    \n    /*if bounding boxes exist, instance went through advanced processing*/\n    /*if there is only a single bounding box, then no batches and only this doc will be used*/\n    whenTrue: and(\n      a!isNotNullOrEmpty(ri!ExtractionInstance[recordType!AIA Extraction Instance.boundingBoxes]),\n      length(ri!ExtractionInstance[recordType!AIA Extraction Instance.boundingBoxes]) = 1\n    ),\n    /*directly reference to avoid excess query*/\n    then: ri!ExtractionInstance[recordType!AIA Extraction Instance.boundingBoxes.inputDocumentId][1],\n    \n    /*if instance has bounding boxes or model uses advanced layout, then use textract generated input document*/\n    whenTrue: or(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.hasBoundingBoxes],\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.extractionModel.useAdvancedLayout]\n    ),\n    /*query for input doc in bounding boxes table by current batch number*/\n    then: index(\n      index(\n        #\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n          recordType: recordType!AIA Extraction Bounding Boxes,\n          filters: #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n            operator: \"AND\",\n            filters: {\n              if(\n                a!isNotNullOrEmpty(ri!SectionInstance),\n                #\"SYSTEM_SYSRULES_queryFilter\"(\n                  field: recordType!AIA Extraction Bounding Boxes.sectionId,\n                  operator: \"=\",\n                  value: ri!SectionInstance[recordType!AIA Extraction Instance Section.id]\n                ),\n                #\"SYSTEM_SYSRULES_queryFilter\"(\n                  field: recordType!AIA Extraction Bounding Boxes.extractionId,\n                  operator: \"=\",\n                  value: ri!ExtractionInstance[recordType!AIA Extraction Instance.id]\n                )\n              ),\n              #\"SYSTEM_SYSRULES_queryFilter\"(\n                field: recordType!AIA Extraction Bounding Boxes.batch,\n                operator: \"=\",\n                value: ri!batch\n              )\n            },\n            ignoreFiltersWithEmptyValues: true\n          ),\n          pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n            1,\n            1\n          )\n        ).data,\n        1,\n        null\n      ),\n      recordType!AIA Extraction Bounding Boxes.inputDocumentId,\n      null\n    ),\n    \n    /*for non-advanced process, first default to section check by batch number*/\n    /*in case sections or doc length lead to splitting*/\n    default: a!defaultValue(\n      #\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n        recordType: recordType!AIA Extraction Instance Section,\n        filters: {\n          #\"SYSTEM_SYSRULES_queryFilter\"(\n            field: recordType!AIA Extraction Instance Section.instanceId,\n            operator: \"=\",\n            value: ri!ExtractionInstance[recordType!AIA Extraction Instance.id]\n          ),\n          #\"SYSTEM_SYSRULES_queryFilter\"(\n            field: recordType!AIA Extraction Instance Section.sectionId,\n            operator: \"=\",\n            value: ri!SectionInstance[recordType!AIA Extraction Instance Section.sectionId],\n            applyWhen: a!isNotNullOrEmpty(ri!SectionInstance[recordType!AIA Extraction Instance Section.sectionId])\n          )\n        },\n        pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n          startIndex: ri!batch,\n          batchSize: 1,\n          sort: #\"SYSTEM_SYSRULES_sortInfo\"(\n            field: recordType!AIA Extraction Instance Section.startPage,\n            ascending: true\n          )\n        )\n      ).data[recordType!AIA Extraction Instance Section.documentId],\n      /*if not advanced idp (bounding boxes record) and nothing in section,*/\n      /*use original input docuemnt and no splitting or processing was done*/\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.documentId]\n    )\n  ),\n  if(\n    rule!AIA_Extraction_ShouldRunText(ExtractionInstance: ri!ExtractionInstance),\n    /*when passing to text based AI, do not want to pass full text string into process*/\n    /*create parameter map with pattern replacement defined with document id*/\n    /*will be replaced with contents of document in AIA_ProcessInputMap*/\n    a!map(\n      input: a!defaultValue(\n        ri!ExtractionInstance[recordType!AIA Extraction Instance.inputText],\n        \"###documentContent###\"\n      ),\n      parameters: if(\n        a!isNullOrEmpty(ri!ExtractionInstance[recordType!AIA Extraction Instance.documentId]),\n        null,\n        {\n          a!map(\n            pattern: \"###documentContent###\",\n            replacement: if(\n              a!isNotNullOrEmpty(local!document),\n              todocument(local!document),\n              null\n            )\n          )\n        }\n      )\n    ),\n    a!map(\n      document: local!document\n    )\n  )\n)"
    },
    "_a-0000ee5d-151c-8000-9ba8-011c48011c48_36163": {
      "name": "SHRD_UTIL_QueryRecord",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!maxBatchSize: 5000,\n  /*Chosen return type*/\n  local!returnType: a!defaultValue(ri!returnType, \"OBJECT_ARRAY\"),\n  /*Determine the query parameters to use by the return type*/\n  local!queryParams: a!match(\n    value: local!returnType,\n    equals: \"OBJECT_ARRAY\",\n    then: a!map(\n      castToType: if(\n        a!isNullOrEmpty(ri!groupByFields),\n        #\"urn:appian:function:v1:a:listtype?okey=a!listType\"(ri!recordType),\n        'type!{http://www.appian.com/ae/types/2009}Map?list'\n      ),\n      fetchTotalCount: false,\n      isArray: true,\n      queryRecordByIdentifier: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: 1,\n        batchSize: a!defaultValue(\n          ri!pagingInfo.batchSize,\n          local!maxBatchSize\n        ),\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"SINGLE_OBJECT\",\n    then: a!map(\n      castToType: if(\n        a!isNullOrEmpty(ri!groupByFields),\n        ri!recordType,\n        'type!{http://www.appian.com/ae/types/2009}Map'\n      ),\n      fetchTotalCount: false,\n      isArray: false,\n      queryRecordByIdentifier: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: 1,\n        batchSize: 1,\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"RECORD_BY_ID\",\n    then: a!map(\n      castToType: ri!recordType,\n      fetchTotalCount: false,\n      isArray: false,\n      queryRecordByIdentifier: true,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: 1,\n        batchSize: 1,\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"DATA_SUBSET\",\n    then: a!map(\n      castToType: 'type!{http://www.appian.com/ae/types/2009}DataSubset',\n      fetchTotalCount: true,\n      isArray: false,\n      queryRecordByIdentifier: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: a!defaultValue(ri!pagingInfo.startIndex, 1),\n        batchSize: a!defaultValue(\n          ri!pagingInfo.batchSize,\n          local!maxBatchSize\n        ),\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"TOTAL_COUNT\",\n    then: a!map(\n      castToType: 'type!{http://www.appian.com/ae/types/2009}Integer',\n      fetchTotalCount: true,\n      isArray: false,\n      queryRecordByIdentifier: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(startIndex: 1, batchSize: 0)\n    ),\n    default: fn!error(\n      \"Invalid returnType, must be one of: OBJECT_ARRAY, SINGLE_OBJECT, RECORD_BY_ID, DATA_SUBSET, TOTAL_COUNT\"\n    )\n  ),\n  if(\n    /*Early exit for skip execution*/\n    ri!executeWhen = false,\n    cast(\n      local!queryParams.castToType,\n      if(local!queryParams.isArray, {}, null)\n    ),\n    a!localVariables(\n      /*Run the query*/\n      local!queryResult: a!refreshVariable(\n        value: if(\n          local!queryParams.queryRecordByIdentifier,\n          #\"SYSTEM_SYSRULES_queryRecordByIdentifier\"(\n            recordType: ri!recordType,\n            identifier: index({ri!identifier},1,null),\n            /*If fields is sent in using a!selectionFields(), then adding the fields contained in ri!relatedRecordData will break the query*/\n            fields: reject(\n              a!isNullOrEmpty,\n              a!flatten(\n                {\n                  ri!fields,\n                  if(\n                    or(\n                      typeof(ri!fields) = typeof(#\"SYSTEM_SYSRULES_selectionFields\"()),\n                      typeof(ri!fields) = typeof({#\"SYSTEM_SYSRULES_selectionFields\"()})\n                    ),\n                    {},\n                    index(ri!relatedRecordData, \"relationship\", {})\n                  )\n                }\n              )\n            ),\n            relatedRecordData: ri!relatedRecordData\n          ),\n          #\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n            recordType: ri!recordType,\n            fields: if(\n              a!isNullOrEmpty(ri!groupByFields),\n              reject(\n                a!isNullOrEmpty,\n                a!flatten(\n                  {\n                    ri!fields,\n                    index(ri!relatedRecordData, \"relationship\", {})\n                  }\n                )\n              ),\n              #\"SYSTEM_SYSRULES_aggregationFields\"(\n                groupings: #\"SYSTEM_SYSRULES_forEach\"(\n                  items: ri!groupByFields,\n                  expression: #\"SYSTEM_SYSRULES_grouping\"(field: fv!item, alias: tostring(fv!item))\n                ),\n                measures: #\"SYSTEM_SYSRULES_measure\"(\n                  field: ri!groupByFields[1],\n                  function: \"COUNT\",\n                  alias: \"count\"\n                )\n              )\n            ),\n            filters: #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n              operator: \"AND\",\n              ignoreFiltersWithEmptyValues: true,\n              logicalExpressions: {\n                ri!logicalExpressions,\n                if(\n                  and(\n                    a!isNotNullOrEmpty(ri!searchFields),\n                    a!isNotNullOrEmpty(ri!searchTerm)\n                  ),\n                  #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n                    operator: \"AND\",\n                    logicalExpressions: #\"SYSTEM_SYSRULES_forEach\"(\n                      items: split(trim(ri!searchTerm), \" \"),\n                      expression: a!localVariables(\n                        local!splitSearchTerm: fv!item,\n                        /*   Initiate filter for each field by the value provided in searchTerm   */\n                        #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n                          operator: \"OR\",\n                          filters: #\"SYSTEM_SYSRULES_forEach\"(\n                            items: ri!searchFields,\n                            expression: #\"SYSTEM_SYSRULES_queryFilter\"(\n                              field: fv!item,\n                              operator: \"includes\",\n                              value: local!splitSearchTerm\n                            )\n                          )\n                        )\n                      )\n                    )\n                  ),\n                  {}\n                )\n              },\n              filters: ri!filters\n            ),\n            pagingInfo: if(\n              a!isNullOrEmpty(ri!groupByFields),\n              local!queryParams.pagingInfo,\n              #\"urn:appian:function:v1:a:update\"(\n                local!queryParams.pagingInfo,\n                \"sort\",\n                null\n              )\n            ),\n            fetchTotalCount: local!queryParams.fetchTotalCount,\n            relatedRecordData: if(\n              a!isNullOrEmpty(ri!groupByFields),\n              ri!relatedRecordData,\n              {}\n            )\n          )\n        ),\n        refreshOnVarChange: ri!triggerRefresh,\n        refreshAfter: { \"RECORD_ACTION\" }\n      ),\n      /*Format the output*/\n      local!output: a!match(\n        value: local!returnType,\n        equals: \"OBJECT_ARRAY\",\n        then: cast(\n          local!queryParams.castToType,\n          index(local!queryResult,\"data\",{})\n        ),\n        equals: \"SINGLE_OBJECT\",\n        then: cast(\n          local!queryParams.castToType,\n          index(local!queryResult,\"data\",{})\n        ),\n        equals: \"RECORD_BY_ID\",\n        /*do not need to cast for queryRecordByIdentifier*/\n        then: local!queryResult,\n        equals: \"DATA_SUBSET\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult\n        ),\n        equals: \"TOTAL_COUNT\",\n        then: cast(\n          local!queryParams.castToType,\n          index(local!queryResult,\"totalCount\",{})\n        ),\n        default: null\n      ),\n      local!output\n    )\n  )\n)"
    },
    "_a-0000ee3e-060c-8000-9bb8-011c48011c48_204932": {
      "name": "AIA_Extraction_CreateJsonSchema",
      "type": "Expression Rule",
      "sail_code": "\na!localVariables(\n  local!modelFields: #\"SYSTEM_SYSRULES_fromJson_v1\"(#\"SYSTEM_SYSRULES_toJson_v1\"(\n    a!defaultValue(\n      ri!fields,\n      filter(\n        rule!AIA_Extraction_DisplayPromptField(\n          field: _,\n          mode: ri!mode,\n          operation: ri!operation\n        ),\n        ri!ExtractionModelVersion[recordType!AIA Extraction Model Version.fields]\n      )\n    )\n  )),\n  if(\n    a!isNotNullOrEmpty(local!modelFields),\n    a!localVariables(\n      local!fields: reduce(\n        #\"urn:appian:function:v1:a:update\",\n        a!map(),\n        merge(\n          local!modelFields.key,\n          #\"SYSTEM_SYSRULES_forEach\"(\n            local!modelFields,\n            rule!AIA_FieldJsonSchema(\n              item: fv!item,\n              mode: ri!mode,\n              operation: ri!operation,\n              includeArrays: a!defaultValue(ri!includeArrays, true)\n            )\n          )\n        )\n      ),\n      local!map: #\"SYSTEM_SYSRULES_fromJson_v1\"(\n        #\"SYSTEM_SYSRULES_toJson_v1\"(\n          value: a!map(\n            \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n            type: \"object\",\n            properties: local!fields,\n            required: reject(\n              fn!isnull,\n              index(\n                local!modelFields.key,\n                where(local!modelFields.required)\n              )\n            )\n          ),\n          removeNullOrEmptyFields: true\n        )\n      ),\n      if(\n        ri!returnJson,\n        prettyprintjson(#\"SYSTEM_SYSRULES_toJson_v1\"(local!map)),\n        local!map\n      )\n    ),\n    null\n  )\n)"
    },
    "_a-0000ed96-b933-8000-9c8f-011c48011c48_923674": {
      "name": "AIA_Extraction_RemoveNonSectionFields",
      "type": "Expression Rule",
      "sail_code": "=a!localVariables(\n  local!map: rule!AIA_ExtractJson(json: ri!responseJson),\n  if(\n    or(\n      a!isNullOrEmpty(ri!keysToRemove),\n      a!isNullOrEmpty(local!map)\n    ),\n    ri!responseJson,\n    rule!AIA_ToJson(\n      data: reduce(\n        fn!remove,\n        rule!AIA_ExtractJson(json: ri!responseJson),\n        ri!keysToRemove\n      )\n    )\n  )\n)"
    },
    "_a-0000ec1e-9975-8000-9bd6-011c48011c48_1378240": {
      "name": "AIA_Extraction_DefaultPromptRole",
      "type": "Expression Rule",
      "sail_code": "=#\"urn:appian:translation-string:v1:ad2e9011-234a-41f6-979a-45bf04987d45\""
    },
    "_a-0000eca1-71bf-8000-9c0b-011c48011c48_149695": {
      "name": "AIA_Extraction_BoundingBoxesInstructions",
      "type": "Expression Rule",
      "sail_code": "=\"\n- \" & #\"urn:appian:translation-string:v1:f430adf5-5028-4f82-9579-6d5a30d46b00\" & \"\n    - \" & #\"urn:appian:translation-string:v1:6701bdd2-dc86-46fd-b918-39ee518ddfc0\" & \" <example>{..., \"\"brokerBranch\"\": {\"\"value\"\": \"\"some branch name\"\", \"\"spanId\"\": \"\"abcd1234\"\"}, ...}</example>\n    - \" & #\"urn:appian:translation-string:v1:fb5aa790-a812-42e8-b713-144b1e9f11ff\" & \" <example>[{\"\"column1\"\": \"\"value\"\", \"\"column2\"\": \"\"value\"\", ..., \"\"columnN\"\" : \"\"value\"\", \"\"spanId\"\": \"\"abc1234\"\"}, ...]</example>\n    - \" & #\"urn:appian:translation-string:v1:7fdc7b4d-ae4b-482c-8042-2df75a693468\" & \" <example>[{\"\"value\"\": \"\"item\"\", \"\"spanId\"\": \"\"abc1234\"\"}]</example>\n- \" & #\"urn:appian:translation-string:v1:9c5e3486-fcad-4bf4-ab97-eb0e6f2ec8fd\" & \"\n\n<example>\n{\n  \"\"field1\"\": {\"\"value\"\": \"\"field 1 value\"\", \"\"spanId\"\": \"\"ABCD1234\"\"},\n  \"\"field2\"\": {\"\"value\"\": \"\"field 2 value\"\", \"\"spanId\"\": \"\"DEFG1234\"\"},\n  \"\"table1\"\": [\n    {\"\"column1\"\": \"\"col 1 value\"\", \"\"column2\"\": \"\"col 2 value\"\", \"\"spanId\"\": \"\"GHIJ1234\"\"},\n    {\"\"column1\"\": \"\"col 1 value\"\", \"\"column2\"\": \"\"col 2 value\"\", \"\"spanId\"\": \"\"JKLM1234\"\"},\n  ],\n  \"\"table2\"\": [\n    {\"\"column1\"\": \"\"col 1 value\"\", \"\"column2\"\": \"\"col 2 value\"\", \"\"column3\"\": \"\"col 3 value\"\", \"\"spanId\"\": \"\"MNOP1234\"\"},\n    {\"\"column1\"\": \"\"col 1 value\"\", \"\"column2\"\": \"\"col 2 value\"\", \"\"column3\"\": \"\"col 3 value\"\", \"\"spanId\"\": \"\"PQRS1234\"\"},\n  ],\n  \"\"list1\"\": [\n    {\"\"value\"\": \"\"First value\"\", \"\"spanId\"\": \"\"ABCD1234\"\"},\n    {\"\"value\"\": \"\"Second value\"\", \"\"spanId\"\": \"\"QRST5678\"\"}\n  ],\n  \"\"list2\"\": [\n    {\"\"value\"\": \"\"First value\"\", \"\"spanId\"\": \"\"EFGH1234\"\"},\n    {\"\"value\"\": \"\"Second value\"\", \"\"spanId\"\": \"\"IJKL5678\"\"},\n    {\"\"value\"\": \"\"Third value\"\", \"\"spanId\"\": \"\"IJKL5678\"\"}\n  ]\n}\n</example>\n\""
    },
    "_a-0000ed69-99d8-8000-9ba6-011c48011c48_55310": {
      "name": "AIA_Extraction_ShouldRunText",
      "type": "Expression Rule",
      "sail_code": "or(\n  and(\n    a!isNullOrEmpty(ri!ExtractionInstance[recordType!AIA Extraction Instance.documentId]),\n    a!isNotNullOrEmpty(ri!ExtractionInstance[recordType!AIA Extraction Instance.inputText])\n  ),\n  rule!AIA_Extraction_UseBoundingBoxes(\n    ExtractionInstance: ri!ExtractionInstance\n  ),\n  toboolean(ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.extractionModel.useAdvancedLayout]),\n  rule!AIA_IsDocumentExtension(\n    document: ri!ExtractionInstance[recordType!AIA Extraction Instance.documentId],\n    extensions: cons!AIA_TEXT_BASED_EXTENSIONS\n  ) \n)"
    },
    "_a-0000ec2d-5396-8000-9bdc-011c48011c48_40675": {
      "name": "AIA_Extraction_GeneratePrompt",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!promptMap: rule!AIA_Extraction_GeneratePromptMap(\n    sectionInstance: ri!sectionInstance,\n    sectionFilter: ri!sectionFilter,\n    operation: ri!operation,\n    modelVersion: ri!modelVersion,\n    hasBoundingBoxes: ri!hasBoundingBoxes,\n    ExtractionInstance: ri!ExtractionInstance,\n    batch: ri!batch\n  ),\n  local!promptMap.role & rule!AIA_PROMPT_SECTION_DIVIDER() & \n  local!promptMap.entities & rule!AIA_PROMPT_SECTION_DIVIDER() & \n  local!promptMap.instructions & rule!AIA_PROMPT_SECTION_DIVIDER() & \n  if(\n    a!isNotNullOrEmpty(local!promptMap.examples),\n    local!promptMap.examples & rule!AIA_PROMPT_SECTION_DIVIDER(),\n    \"\"\n  )\n)"
    },
    "_a-0000ed69-99d8-8000-9ba6-011c48011c48_55136": {
      "name": "AIA_Extraction_UseBoundingBoxes",
      "type": "Expression Rule",
      "sail_code": "a!defaultValue(\n  ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.extractionModel.useBoundingBoxes],\n  cons!AIA_BOOL_CAPTURE_BOUNDING_BOXES\n)"
    },
    "_a-0000ed96-b933-8000-9c8f-011c48011c48_921774": {
      "name": "AIA_Extraction_GetDataSubset",
      "type": "Expression Rule",
      "sail_code": "if(\n  ri!promptType = cons!AIA_PROMPT_DYNAMIC,\n  rule!AIA_Extraction_GetBoundingBoxByIdAndIndex(\n    extractionId: ri!ExtractionInstance[recordType!AIA Extraction Instance.id],\n    sectionId: ri!SectionInstance[recordType!AIA Extraction Instance Section.id],\n    batchId: ri!batchId\n  ),\n  rule!AIA_Extraction_GetSectionsByBatch(\n    extractionId: ri!ExtractionInstance[recordType!AIA Extraction Instance.id],\n    sectionId: ri!SectionInstance[recordType!AIA Extraction Instance Section.sectionId],\n    batchId: ri!batchId,\n  )\n)"
    },
    "_a-0000ec1e-9975-8000-9bd6-011c48011c48_1374470": {
      "name": "AIA_Extraction_PromptInstructions",
      "type": "Expression Rule",
      "sail_code": "\"## Instructions\n\n\" & joinarray(\n  reject(\n    fn!isnull,\n    {\n      \"- \" & #\"urn:appian:translation-string:v1:068d246a-b84d-42a2-a07b-02833e24e15c\",\n      \"- \" & #\"urn:appian:translation-string:v1:bd52b8f6-1431-454e-875f-7e8b8ebe9da7\",\n      \"- \" & #\"urn:appian:translation-string:v1:e3c91fec-48f5-4848-8406-e97856ad96af\",\n      \"- \" & #\"urn:appian:translation-string:v1:361ff628-e4e9-431b-8472-ecadea9b11d8\",\n      if(\n        or(\n          ri!modelVersion[recordType!AIA Extraction Model Version.fields.isMultiple]\n        ),\n        \"- \" & #\"urn:appian:translation-string:v1:925e0dd9-c0f8-45e7-af9f-916a29285ccd\",\n        null\n      ),\n      if(\n        or(\n          contains(\n            ri!modelVersion[recordType!AIA Extraction Model Version.fields.type],\n            {cons!AIA_EXTRACTION_FIELD_TYPES[2],cons!AIA_EXTRACTION_FIELD_TYPES[3]}\n          ),\n          contains(\n            a!flatten(ri!modelVersion[recordType!AIA Extraction Model Version.fields.columns.type]),\n            {cons!AIA_EXTRACTION_FIELD_TYPES[2],cons!AIA_EXTRACTION_FIELD_TYPES[3]}\n          )\n        ),\n        \"- \" & #\"urn:appian:translation-string:v1:8e6dd327-f952-4c3f-b8e3-8ce9acdc4345\",\n        null\n      ),\n      if(\n        or(\n          contains(\n            ri!modelVersion[recordType!AIA Extraction Model Version.fields.type],\n            cons!AIA_EXTRACTION_FIELD_TYPES[4]\n          ),\n          contains(\n            a!flatten(ri!modelVersion[recordType!AIA Extraction Model Version.fields.columns.type]),\n            cons!AIA_EXTRACTION_FIELD_TYPES[4]\n          )\n        ),\n        \"- \" & #\"urn:appian:translation-string:v1:27d6e065-3f9f-471b-b412-1d3847d474bc\",\n        null\n      ),\n      if(\n        or(\n          contains(\n            ri!modelVersion[recordType!AIA Extraction Model Version.fields.type],\n            cons!AIA_EXTRACTION_FIELD_TYPES[5]\n          ),\n          contains(\n            a!flatten(ri!modelVersion[recordType!AIA Extraction Model Version.fields.columns.type]),\n            cons!AIA_EXTRACTION_FIELD_TYPES[5]\n          )\n        ),\n        \"- \" & #\"urn:appian:translation-string:v1:5bae3763-38ac-423c-9336-2c6d82051a95\",\n        null\n      ),\n      if(\n        any(\n          a!isNotNullOrEmpty,\n          a!flatten(\n            {\n              ri!modelVersion[recordType!AIA Extraction Model Version.fields.optionRule],\n              ri!modelVersion[recordType!AIA Extraction Model Version.fields.columns.optionRule],\n            }\n          )\n        ),\n        \"- \" & #\"urn:appian:translation-string:v1:c6d3ccf5-b428-4900-b98b-e8df8db90ce8\",\n        null\n      ),\n      \"- Today's date is \" & text(today(), \"yyyy-MM-dd\"),\n      ri!modelVersion[recordType!AIA Extraction Model Version.instructions],\n    }\n  ),\n  char(10)\n)"
    },
    "_a-0000ecf1-11b9-8000-9c4e-011c48011c48_199422": {
      "name": "AIA_Test_GetLatestExtractionInstanceWithFields",
      "type": "Expression Rule",
      "sail_code": "rule!AIA_Extraction_GetInstanceById(\n  identifier: #\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n    recordType: recordType!AIA Extraction Instance,\n    pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n      startIndex: 1,\n      batchSize: 1,\n      sort: {\n        #\"SYSTEM_SYSRULES_sortInfo\"(\n          field: recordType!AIA Extraction Instance.id\n        )\n      }\n    )\n  ).data[recordType!AIA Extraction Instance.id],\n  additionalFields: {\n    recordType!AIA Extraction Instance.inputDocumentId,\n    recordType!AIA Extraction Instance.documentFolderId,\n    recordType!AIA Extraction Instance.modelVersion,\n    recordType!AIA Extraction Instance.modelVersion.confidenceThreshold,\n    recordType!AIA Extraction Instance.modelVersion,\n    recordType!AIA Extraction Instance.modelVersion,\n  }\n)"
    },
    "_a-0001eccb-4552-8000-9c3e-011c48011c48_159890": {
      "name": "AIA_JoinJsonPrompt",
      "type": "Expression Rule",
      "sail_code": "=\"## Original Prompt Context\n\nBelow is the prompt that was used to generate the JSON results you'll be working with.\n\n<original prompt>\n```\" & ri!originalPrompt & \"```\n</original prompt>\n\n---\n## Your Task: Create a Single JSON\n\nPlease combine all the JSON payloads listed at the end of this prompt into a single, clean JSON output by following these rules:\n\n1.  **For standard fields** (anything that isn't a table), review the different versions and choose the single **best result** for the final output.\n2.  **For table data** (like line items), first **combine all the rows** from every payload into one big list, then **remove any duplicate rows** to create the final, consolidated table.\""
    },
    "_a-0000ed57-1773-8000-9c7e-011c48011c48_327806": {
      "name": "AIA_Extraction_VisionInstructions",
      "type": "Expression Rule",
      "sail_code": "=\"- \" & #\"urn:appian:translation-string:v1:37e1cfad-08b7-4397-bcee-4dd175e4f0e8\" & \"\n- \" & #\"urn:appian:translation-string:v1:f5505f0e-9119-4a41-8953-ec5ef8f2d904\" & \" <example>{..., \"\"brokerBranch\"\": {\"\"value\"\": \"\"some branch name\"\", \"\"pageNum\"\": \"\"1\"\"}, ...}</example>\n- \" & #\"urn:appian:translation-string:v1:0f4e0ba0-b7aa-45a9-9087-95883107d7e6\" & \" <example>[{\"\"column1\"\": \"\"value\"\", \"\"column2\"\": \"\"value\"\", ..., \"\"columnN\"\" : \"\"value\"\", \"\"pageNum\"\": \"\"2\"\"}, ...]</example>\n- \" & #\"urn:appian:translation-string:v1:d92f05d6-36f5-47d4-8a63-e1320620aebc\" & \" <example>[{\"\"value\"\": \"\"item\"\", \"\"pageNum\"\": \"\"3\"\"}]</example>\n- \" & #\"urn:appian:translation-string:v1:9202de9d-b760-4db0-b0a6-9c958417d630\" & \"\n\n<example>\n```json\n{\n  \"\"field1\"\": {\"\"value\"\": \"\"field 1 value\"\", \"\"pageNum\"\": \"\"1\"\"},\n  \"\"field2\"\": {\"\"value\"\": \"\"field 2 value\"\", \"\"pageNum\"\": \"\"2\"\"},\n  \"\"table1\"\": [\n    {\"\"column1\"\": \"\"col 1 value\"\", \"\"column2\"\": \"\"col 2 value\"\", \"\"pageNum\"\": \"\"3\"\"},\n    {\"\"column1\"\": \"\"col 1 value\"\", \"\"column2\"\": \"\"col 2 value\"\", \"\"pageNum\"\": \"\"3\"\"},\n  ],\n  \"\"table2\"\": [\n    {\"\"column1\"\": \"\"col 1 value\"\", \"\"column2\"\": \"\"col 2 value\"\", \"\"column3\"\": \"\"col 3 value\"\", \"\"pageNum\"\": \"\"4\"\"},\n    {\"\"column1\"\": \"\"col 1 value\"\", \"\"column2\"\": \"\"col 2 value\"\", \"\"column3\"\": \"\"col 3 value\"\", \"\"pageNum\"\": \"\"5\"\"},\n  ],\n  \"\"list1\"\": [\n    {\"\"value\"\": \"\"First value\"\", \"\"pageNum\"\": \"\"2\"\"},\n    {\"\"value\"\": \"\"Second value\"\", \"\"pageNum\"\": \"\"2\"\"}\n  ],\n  \"\"list2\"\": [\n    {\"\"value\"\": \"\"First value\"\", \"\"pageNum\"\": \"\"1\"\"},\n    {\"\"value\"\": \"\"Second value\"\", \"\"pageNum\"\": \"\"1\"\"},\n    {\"\"value\"\": \"\"Third value\"\", \"\"pageNum\"\": \"\"1\"\"}\n  ]\n}\n```\n</example>\""
    },
    "_a-0000ed1d-549f-8000-9c66-011c48011c48_287313": {
      "name": "AIA_GetModelVersionExamples",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!isExtraction: runtimetypeof(ri!modelVersion) = typeof(\n    recordType!AIA Extraction Model Version()\n  ),\n  local!fields: if(\n    local!isExtraction,\n    a!map(\n      relationship: recordType!AIA Extraction Model Version.examples\n    ),\n    a!map(\n      relationship: recordType!AIA Classification Model Version.examples\n    )\n  ),\n  local!hasExamples: a!isNotNullOrEmpty(\n    reject(\n      fn!isnull,\n      {\n        ri!modelVersion[local!fields.relationship][recordType!AIA Model Version Example.id]\n      }\n    )\n  ),\n  if(\n    local!hasExamples,\n    reject(\n      fn!isnull,\n      #\"SYSTEM_SYSRULES_forEach\"(\n        cast(\n          #\"urn:appian:function:v1:a:listtype?okey=a!listType\"(\n            recordType!AIA Model Version Example\n          ),\n          #\"SYSTEM_SYSRULES_queryEntity_v2\"(\n            entity: cons!AIA_DSE_MODEL_VERSION_EXAMPLE,\n            query: #\"SYSTEM_SYSRULES_query\"(\n              filter: #\"SYSTEM_SYSRULES_queryFilter\"(\n                field: \"id\",\n                operator: \"in\",\n                value: ri!modelVersion[local!fields.relationship][recordType!AIA Model Version Example.id]\n              ),\n              pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(1, 100)\n            ),\n            fetchTotalCount: false\n          ).data\n        ),\n        if(\n          or(\n            not(local!isExtraction),\n            a!match(\n              value: rule!AIA_ExtractJson(\n                json: fv!item[recordType!AIA Model Version Example.rule]\n              ),\n              whenTrue: or(\n                a!isNullOrEmpty(fv!value),\n                a!isNullOrEmpty(ri!fields)\n              ),\n              then: true,\n              whenTrue: tostring(index(fv!value,\"type\",null())) = \"FIELD\",\n              then: contains(\n                touniformstring(\n                  ri!fields[recordType!AIA Extraction Model Version Field.key]\n                ),\n                tostring(fv!value.field)\n              ),\n              default: true\n            )\n          ),\n          fv!item,\n          null\n        )\n      )\n    ),\n    null\n  )\n)"
    },
    "_a-0000ec44-cb49-8000-9be6-011c48011c48_79495": {
      "name": "AIA_Extraction_GetFieldOptions",
      "type": "Expression Rule",
      "sail_code": "if(\n  a!isNotNullOrEmpty(\n    ri!ModelVersionField[recordType!AIA Extraction Model Version Field.optionRule]\n  ),\n  a!localVariables(\n    local!optionsRule: a!refreshVariable(\n      refreshAlways: true,\n      value: getrulereferencebyname(\n        ri!ModelVersionField[recordType!AIA Extraction Model Version Field.optionRule]\n      )\n    ),\n    a!map(options: local!optionsRule())\n  ),\n  null\n)"
    },
    "_a-0000ee5d-151c-8000-9ba8-011c48011c48_32272": {
      "name": "AIA_JoinJsonInput",
      "type": "Expression Rule",
      "sail_code": "a!map(\n  input: \"## JSON Payloads to Merge\n\n```json\" & char(\n  10\n) & joinarray(\n  ri!responseJsons,\n  char(\n    10\n  ) & \"```\" & char(\n    10\n  ) & char(\n    10\n  ) & \"```json\" & char(\n    10\n  )\n) & char(\n  10\n) & \"```\"\n)"
    },
    "_a-0000ed16-a792-8000-9c64-011c48011c48_274759": {
      "name": "AIA_ToJson",
      "type": "Expression Rule",
      "sail_code": "if(\n  a!isNullOrEmpty(ri!data),\n  \"null\",\n  #\"SYSTEM_SYSRULES_toJson_v1\"(ri!data)\n)"
    },
    "_a-0000ee21-294f-8000-9bb6-011c48011c48_182518": {
      "name": "AIA_IsDocumentExtension",
      "type": "Expression Rule",
      "sail_code": "and(\n  a!isNotNullOrEmpty(ri!document),\n  contains(\n    lower(ri!extensions),\n    lower(document(\n      ri!document,\n      \"extension\"\n    ))\n  )\n)"
    },
    "_a-0000ed5d-bd1b-8000-9c80-011c48011c48_329766": {
      "name": "AIA_Extraction_GeneratePromptMap",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!sectionId: if(\n    a!isNullOrEmpty(ri!SectionInstance),\n    null,\n    a!defaultValue(\n      ri!SectionInstance[recordType!AIA Extraction Instance Section.sectionId],\n      - 1\n    )\n  ),\n  local!fields: filter(\n    rule!AIA_Extraction_DisplayPromptField(\n      sectionFilter: ri!sectionFilter,\n      sectionId: local!sectionId,\n      field: _,\n      operation: ri!operation\n    ),\n    ri!modelVersion[recordType!AIA Extraction Model Version.fields]\n  ),\n  local!role: a!defaultValue(\n    ri!modelVersion[recordType!AIA Extraction Model Version.role],\n    rule!AIA_Extraction_DefaultPromptRole()\n  ),\n  local!instructions: rule!AIA_Extraction_PromptInstructions(\n    modelVersion: ri!modelVersion\n  ) & a!match(\n    value: true,\n    whenTrue: ri!hasBoundingBoxes,\n    then: char(10) & rule!AIA_Extraction_BoundingBoxesInstructions(),\n    whenTrue: ri!operation = cons!AIA_PROMPT_OPERATION_MODE_MULTIMODAL,\n    then: char(10) & rule!AIA_Extraction_VisionInstructions(),\n    default: \"\"\n  ),\n  local!examples: \n  /*if(*/\n    /*ri!modelVersion['recordType!{f00f33ce-439e-4c81-9931-a244a643c0e8}AIA Extraction Model Version.fields.{71248595-92d7-42c5-b216-285a4e91704e}modelVersionId']=112,*/\n    /*rule!S_GeneratePromptExamplesFromPreviousInstance(*/\n      /*modelVersion: ri!modelVersion,*/\n      /*fields: local!fields*/\n    /*),*/\n    rule!AIA_Extraction_GeneratePromptExamples(\n      modelVersion: ri!modelVersion,\n      fields: local!fields\n    /*)*/\n  ),\n  local!entities: if(\n    a!isNotNullOrEmpty(local!fields),\n    rule!AIA_Extraction_GeneratePromptEntities(\n      fields: local!fields,\n      mode: if(\n        and(\n          ri!hasBoundingBoxes,\n          ri!operation <> cons!AIA_PROMPT_OPERATION_MODE_MULTIMODAL\n        ),\n        cons!AIA_SCHEMA_MODE_SPAN,\n        cons!AIA_SCHEMA_MODE_PLAIN\n      )\n    ),\n    null\n  ),\n  a!map(\n    role: local!role,\n    instructions: local!instructions,\n    entities: local!entities,\n    examples: local!examples\n  )\n)"
    },
    "_a-0000ecea-6c5f-8000-9c4b-011c48011c48_190177": {
      "name": "AIA_Extraction_DisplayPromptField",
      "type": "Expression Rule",
      "sail_code": "a!match(\n  value: ri!mode,\n  whenTrue: a!isNullOrEmpty(ri!field[recordType!AIA Extraction Model Version Field.key]),\n  then: false,\n  equals: cons!AIA_SCHEMA_MODE_AI_REVIEW,\n  then: a!defaultValue(ri!field[recordType!AIA Extraction Model Version Field.useAiReview], false) = true,\n  equals: cons!AIA_PROMPT_MODE_CALCULATED,\n  then: or(\n    ri!field[recordType!AIA Extraction Model Version Field.extractionType] = cons!AIA_EXTRACTION_TYPES[4],\n    and(\n      ri!field[recordType!AIA Extraction Model Version Field.type] = cons!AIA_EXTRACTION_FIELD_TYPE_TABLE,\n      contains(\n        touniformstring(\n          ri!field[recordType!AIA Extraction Model Version Field.columns.extractionType]\n        ),\n        cons!AIA_EXTRACTION_TYPES[4]\n      )\n    )\n  ),\n  default: and(\n    /* Filter out field by section */\n    or(\n      and(\n        a!isNullOrEmpty(ri!sectionFilter),\n        a!isNullOrEmpty(ri!sectionId)\n      ),\n      and(\n        a!isNotNullOrEmpty(ri!sectionFilter),\n        a!isNotNullOrEmpty(\n          ri!field[recordType!AIA Extraction Model Version Field.section]\n        ),\n        ri!field[recordType!AIA Extraction Model Version Field.section] = ri!sectionFilter\n      ),\n      or(\n        and(\n          a!isNotNullOrEmpty(ri!sectionId),\n          a!isNotNullOrEmpty(\n            ri!field[recordType!AIA Extraction Model Version Field.sectionId]\n          ),\n          ri!field[recordType!AIA Extraction Model Version Field.sectionId] = ri!sectionId\n        ),\n        and(\n          a!isNotNullOrEmpty(ri!sectionId),\n          a!isNullOrEmpty(\n            ri!field[recordType!AIA Extraction Model Version Field.sectionId]\n          ),\n          ri!sectionId = - 1\n        )\n      )\n    ),\n    /* Filter out field by extraction type - Generative AI */\n    or(\n      ri!field[recordType!AIA Extraction Model Version Field.extractionType] = cons!AIA_EXTRACTION_TYPES[1],\n      a!isNullOrEmpty(\n        ri!field[recordType!AIA Extraction Model Version Field.extractionType]\n      )\n    ),\n    /* Filter out field by operation type */\n    or(\n      /* Filter out field by operation type - Generative AI - Text */\n      and(\n        or(\n          a!isNullOrEmpty(ri!operation),\n          ri!operation = cons!AIA_PROMPT_OPERATION_MODE_TEXT\n        ),\n        or(\n          a!isNullOrEmpty(ri!field[recordType!AIA Extraction Model Version Field.useVision]),\n          ri!field[recordType!AIA Extraction Model Version Field.useVision] = false,\n        )\n      ),\n      /* Filter out field by operation type - Generative AI - Vision */\n      and(\n        ri!operation = cons!AIA_PROMPT_OPERATION_MODE_MULTIMODAL,\n        or(\n          and(\n            a!isNotNullOrEmpty(ri!field[recordType!AIA Extraction Model Version Field.useVision]),\n            ri!field[recordType!AIA Extraction Model Version Field.useVision] = true\n          ),\n          and(\n            a!isNotNullOrEmpty(ri!parentField[recordType!AIA Extraction Model Version Field.useVision]),\n            ri!parentField[recordType!AIA Extraction Model Version Field.useVision] = true\n          )\n        )\n      )\n    )\n  )\n)"
    },
    "_a-0000ed69-99d8-8000-9ba6-011c48011c48_55250": {
      "name": "AIA_Extraction_ShouldRunAdvancedIdp",
      "type": "Expression Rule",
      "sail_code": "and(\n  cons!AIA_ADVANCED_IDP_ENABLED,\n  or(\n    ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.extractionModel.useAdvancedLayout] = true,\n    ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.extractionModel.useBoundingBoxes] = true\n  ),\n  or(\n    a!isNullOrEmpty(ri!useAdvancedIdp),\n    ri!useAdvancedIdp = true\n  ),\n  rule!AIA_IsDocumentExtension(\n    document: ri!ExtractionInstance[recordType!AIA Extraction Instance.documentId],\n    extensions: cons!AIA_AI_SUPPORTED_DOC_TYPES\n  ) \n)"
    },
    "_a-0000ee66-4fc0-8000-9baa-011c48011c48_43003": {
      "name": "AIA_ENUM_FieldSchemas",
      "type": "Expression Rule",
      "sail_code": "{\n  a!map(\n    name: cons!AIA_SCHEMA_MODE_PLAIN,\n    fields: {}\n  ),\n  a!map(\n    name: cons!AIA_SCHEMA_MODE_SPAN,\n    fields: {\n      a!map(\n        key: \"value\",\n        useFormat: true\n      ),\n      a!map(\n        key: \"spanId\",\n        required: false,\n        type: \"string\"\n      )\n    }\n  ),\n  a!map(\n    name: cons!AIA_PROMPT_MODE_CALCULATED,\n    fields: {\n      a!map(\n        key: \"value\",\n        useFormat: true\n      ),\n      a!map(\n        key: \"spanId\",\n        description: \"spanIds from all of the values that were used to derive the result. Return null if the values did not have spanId.\",\n        required: false,\n        type: \"string\"\n      ),\n      a!map(\n        key: \"reasoning\",\n        required: true,\n        type: \"string\"\n      )\n    }\n  ),\n  a!map(\n    name: cons!AIA_SCHEMA_MODE_AI_REVIEW,\n    fields: {\n      a!map(\n        key: \"extractedValue\",\n        required: false,\n        useFormat: true\n      ),\n      a!map(\n        key: \"suggestedValue\",\n        required: false,\n        useFormat: true\n      ),\n      a!map(\n        key: \"isCorrect\",\n        required: true,\n        type: \"boolean\"\n      ),\n      a!map(\n        key: \"reasoning\",\n        required: true,\n        type: \"string\"\n      )\n    }\n  )\n}"
    },
    "_a-0000ec2d-5396-8000-9bdc-011c48011c48_40909": {
      "name": "AIA_ExtractJson",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!firstTry: rule!AIA_ExtractJsonInner(\n    json: ri!json\n  ),\n  local!result: if(\n    a!isNotNullOrEmpty(local!firstTry),\n    local!firstTry,\n    a!localVariables(\n      local!secondTry: rule!AIA_ExtractJsonInner(\n        json: index(split(ri!json, \"Appian's private AI\"), 1, null),\n      ),\n      if(\n        a!isNotNullOrEmpty(local!secondTry),\n        local!secondTry,\n        a!localVariables(\n          local!thirdTry: rule!AIA_ExtractJsonInner(\n            json: index(split(ri!json, \"Appian's private AI\"), 2, null),\n          ),\n          if(\n            a!isNotNullOrEmpty(local!thirdTry),\n            local!thirdTry,\n            a!localVariables(\n              local!forthTry: rule!AIA_ExtractJsonInner(\n                json: index(split(ri!json, \"<output>\"), 1, null),\n              ),\n              if(\n                a!isNotNullOrEmpty(local!forthTry),\n                local!forthTry,\n                a!localVariables(\n                  local!fifthTry: rule!AIA_ExtractJsonInner(\n                    json: index(split(ri!json, \"</entities>\"), 1, null),\n                  ),\n                  local!fifthTry\n                )\n              )\n            )\n          )\n        )\n      )\n    )\n  ),\n  local!finalResult: if(\n    a!isNullOrEmpty(local!result),\n    null,\n    if(\n      a!defaultValue(ri!returnList, true),\n      local!result,\n      if(\n        rule!SHRD_IsList(local!result),\n        null,\n        local!result\n      )\n    )\n  ),\n  /* Handle scenario where the result comes back as properties of a $schema */\n  if(\n    or(\n      a!defaultValue(ri!returnList, true),\n      a!isNullOrEmpty(local!finalResult),\n      not(contains(\n        a!keys(local!finalResult),\n        \"$schema\"\n      ))\n    ),\n    local!finalResult,\n    local!finalResult.properties\n  )\n)"
    },
    "_a-0000ee21-294f-8000-9bb6-011c48011c48_176683": {
      "name": "AIA_Extraction_AddTokens",
      "type": "Expression Rule",
      "sail_code": "#\"urn:appian:function:v1:a:update\"(\n  data: ri!ExtractionInstance,\n  index: {\n    recordType!AIA Extraction Instance.inputTokens,\n    recordType!AIA Extraction Instance.outputTokens\n  },\n  value: {\n    a!defaultValue(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.inputTokens],\n      0\n    ) + a!defaultValue(ri!inputTokens, 0),\n    a!defaultValue(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.outputTokens],\n      0\n    ) + a!defaultValue(ri!outputTokens, 0)\n  }\n)"
    }
  }
}