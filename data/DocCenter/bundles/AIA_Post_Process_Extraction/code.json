{
  "_metadata": {
    "bundle_id": "AIA_Post_Process_Extraction"
  },
  "objects": {
    "_a-0000ed16-a792-8000-9c64-011c48011c48_274759": {
      "name": "AIA_ToJson",
      "type": "Expression Rule",
      "sail_code": "if(\n  a!isNullOrEmpty(ri!data),\n  \"null\",\n  #\"SYSTEM_SYSRULES_toJson_v1\"(ri!data)\n)"
    },
    "_a-0000ee21-294f-8000-9bb6-011c48011c48_182518": {
      "name": "AIA_IsDocumentExtension",
      "type": "Expression Rule",
      "sail_code": "and(\n  a!isNotNullOrEmpty(ri!document),\n  contains(\n    lower(ri!extensions),\n    lower(document(\n      ri!document,\n      \"extension\"\n    ))\n  )\n)"
    },
    "_a-0000ee3d-1f5c-8000-9ba4-011c48011c48_14346": {
      "name": "AIA_FormatValueForMap",
      "type": "Expression Rule",
      "sail_code": "a!match(\n  value: ri!field[recordType!AIA Extraction Model Version Field.type],\n  whenTrue: contains(\n    index(cons!AIA_EXTRACTION_FIELD_TYPES, {4,5}),\n    fv!value\n  ),\n  then: rule!AIA_ConvertIsoToDate(\n    value: ri!value\n  ),\n  default: ri!value\n)"
    },
    "_a-0000ee3d-9bf2-8000-9ba4-011c48011c48_20674": {
      "name": "AIA_GetTextFromInstance",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!text: rule!AIA_GetDocumentText(\n    document: ri!ExtractionInstance[recordType!AIA Extraction Instance.documentId],\n    startPage: 1\n  ),\n  a!defaultValue(\n    local!text,\n    a!localVariables(\n      local!boundingBox: index(\n        rule!AIA_Extraction_GetBoundingBoxesForExtraction(\n          ExtractionInstance: ri!ExtractionInstance,\n        ),\n        1,\n        null\n      ),\n      if(\n        a!isNotNullOrEmpty(local!boundingBox),\n        rule!SHRD_ReadDocumentContent(\n          document: local!boundingBox[recordType!AIA Extraction Bounding Boxes.inputDocumentId]\n        ),\n        \"\"\n      )\n    )\n  )\n)\n  "
    },
    "_a-0000ee5d-151c-8000-9ba8-011c48011c48_32339": {
      "name": "AIA_CalculatedFieldInput",
      "type": "Expression Rule",
      "sail_code": "=a!map(\n  input: \"[Input Data]\n\n\" & ri!json\n)"
    },
    "_a-0000ec67-5f00-8000-9bf0-011c48011c48_126391": {
      "name": "AIA_API_Extraction_ConvertInstanceToMap",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!fields: rule!AIA_Extraction_GetFieldsForModelVersionId(\n    modelVersionId: ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersionId]\n  ),\n  local!updates: #\"SYSTEM_SYSRULES_forEach\"(\n    items: local!fields,\n    expression: a!map(\n      key: fv!item[recordType!AIA Extraction Model Version Field.key],\n      value: a!localVariables(\n        local!modelField: fv!item,\n        local!instanceField: displayvalue(\n          fv!item[recordType!AIA Extraction Model Version Field.key],\n          ri!ExtractionInstance[recordType!AIA Extraction Instance.fields][recordType!AIA Extraction Instance Field.modelVersionField.key],\n          ri!ExtractionInstance[recordType!AIA Extraction Instance.fields],\n          null\n        ),\n        if(\n          fv!item[recordType!AIA Extraction Model Version Field.type] = cons!AIA_EXTRACTION_FIELD_TYPE_TABLE,\n          /* Get table field */\n          a!localVariables(\n            local!extractedRows: local!instanceField[recordType!AIA Extraction Instance Field.rows],\n            local!extractedRowsRemoved:index(\n              local!extractedRows,\n              where(#\"SYSTEM_SYSRULES_forEach\"(local!extractedRows, fv!item[recordType!AIA Extraction Instance Field Row.overrideValue] <> \"Removed\")),\n              {}\n            ),\n            #\"SYSTEM_SYSRULES_forEach\"(\n              local!extractedRowsRemoved,\n              a!localVariables(\n                local!row: fv!item,\n                reduce(\n                  #\"urn:appian:function:v1:a:update\"(_, _, _),\n                  a!map(),\n                  merge(\n                    #\"SYSTEM_SYSRULES_forEach\"(\n                      items: local!modelField[recordType!AIA Extraction Model Version Field.columns],\n                      expression: fv!item[recordType!AIA Extraction Model Version Field.key]\n                    ),\n                    #\"SYSTEM_SYSRULES_forEach\"(\n                      items: local!modelField[recordType!AIA Extraction Model Version Field.columns],\n                      expression: a!localVariables(\n                        local!cellField: displayvalue(\n                          fv!item[recordType!AIA Extraction Model Version Field.key],\n                          local!row[recordType!AIA Extraction Instance Field Row.cells.column.key],\n                          local!row[recordType!AIA Extraction Instance Field Row.cells],\n                          null\n                        ),\n                        if(\n                          a!defaultValue(\n                            local!cellField[recordType!AIA Extraction Instance Field Row Cell.overrideNull],\n                            false\n                          ) = true,\n                          null,\n                          rule!AIA_FormatValueForMap(\n                            value: a!defaultValue(\n                              local!cellField[recordType!AIA Extraction Instance Field Row Cell.overrideValue],\n                              local!cellField[recordType!AIA Extraction Instance Field Row Cell.extractedValue]\n                            ),\n                            field: fv!item\n                          )\n                        )\n                      )\n                    )\n                  )\n                ) \n              )\n            )\n          ),\n          /* Get scalar field */\n          if(\n            and(\n              a!isNotNullOrEmpty(local!instanceField[recordType!AIA Extraction Instance Field.overrideNull]),\n              a!defaultValue(\n                local!instanceField[recordType!AIA Extraction Instance Field.overrideNull],\n                false\n              ) = true\n            ),\n            null,\n            rule!AIA_FormatValueForMap(\n              value: a!defaultValue(\n                local!instanceField[recordType!AIA Extraction Instance Field.overrideValue],\n                local!instanceField[recordType!AIA Extraction Instance Field.extractedValue]\n              ),\n              field: fv!item\n            )\n          )\n        )\n      )\n    )\n  ),\n  reduce(\n    rule!AIA_UTIL_UpdateByKeyValue(baseMap: _, updateMap: _),\n    a!map(),\n    local!updates\n  )\n)"
    },
    "_a-0000ed74-17c4-8000-9c8d-011c48011c48_351326": {
      "name": "AIA_Extraction_PostProcessFields",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!fields: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion],\n      if(\n        a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Field.postProcessRule]),\n        fv!item,\n        null\n      )\n    )\n  ),\n  reduce(\n    rule!SHRD_Merge,\n    a!map(),\n    #\"SYSTEM_SYSRULES_forEach\"(\n      local!fields,\n      a!localVariables(\n        local!postprocessrule: a!refreshVariable(\n          value: getrulereferencebyname(fv!item[recordType!AIA Extraction Model Version Field.postProcessRule]),\n          refreshAlways: false\n        ),\n        local!value: index(ri!map, fv!item[recordType!AIA Extraction Model Version Field.key]),\n        local!isObject: rule!AIA_IsObject(local!value),\n        local!newValue: local!postprocessrule(\n          input: a!map(\n            ExtractionInstance: ri!ExtractionInstance,\n            instanceMap: ri!map,\n            value: if(\n              local!isObject,\n              index(local!value, \"value\", null),\n              local!value\n            )\n          )\n        ),\n        #\"urn:appian:function:v1:a:update\"(\n          a!map(),\n          local!fields[recordType!AIA Extraction Model Version Field.key][fv!index],\n          if(\n            local!isObject,\n            #\"urn:appian:function:v1:a:update\"(local!value, \"value\", local!newValue),\n            local!newValue\n          )\n        )\n      )\n    )\n  )\n)"
    },
    "_a-0000ecf1-11b9-8000-9c4e-011c48011c48_199422": {
      "name": "AIA_Test_GetLatestExtractionInstanceWithFields",
      "type": "Expression Rule",
      "sail_code": "rule!AIA_Extraction_GetInstanceById(\n  identifier: #\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n    recordType: recordType!AIA Extraction Instance,\n    pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n      startIndex: 1,\n      batchSize: 1,\n      sort: {\n        #\"SYSTEM_SYSRULES_sortInfo\"(\n          field: recordType!AIA Extraction Instance.id\n        )\n      }\n    )\n  ).data[recordType!AIA Extraction Instance.id],\n  additionalFields: {\n    recordType!AIA Extraction Instance.inputDocumentId,\n    recordType!AIA Extraction Instance.documentFolderId,\n    recordType!AIA Extraction Instance.modelVersion,\n    recordType!AIA Extraction Instance.modelVersion.confidenceThreshold,\n    recordType!AIA Extraction Instance.modelVersion,\n    recordType!AIA Extraction Instance.modelVersion,\n  }\n)"
    },
    "_a-0000ecf1-11b9-8000-9c4e-011c48011c48_202842": {
      "name": "AIA_Extraction_Regex",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!fields: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion],\n      if(\n        fv!item[recordType!AIA Extraction Model Version Field.extractionType] = cons!AIA_EXTRACTION_TYPES[6],\n        fv!item,\n        null\n      )\n    )\n  ),\n  if(\n    a!isNotNullOrEmpty(local!fields),\n    a!localVariables(\n      /* TODO - Make this work with sections */\n      local!text: rule!AIA_GetTextFromInstance(\n        ExtractionInstance: ri!ExtractionInstance\n      ),\n      reduce(\n        #\"urn:appian:function:v1:a:update\",\n        a!map(),\n        merge(\n          local!fields[recordType!AIA Extraction Model Version Field.key],\n          #\"SYSTEM_SYSRULES_forEach\"(\n            local!fields,\n            index(\n              regexsearch(\n                fv!item[recordType!AIA Extraction Model Version Field.description],\n                local!text,\n                \"s\",\n                true\n              ),\n              1,\n              \"groups\",\n              1,\n              \"match\",\n              null\n            )\n          )\n        )\n      )\n    ),\n    a!map()\n  )\n)"
    },
    "_a-0000ec67-5f00-8000-9bf0-011c48011c48_126403": {
      "name": "AIA_UTIL_UpdateByKeyValue",
      "type": "Expression Rule",
      "sail_code": "#\"urn:appian:function:v1:a:update\"(\n  ri!baseMap,\n  ri!updateMap.key,\n  ri!updateMap.value\n)"
    },
    "_a-0000ee5d-151c-8000-9ba8-011c48011c48_32395": {
      "name": "AIA_Extraction_VisionSpanInput",
      "type": "Expression Rule",
      "sail_code": "a!map(\n  input: \"## Extracted Data\n\n\" & prettyprintjson(rule!AIA_ToJson(data: ri!resultMap)) & \"\n\n## Source Document\n\n###document###\",\n  parameters: {\n    a!map(\n      pattern: \"###document###\",\n      replacement: rule!AIA_Extraction_GetInputDocuments(\n        ExtractionInstance: ri!ExtractionInstance\n      )\n    )\n  }\n)"
    },
    "000eeceb-855e-8000-05ff-7f0000014e7a": {
      "name": "AIA Post Process Extraction",
      "type": "Process Model",
      "sail_code": "// Output: ?\nrule!AIA_Extraction_Regex(\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nrule!AIA_Extraction_RunRules(\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nrule!AIA_Extraction_PostProcessFields(\n  map: #\"SYSTEM_SYSRULES_fromJson_v1\"(pv!json),\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nrule!AIA_Extraction_MergeResults(\n  object: pv!json,\n  sourceMap: pv!resultMap,\n  type: cons!AIA_EXTRACTION_TYPES[6],\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nrule!AIA_Extraction_MergeResults(\n  object: pv!json,\n  sourceMap: pv!resultMap,\n  type: cons!AIA_EXTRACTION_TYPES[5],\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nrule!AIA_Extraction_MergeResults(\n  object: pv!json,\n  sourceMap: pv!resultMap,\n  type: cons!AIA_EXTRACTION_TYPES[7],\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nrule!AIA_Extraction_MergeResults(\n  object: pv!json,\n  sourceMap: pv!resultMap,\n  type: cons!AIA_EXTRACTION_TYPES[3],\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nrule!AIA_ToJson(\n  data: rule!SHRD_Merge(\n    object: rule!AIA_ExtractJson(json: pv!json),\n    source: pv!resultMap\n  )\n)\n\n// Output: ?\nrule!AIA_Extraction_MergeResults(\n  object: pv!json,\n  source: pv!responseJson,\n  type: cons!AIA_PROMPT_OPERATION_MODE_MULTIMODAL,\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nrule!AIA_Extraction_MergeResults(\n  object: pv!json,\n  source: pv!responseJson,\n  type: cons!AIA_EXTRACTION_TYPES[4],\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nrule!AIA_ToJson(\n  data: rule!SHRD_Merge(\n    object: rule!AIA_ExtractJson(json: pv!json),\n    source: a!defaultValue(pv!resultMap, a!map())\n  )\n)\n\n// Input: ?\n=pv!ExtractionInstance\n\n// Output: ?\nac!ProcessInfo.pv.resultMap\n\n// Input: ?\n=pv!ExtractionInstance\n\n// Output: ?\nac!ProcessInfo.pv.resultMap\n\n// Output: ?\nrule!AIA_ToJson(\n  data: rule!SHRD_Merge(\n    object: rule!AIA_ExtractJson(json: pv!json),\n    source: pv!resultMap\n  )\n)\n\n// Output: ?\nrule!AIA_Extraction_XPath(\n  map: #\"SYSTEM_SYSRULES_fromJson_v1\"(pv!json),\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Input: ?\n=rule!AIA_CalculatedFieldInput(\n  json: pv!json,\n)\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.id]\n\n// Input: ?\ncons!AIA_MODEL_TYPE_VALUES[1]\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.llm]\n\n// Input: ?\n#\"urn:appian:translation-string:v1:44936299-8f8f-4dca-8302-b1eb3ac5af74\"\n\n// Input: ?\n= rule!AIA_CalculatedFieldPrompt(\n  ModelVersion: pv!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion]\n)\n\n// Output: ?\nac!ProcessInfo.pv.responseJson\n\n// Output: ?\nrule!AIA_Extraction_AddTokens(ExtractionInstance: pv!ExtractionInstance, inputTokens: ac!ProcessInfo.pv.inputTokens, outputTokens: ac!ProcessInfo.pv.outputTokens)\n\n// Input: ?\nrule!AIA_Extraction_VisionSpanInput(\n  resultMap: pv!resultMap,\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.id]\n\n// Input: ?\ncons!AIA_MODEL_TYPE_VALUES[1]\n\n// Input: ?\n=pv!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.llm]\n\n// Input: ?\n#\"urn:appian:translation-string:v1:0e0ded7a-dc14-44e7-8ba7-7608c468a864\"\n\n// Input: ?\nrule!AIA_Extraction_VisionSpanPrompt(\n  resultMap: pv!resultMap,\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Output: ?\nac!ProcessInfo.pv.responseJson\n\n// Output: ?\nrule!AIA_Extraction_AddTokens(ExtractionInstance: pv!ExtractionInstance, inputTokens: ac!ProcessInfo.pv.inputTokens, outputTokens: ac!ProcessInfo.pv.outputTokens)\n\n// Input: ?\n=pv!ExtractionInstance\n\n// Output: ?\nac!ProcessInfo.pv.extractionInstance\n\n// Output: ?\nac!ProcessInfo.pv.resultMap"
    },
    "_a-0000e79d-2c73-8000-97b9-01ef9001ef90_77953": {
      "name": "SHRD_MergeInner",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!sourceKeys: a!refreshVariable(\n    refreshAlways: true,\n    value: a!keys(ri!source)\n  ),\n  reduce(\n    rule!SHRD_Update(data: _, index: _, value: _),\n    ri!object, \n    merge(\n      local!sourceKeys,\n      apply(\n        fn!index(ri!source, _),\n        local!sourceKeys,\n      )\n    )\n  )\n)"
    },
    "_a-0000ecea-6c5f-8000-9c4b-011c48011c48_190177": {
      "name": "AIA_Extraction_DisplayPromptField",
      "type": "Expression Rule",
      "sail_code": "a!match(\n  value: ri!mode,\n  whenTrue: a!isNullOrEmpty(ri!field[recordType!AIA Extraction Model Version Field.key]),\n  then: false,\n  equals: cons!AIA_SCHEMA_MODE_AI_REVIEW,\n  then: a!defaultValue(ri!field[recordType!AIA Extraction Model Version Field.useAiReview], false) = true,\n  equals: cons!AIA_PROMPT_MODE_CALCULATED,\n  then: or(\n    ri!field[recordType!AIA Extraction Model Version Field.extractionType] = cons!AIA_EXTRACTION_TYPES[4],\n    and(\n      ri!field[recordType!AIA Extraction Model Version Field.type] = cons!AIA_EXTRACTION_FIELD_TYPE_TABLE,\n      contains(\n        touniformstring(\n          ri!field[recordType!AIA Extraction Model Version Field.columns.extractionType]\n        ),\n        cons!AIA_EXTRACTION_TYPES[4]\n      )\n    )\n  ),\n  default: and(\n    /* Filter out field by section */\n    or(\n      and(\n        a!isNullOrEmpty(ri!sectionFilter),\n        a!isNullOrEmpty(ri!sectionId)\n      ),\n      and(\n        a!isNotNullOrEmpty(ri!sectionFilter),\n        a!isNotNullOrEmpty(\n          ri!field[recordType!AIA Extraction Model Version Field.section]\n        ),\n        ri!field[recordType!AIA Extraction Model Version Field.section] = ri!sectionFilter\n      ),\n      or(\n        and(\n          a!isNotNullOrEmpty(ri!sectionId),\n          a!isNotNullOrEmpty(\n            ri!field[recordType!AIA Extraction Model Version Field.sectionId]\n          ),\n          ri!field[recordType!AIA Extraction Model Version Field.sectionId] = ri!sectionId\n        ),\n        and(\n          a!isNotNullOrEmpty(ri!sectionId),\n          a!isNullOrEmpty(\n            ri!field[recordType!AIA Extraction Model Version Field.sectionId]\n          ),\n          ri!sectionId = - 1\n        )\n      )\n    ),\n    /* Filter out field by extraction type - Generative AI */\n    or(\n      ri!field[recordType!AIA Extraction Model Version Field.extractionType] = cons!AIA_EXTRACTION_TYPES[1],\n      a!isNullOrEmpty(\n        ri!field[recordType!AIA Extraction Model Version Field.extractionType]\n      )\n    ),\n    /* Filter out field by operation type */\n    or(\n      /* Filter out field by operation type - Generative AI - Text */\n      and(\n        or(\n          a!isNullOrEmpty(ri!operation),\n          ri!operation = cons!AIA_PROMPT_OPERATION_MODE_TEXT\n        ),\n        or(\n          a!isNullOrEmpty(ri!field[recordType!AIA Extraction Model Version Field.useVision]),\n          ri!field[recordType!AIA Extraction Model Version Field.useVision] = false,\n        )\n      ),\n      /* Filter out field by operation type - Generative AI - Vision */\n      and(\n        ri!operation = cons!AIA_PROMPT_OPERATION_MODE_MULTIMODAL,\n        or(\n          and(\n            a!isNotNullOrEmpty(ri!field[recordType!AIA Extraction Model Version Field.useVision]),\n            ri!field[recordType!AIA Extraction Model Version Field.useVision] = true\n          ),\n          and(\n            a!isNotNullOrEmpty(ri!parentField[recordType!AIA Extraction Model Version Field.useVision]),\n            ri!parentField[recordType!AIA Extraction Model Version Field.useVision] = true\n          )\n        )\n      )\n    )\n  )\n)"
    },
    "_a-0000ee5d-151c-8000-9ba8-011c48011c48_31384": {
      "name": "AIA_FieldJsonSchema",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!isMultiple: a!defaultValue(\n    ri!item.isMultiple,\n    false\n  ),\n  local!baseType: #\"53aa98e0-80da-4eb1-88f9-a989a8fe1aee\"(\n    type: ri!item.type\n  ),\n  local!baseField: a!map(\n    title: ri!item.label,\n    description: ri!item.description,\n    type: local!baseType.type,\n    format: local!baseType.format\n  ),\n  local!schemaType: displayValue(\n    ri!mode,\n    rule!AIA_ENUM_FieldSchemas().name,\n    rule!AIA_ENUM_FieldSchemas(),\n    null\n  ),\n  local!type: #\"53aa98e0-80da-4eb1-88f9-a989a8fe1aee\"(\n    type: ri!item.type,\n    isMultiple: local!isMultiple,\n    includeArrays: ri!includeArrays,\n    mode: ri!mode\n  ),\n  local!enum: rule!AIA_Extraction_GetFieldOptions(ModelVersionField: ri!item),\n  local!columns: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!item.columns,\n      a!match(\n        value: fv!item,\n        whenTrue: a!isNullOrEmpty(index(fv!value, \"key\", null)),\n        then: null,\n        whenTrue: and(\n          ri!operation = cons!AIA_PROMPT_OPERATION_MODE_MULTIMODAL,\n          a!defaultValue(fv!value.useVision, false) = true\n        ),\n        then: fv!item,\n        whenTrue: and(\n          ri!operation = cons!AIA_PROMPT_OPERATION_MODE_TEXT,\n          a!defaultValue(fv!value.useVision, false) = false\n        ),\n        then: fv!item,\n        default: fv!item\n      )\n    )\n  ),\n  local!properties: if(\n    and(\n      a!isNotNullOrEmpty(local!schemaType.fields),\n      or(\n        and(\n          not(local!isMultiple),\n          a!isNullOrEmpty(local!columns),\n        ),\n        not(a!defaultValue(ri!includeArrays, true))\n      )\n    ),\n    reduce(\n      #\"urn:appian:function:v1:a:update\",\n      a!map(),\n      merge(\n        local!schemaType.fields.key,\n        a!flatten({\n          #\"SYSTEM_SYSRULES_forEach\"(\n            local!schemaType.fields,\n            a!map(\n              type: a!defaultValue(fv!item.type, local!baseField.type),\n              description: fv!item.description,\n              format: if(\n                fv!item.useFormat,\n                local!baseField.format,\n                null\n              ),\n              items: if(\n                and(\n                  a!isNullOrEmpty(fv!item.type),\n                  ri!includeArrays = false\n                ),\n                rule!AIA_FieldJsonSchema(\n                  item: ri!item,\n                  mode: cons!AIA_SCHEMA_MODE_PLAIN,\n                  operation: ri!operation,\n                  includeArrays: true\n                ).items,\n                null\n              ),\n              enum: if(\n                fv!item.useFormat,\n                index(local!enum, \"options\", null),\n                null\n              ),\n            )\n          )\n        })\n      )\n    ),\n    null\n  ),\n  local!required: if(\n    and(\n      a!isNotNullOrEmpty(local!schemaType.fields),\n      a!isNullOrEmpty(local!columns),\n      not(local!isMultiple)\n    ),\n    reject(\n      fn!isnull,\n      index(\n        local!schemaType.fields.key,\n        where(local!schemaType.fields.required)\n      )\n    ),\n    null\n  ),\n  local!items: a!match(\n    value: ri!includeArrays,\n    equals: false,\n    then: null,\n    whenTrue: and(\n      a!isNotNullOrEmpty(local!columns),\n      ri!includeArrays\n    ),\n    then: a!map(\n      type: \"object\",\n      properties: reduce(\n        #\"urn:appian:function:v1:a:update\",\n        a!map(),\n        merge(\n          local!columns.key,\n          #\"SYSTEM_SYSRULES_forEach\"(\n            local!columns,\n            rule!AIA_FieldJsonSchema(\n              item: fv!item,\n              mode: ri!mode\n            )\n          )\n        )\n      ),\n      required: reject(\n        fn!isnull,\n        index(\n          local!columns.key,\n          where(local!columns.required)\n        )\n      )\n    ),\n    whenTrue: local!isMultiple,\n    then: a!localVariables(\n      local!item: rule!AIA_FieldJsonSchema(\n        item: #\"urn:appian:function:v1:a:update\"(\n          ri!item, \n          {\"label\", \"description\", \"isMultiple\"},\n          {null, null, false}\n        ),\n        mode: ri!mode\n      ),\n      if(\n        and(\n          a!isNullOrEmpty(local!schemaType.fields),\n          a!isNotNullOrEmpty(local!enum)\n        ),\n        #\"urn:appian:function:v1:a:update\"(\n          local!item,\n          \"enum\",\n          index(local!enum, \"options\", null),\n        ),\n        local!item\n      )\n    ),\n    default: null\n  ),\n  a!map(\n    title: local!baseField.title,\n    description: local!baseField.description,\n    type: local!type.type,\n    format: local!type.format,\n    properties: local!properties,\n    items: local!items,\n    required: local!required\n  )\n)"
    },
    "_a-0000ec8b-a448-8000-9ba4-011c48011c48_12288": {
      "name": "AIA_IsObject",
      "type": "Expression Rule",
      "sail_code": "or(\n  runtimetypeof(\n    ri!value\n  ) = 'type!{http://www.appian.com/ae/types/2009}Map',\n  runtimetypeof(\n    ri!value\n  ) = 'type!{http://www.appian.com/ae/types/2009}Dictionary'\n)"
    },
    "_a-0000eed1-1d21-8000-9cef-011c48011c48_187532": {
      "name": "AIA_Extraction_XPath",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!fields: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion],\n      if(\n        fv!item[recordType!AIA Extraction Model Version Field.extractionType] = cons!AIA_EXTRACTION_TYPES[8],\n        fv!item,\n        null\n      )\n    )\n  ),\n  if(\n    a!isNotNullOrEmpty(local!fields),\n    a!localVariables(\n      /* TODO - Make this work with sections */\n      local!text: rule!AIA_GetTextFromInstance(\n        ExtractionInstance: ri!ExtractionInstance\n      ),\n      reduce(\n        #\"urn:appian:function:v1:a:update\",\n        a!map(),\n        merge(\n          local!fields[recordType!AIA Extraction Model Version Field.key],\n          #\"SYSTEM_SYSRULES_forEach\"(\n            local!fields,\n            xpathsnippet(\n              local!text,\n              fv!item[recordType!AIA Extraction Model Version Field.description]\n            )\n          )\n        )\n      )\n    ),\n    a!map()\n  )\n)"
    },
    "_a-0000ee52-8983-8000-9ba6-011c48011c48_27862": {
      "name": "AIA_GetDocumentText",
      "type": "Expression Rule",
      "sail_code": "if(\n  rule!AIA_DocIsPdf(\n    document: ri!document\n  ),\n  a!localVariables(\n    local!result: trim(getpdftext(\n      ri!document,\n      a!defaultValue(ri!startPage, 1),\n      a!defaultValue(ri!endPage, null)\n    )),\n    if(\n      a!isNullOrEmpty(stripwith(local!result, char(10))),\n      null,\n      local!result\n    )\n  ),\n  if(\n    rule!AIA_IsDocumentExtension(\n      document: ri!document,\n      extensions: cons!AIA_TEXT_BASED_EXTENSIONS\n    ),\n    readdocumentcontent(\n      txtDocument: ri!document\n    ),\n    null\n  )\n)"
    },
    "_a-0000ec1e-9975-8000-9bd6-011c48011c48_1381838": {
      "name": "AIA_Extraction_GetFieldsForModelVersionId",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_queryRecordByIdentifier\"(\n  recordType: recordType!AIA Extraction Model Version,\n  identifier: ri!modelVersionId,\n  fields: a!flatten(\n    {\n      recordType!AIA Extraction Model Version.modelVersionId,\n  \n      /* Fields */\n      recordType!AIA Extraction Model Version.fields.sectionId,\n      recordType!AIA Extraction Model Version.fields.section,\n      recordType!AIA Extraction Model Version.fields.order,\n      recordType!AIA Extraction Model Version.fields.key,\n      recordType!AIA Extraction Model Version.fields.label,\n      recordType!AIA Extraction Model Version.fields.type,\n      recordType!AIA Extraction Model Version.fields.isMultiple,\n      recordType!AIA Extraction Model Version.fields.description,\n      recordType!AIA Extraction Model Version.fields.instructions,\n      recordType!AIA Extraction Model Version.fields.extractionType,\n      recordType!AIA Extraction Model Version.fields.optionRule,\n      recordType!AIA Extraction Model Version.fields.validationRule,\n      recordType!AIA Extraction Model Version.fields.extractionRule,\n      recordType!AIA Extraction Model Version.fields.postProcessRule,\n      recordType!AIA Extraction Model Version.fields.required,\n      recordType!AIA Extraction Model Version.fields.useVision,\n      recordType!AIA Extraction Model Version.fields.isHidden,\n      recordType!AIA Extraction Model Version.fields.isNotTracked,\n      recordType!AIA Extraction Model Version.fields.useAiReview,\n  \n      /* Fields > Column */\n      recordType!AIA Extraction Model Version.fields.columns.fieldId,\n      recordType!AIA Extraction Model Version.fields.columns.label,\n      recordType!AIA Extraction Model Version.fields.columns.key,\n      recordType!AIA Extraction Model Version.fields.columns.optionRule,\n      recordType!AIA Extraction Model Version.fields.columns.validationRule,\n      recordType!AIA Extraction Model Version.fields.columns.postProcessRule,\n      recordType!AIA Extraction Model Version.fields.columns.isHidden,\n      recordType!AIA Extraction Model Version.fields.columns.isNotTracked,\n      recordType!AIA Extraction Model Version.fields.columns.type,\n      recordType!AIA Extraction Model Version.fields.columns.extractionType,\n      recordType!AIA Extraction Model Version.fields.columns.required,\n      recordType!AIA Extraction Model Version.fields.columns.description,\n      recordType!AIA Extraction Model Version.fields.columns.instructions,\n      recordType!AIA Extraction Model Version.fields.columns.accuracy,\n      a!defaultValue(ri!additionalFields, {})\n    },\n  ),\n  relatedRecordData: {\n    #\"SYSTEM_SYSRULES_relatedRecordData\"(\n      relationship: recordType!AIA Extraction Model Version.fields,\n      sort: #\"SYSTEM_SYSRULES_sortInfo\"(\n        field: recordType!AIA Extraction Model Version Field.order,\n        ascending: true\n      )\n    ),\n    #\"SYSTEM_SYSRULES_relatedRecordData\"(\n      relationship: recordType!AIA Extraction Model Version.fields,\n      sort: #\"SYSTEM_SYSRULES_sortInfo\"(\n        field: recordType!AIA Extraction Model Version Field.order,\n        ascending: true\n      )\n    )\n  }\n)[recordType!AIA Extraction Model Version.fields]"
    },
    "_a-0000ee66-4fc0-8000-9baa-011c48011c48_43003": {
      "name": "AIA_ENUM_FieldSchemas",
      "type": "Expression Rule",
      "sail_code": "{\n  a!map(\n    name: cons!AIA_SCHEMA_MODE_PLAIN,\n    fields: {}\n  ),\n  a!map(\n    name: cons!AIA_SCHEMA_MODE_SPAN,\n    fields: {\n      a!map(\n        key: \"value\",\n        useFormat: true\n      ),\n      a!map(\n        key: \"spanId\",\n        required: false,\n        type: \"string\"\n      )\n    }\n  ),\n  a!map(\n    name: cons!AIA_PROMPT_MODE_CALCULATED,\n    fields: {\n      a!map(\n        key: \"value\",\n        useFormat: true\n      ),\n      a!map(\n        key: \"spanId\",\n        description: \"spanIds from all of the values that were used to derive the result. Return null if the values did not have spanId.\",\n        required: false,\n        type: \"string\"\n      ),\n      a!map(\n        key: \"reasoning\",\n        required: true,\n        type: \"string\"\n      )\n    }\n  ),\n  a!map(\n    name: cons!AIA_SCHEMA_MODE_AI_REVIEW,\n    fields: {\n      a!map(\n        key: \"extractedValue\",\n        required: false,\n        useFormat: true\n      ),\n      a!map(\n        key: \"suggestedValue\",\n        required: false,\n        useFormat: true\n      ),\n      a!map(\n        key: \"isCorrect\",\n        required: true,\n        type: \"boolean\"\n      ),\n      a!map(\n        key: \"reasoning\",\n        required: true,\n        type: \"string\"\n      )\n    }\n  )\n}"
    },
    "_a-0000ec2d-5396-8000-9bdc-011c48011c48_40839": {
      "name": "AIA_Test_GetLatestExtractionInstance",
      "type": "Expression Rule",
      "sail_code": "rule!AIA_Extraction_GetInstanceById(\n  identifier: #\"SYSTEM_SYSRULES_queryRecordType_v3\"(\n    recordType: recordType!AIA Extraction Instance,\n    pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n      startIndex: 1,\n      batchSize: 1,\n      sort: {\n        #\"SYSTEM_SYSRULES_sortInfo\"(\n          field: recordType!AIA Extraction Instance.id\n        )\n      }\n    )\n  ).data[recordType!AIA Extraction Instance.id],\n  additionalFields: {\n    recordType!AIA Extraction Instance.instanceUuid,\n    recordType!AIA Extraction Instance.modelVersion.versionId,\n    recordType!AIA Extraction Instance.modelVersion.modelId,\n    recordType!AIA Extraction Instance.modelVersion.uuid,\n    recordType!AIA Extraction Instance.modelVersion.extractionModel.key,\n    recordType!AIA Extraction Instance.documentFolderId,\n    recordType!AIA Extraction Instance.fieldCount,\n    recordType!AIA Extraction Instance.sections,\n    recordType!AIA Extraction Instance.boundingBoxes,\n    recordType!AIA Extraction Instance.responseDocumentId,\n    recordType!AIA Extraction Instance.sourceDocumentId\n  }\n)"
    },
    "_a-0000ec2d-5396-8000-9bdc-011c48011c48_43077": {
      "name": "AIA_Extraction_GetInstanceById",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_queryRecordByIdentifier\"(\n  recordType: recordType!AIA Extraction Instance,\n  identifier: ri!identifier,\n  fields: a!flatten(\n    {\n      /* Extraction Instance */\n      recordType!AIA Extraction Instance.modelVersionId,\n      recordType!AIA Extraction Instance.documentId,\n      recordType!AIA Extraction Instance.statusId,\n      recordType!AIA Extraction Instance.hasBoundingBoxes,\n      recordType!AIA Extraction Instance.boundingBoxesDocumentId,\n      recordType!AIA Extraction Instance.validationErrors,\n      recordType!AIA Extraction Instance.accuracy,\n      recordType!AIA Extraction Instance.precision,\n      recordType!AIA Extraction Instance.f1,\n      recordType!AIA Extraction Instance.recall,\n      recordType!AIA Extraction Instance.createdOn,\n      /* Extraction Fields */\n      recordType!AIA Extraction Instance.fields.modelVersionFieldId,\n      recordType!AIA Extraction Instance.fields.extractedValue,\n      recordType!AIA Extraction Instance.fields.overrideValue,\n      recordType!AIA Extraction Instance.fields.overrideNull,\n      recordType!AIA Extraction Instance.fields.boundingBox,\n      recordType!AIA Extraction Instance.fields.confidence,\n      /* Extraction Fields > Rows */\n      recordType!AIA Extraction Instance.fields.rows.overrideValue,\n      recordType!AIA Extraction Instance.fields.rows.boundingBox,\n      /* Extraction Fields > Rows > Cells */\n      recordType!AIA Extraction Instance.fields.rows.cells.modelVersionFieldId,\n      recordType!AIA Extraction Instance.fields.rows.cells.extractedValue,\n      recordType!AIA Extraction Instance.fields.rows.cells.overrideValue,\n      recordType!AIA Extraction Instance.fields.rows.cells.overrideNull,\n      recordType!AIA Extraction Instance.fields.rows.cells.confidence,\n      /* Extraction Fields > Model Field */\n      recordType!AIA Extraction Instance.fields.modelVersionField.key,\n      recordType!AIA Extraction Instance.fields.modelVersionField.columns.key,\n      /* Extraction Fields > Rows > Cells > Column */\n      recordType!AIA Extraction Instance.fields.rows.cells.column.key,\n      a!defaultValue(ri!additionalFields, {})\n    },\n    \n  )\n)"
    },
    "_a-0000ecea-6c5f-8000-9c4b-011c48011c48_182408": {
      "name": "AIA_CalculatedFieldPrompt",
      "type": "Expression Rule",
      "sail_code": "=\"You are an AI assistant and an expert at calculating new values based on provided input data. Your task is to use the data in the document snippet to calculate the values for a specific list of fields.\n\n------------\n\n## Output Format\n\nYour final output must be a single **JSON object** that strictly adheres to the schema below. The root object will contain a key for each field you are asked to calculate.\n\n```json\n\" & rule!AIA_Extraction_CreateJsonSchema(\n  ExtractionModelVersion: ri!ModelVersion,\n  mode: cons!AIA_PROMPT_MODE_CALCULATED,\n  returnJson: true\n) & \"\n```\n\n------------\n\n## Instructions\n\n-   **Only use the data found within the section `[Input Data]` to derive your calculations. Do not infer or use outside knowledge.\"\n"
    },
    "1dc1ab54-b05f-44f8-9cdc-c11198320666": {
      "name": "AIA_Extraction_MergeResults",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!fields: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion],\n      if(\n        or(\n          and(\n            ri!type = cons!AIA_PROMPT_OPERATION_MODE_MULTIMODAL,\n            a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Field.useVision]),\n            fv!item[recordType!AIA Extraction Model Version Field.useVision] = true\n          ),\n          fv!item[recordType!AIA Extraction Model Version Field.extractionType] = ri!type\n        ),\n        fv!item,\n        null\n      )\n    )\n  ),\n  local!objectMap: rule!AIA_ExtractJson(\n    json: ri!object,\n    returnList: false\n  ),\n  local!sourceMap: a!defaultValue(\n    ri!sourceMap,\n    rule!AIA_ExtractJson(\n      json: ri!source,\n      returnList: false\n    )\n  ),\n  local!validSourceMap: reduce(\n    #\"urn:appian:function:v1:a:update\",\n    a!map(),\n    merge(\n      local!fields[recordType!AIA Extraction Model Version Field.key],\n      #\"SYSTEM_SYSRULES_forEach\"(\n        local!fields,\n        a!defaultValue(\n          index(\n            local!sourceMap,\n            fv!item[recordType!AIA Extraction Model Version Field.key],\n            null\n          ),\n          index(\n            local!objectMap,\n            fv!item[recordType!AIA Extraction Model Version Field.key],\n            null\n          ),\n        )\n      )\n    )\n  ),\n  rule!AIA_ToJson(\n    rule!SHRD_Merge(\n      object: local!objectMap,\n      source: local!validSourceMap\n    )\n  )\n)"
    },
    "_a-0000ee3e-060c-8000-9bb8-011c48011c48_204932": {
      "name": "AIA_Extraction_CreateJsonSchema",
      "type": "Expression Rule",
      "sail_code": "\na!localVariables(\n  local!modelFields: #\"SYSTEM_SYSRULES_fromJson_v1\"(#\"SYSTEM_SYSRULES_toJson_v1\"(\n    a!defaultValue(\n      ri!fields,\n      filter(\n        rule!AIA_Extraction_DisplayPromptField(\n          field: _,\n          mode: ri!mode,\n          operation: ri!operation\n        ),\n        ri!ExtractionModelVersion[recordType!AIA Extraction Model Version.fields]\n      )\n    )\n  )),\n  if(\n    a!isNotNullOrEmpty(local!modelFields),\n    a!localVariables(\n      local!fields: reduce(\n        #\"urn:appian:function:v1:a:update\",\n        a!map(),\n        merge(\n          local!modelFields.key,\n          #\"SYSTEM_SYSRULES_forEach\"(\n            local!modelFields,\n            rule!AIA_FieldJsonSchema(\n              item: fv!item,\n              mode: ri!mode,\n              operation: ri!operation,\n              includeArrays: a!defaultValue(ri!includeArrays, true)\n            )\n          )\n        )\n      ),\n      local!map: #\"SYSTEM_SYSRULES_fromJson_v1\"(\n        #\"SYSTEM_SYSRULES_toJson_v1\"(\n          value: a!map(\n            \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n            type: \"object\",\n            properties: local!fields,\n            required: reject(\n              fn!isnull,\n              index(\n                local!modelFields.key,\n                where(local!modelFields.required)\n              )\n            )\n          ),\n          removeNullOrEmptyFields: true\n        )\n      ),\n      if(\n        ri!returnJson,\n        prettyprintjson(#\"SYSTEM_SYSRULES_toJson_v1\"(local!map)),\n        local!map\n      )\n    ),\n    null\n  )\n)"
    },
    "_a-0000ec44-cb49-8000-9be6-011c48011c48_79495": {
      "name": "AIA_Extraction_GetFieldOptions",
      "type": "Expression Rule",
      "sail_code": "if(\n  a!isNotNullOrEmpty(\n    ri!ModelVersionField[recordType!AIA Extraction Model Version Field.optionRule]\n  ),\n  a!localVariables(\n    local!optionsRule: a!refreshVariable(\n      refreshAlways: true,\n      value: getrulereferencebyname(\n        ri!ModelVersionField[recordType!AIA Extraction Model Version Field.optionRule]\n      )\n    ),\n    a!map(options: local!optionsRule())\n  ),\n  null\n)"
    },
    "_a-0000ec2d-5396-8000-9bdc-011c48011c48_40909": {
      "name": "AIA_ExtractJson",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!firstTry: rule!AIA_ExtractJsonInner(\n    json: ri!json\n  ),\n  local!result: if(\n    a!isNotNullOrEmpty(local!firstTry),\n    local!firstTry,\n    a!localVariables(\n      local!secondTry: rule!AIA_ExtractJsonInner(\n        json: index(split(ri!json, \"Appian's private AI\"), 1, null),\n      ),\n      if(\n        a!isNotNullOrEmpty(local!secondTry),\n        local!secondTry,\n        a!localVariables(\n          local!thirdTry: rule!AIA_ExtractJsonInner(\n            json: index(split(ri!json, \"Appian's private AI\"), 2, null),\n          ),\n          if(\n            a!isNotNullOrEmpty(local!thirdTry),\n            local!thirdTry,\n            a!localVariables(\n              local!forthTry: rule!AIA_ExtractJsonInner(\n                json: index(split(ri!json, \"<output>\"), 1, null),\n              ),\n              if(\n                a!isNotNullOrEmpty(local!forthTry),\n                local!forthTry,\n                a!localVariables(\n                  local!fifthTry: rule!AIA_ExtractJsonInner(\n                    json: index(split(ri!json, \"</entities>\"), 1, null),\n                  ),\n                  local!fifthTry\n                )\n              )\n            )\n          )\n        )\n      )\n    )\n  ),\n  local!finalResult: if(\n    a!isNullOrEmpty(local!result),\n    null,\n    if(\n      a!defaultValue(ri!returnList, true),\n      local!result,\n      if(\n        rule!SHRD_IsList(local!result),\n        null,\n        local!result\n      )\n    )\n  ),\n  /* Handle scenario where the result comes back as properties of a $schema */\n  if(\n    or(\n      a!defaultValue(ri!returnList, true),\n      a!isNullOrEmpty(local!finalResult),\n      not(contains(\n        a!keys(local!finalResult),\n        \"$schema\"\n      ))\n    ),\n    local!finalResult,\n    local!finalResult.properties\n  )\n)"
    },
    "_a-0000ec36-59aa-8000-9be0-011c48011c48_53600": {
      "name": "AIA_Test_GetLatestExtractionModelVersion",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!modelVersion: a!refreshVariable(\n    value: rule!AIA_Extraction_GetModelVersionById(\n      identifier: index(\n        #\"SYSTEM_SYSRULES_queryRecordType_v4\"(\n          recordType: recordType!AIA Extraction Model Version,\n          fields: {\n            recordType!AIA Extraction Model Version.modelVersionId\n          },\n          pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n            startIndex: 1,\n            batchSize: 1,\n            sort: {\n              #\"SYSTEM_SYSRULES_sortInfo\"(\n                field: recordType!AIA Extraction Model Version.modelVersionId\n              )\n            }\n          )\n        ).data[recordType!AIA Extraction Model Version.modelVersionId],\n        1,\n        null\n      )\n    ),\n    refreshAlways: true\n  ),\n  local!modelVersion\n)"
    },
    "_a-0000ee21-294f-8000-9bb6-011c48011c48_159825": {
      "name": "AIA_DocIsPdf",
      "type": "Expression Rule",
      "sail_code": "rule!AIA_IsDocumentExtension(\n  document: ri!document,\n  extensions: {\"pdf\"}\n)"
    },
    "_a-0000ecea-6c5f-8000-9c4b-011c48011c48_194584": {
      "name": "AIA_Extraction_RunRules",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!fields: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion],\n      if(\n        fv!item[recordType!AIA Extraction Model Version Field.extractionType] = cons!AIA_EXTRACTION_TYPES[3],\n        fv!item,\n        null\n      )\n    )\n  ),\n  if(\n    a!isNullOrEmpty(local!fields),\n    a!map(),\n    reduce(\n      #\"urn:appian:function:v1:a:update\",\n      a!map(),\n      merge(\n        local!fields[recordType!AIA Extraction Model Version Field.key],\n        #\"SYSTEM_SYSRULES_forEach\"(\n          local!fields,\n          a!localVariables(\n            local!extractionRule: a!refreshVariable(\n              value: getrulereferencebyname(fv!item[recordType!AIA Extraction Model Version Field.extractionRule]),\n              refreshAlways: false\n            ),\n            local!extractionRule(\n              input: a!map(\n                ExtractionInstance: ri!ExtractionInstance\n              )\n            )\n          ),\n        )\n      )\n    )\n  )\n)"
    },
    "_a-0000ee21-294f-8000-9bb6-011c48011c48_176683": {
      "name": "AIA_Extraction_AddTokens",
      "type": "Expression Rule",
      "sail_code": "#\"urn:appian:function:v1:a:update\"(\n  data: ri!ExtractionInstance,\n  index: {\n    recordType!AIA Extraction Instance.inputTokens,\n    recordType!AIA Extraction Instance.outputTokens\n  },\n  value: {\n    a!defaultValue(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.inputTokens],\n      0\n    ) + a!defaultValue(ri!inputTokens, 0),\n    a!defaultValue(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.outputTokens],\n      0\n    ) + a!defaultValue(ri!outputTokens, 0)\n  }\n)"
    },
    "_a-0000ee3e-060c-8000-9bb8-011c48011c48_194081": {
      "name": "AIA_Extraction_GetInputDocuments",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!document: a!defaultValue(\n    index(#\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n      recordType: recordType!AIA Extraction Bounding Boxes,\n      filters: #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!AIA Extraction Bounding Boxes.extractionId,\n        operator: \"=\",\n        value: ri!ExtractionInstance[recordType!AIA Extraction Instance.id]\n      ),\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(1,1)\n    ).data[recordType!AIA Extraction Bounding Boxes.inputDocumentId], 1, null),\n    index(ri!ExtractionInstance[recordType!AIA Extraction Instance.boundingBoxes.inputDocumentId], 1, null)\n  ),\n  if(\n    a!isNotNullOrEmpty(local!document),\n    todocument(local!document),\n    null\n  )\n)"
    },
    "_a-0000e79d-2c73-8000-97b9-01ef9001ef90_71638": {
      "name": "SHRD_Update",
      "type": "Expression Rule",
      "sail_code": "/* If the data[index] is a dictionary and so is the value, then recurse */\n/* Else overwrite */\n\nif(\n  and(\n    runtimetypeof(ri!data[ri!index]) = 'type!{http://www.appian.com/ae/types/2009}Dictionary',\n    runtimetypeof(ri!value) = 'type!{http://www.appian.com/ae/types/2009}Dictionary'\n  ),\n  a!localVariables(\n    local!mergedValue: a!refreshVariable(\n      refreshAlways: true,\n      value: rule!SHRD_MergeInner(\n        object: ri!data[ri!index],\n        source: ri!value\n      )\n    ),\n    #\"urn:appian:function:v1:a:update\"(\n      ri!data,\n      ri!index,\n      local!mergedValue\n    )\n  ),\n  if(\n    and(\n      runtimetypeof(ri!data[ri!index]) = 'type!{http://www.appian.com/ae/types/2009}Dictionary?list',\n      runtimetypeof(ri!value) = 'type!{http://www.appian.com/ae/types/2009}Dictionary?list',\n      length(a!flatten(ri!data[ri!index])) = length(a!flatten(ri!value))\n    ),\n    a!localVariables(\n      local!mergedValue: a!refreshVariable(\n        refreshAlways: true,\n        value: apply(\n          rule!SHRD_MergeInner(\n            object: _,\n            source: _\n          ),\n          merge(\n            a!flatten(ri!data[ri!index]),\n            ri!value  \n          )\n        )\n      ),\n      #\"urn:appian:function:v1:a:update\"(\n        ri!data,\n        ri!index,\n        local!mergedValue\n      )\n    ),\n    #\"urn:appian:function:v1:a:update\"(\n      ri!data,\n      ri!index,\n      if(\n        isnull(ri!value),\n        cast('type!{http://www.appian.com/ae/types/2009}Dictionary?list', null),\n        ri!value\n      )\n    )\n  )\n)"
    },
    "_a-0000ed57-1773-8000-9c7e-011c48011c48_328735": {
      "name": "AIA_Extraction_VisionSpanPrompt",
      "type": "Expression Rule",
      "sail_code": "=\"You are an AI assistant and an expert at document analysis. Your task is to locate the exact position of previously extracted data within a source document and enrich the data with this location information.\n\n------------\n\n## Output Format\n\nYour final output must be a single **JSON object** representing the original data, with each field enriched to include its location. The schema for an enriched field is as follows:\n\n```json\n\" & rule!AIA_Extraction_CreateJsonSchema(\n  ExtractionModelVersion: ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion],\n  mode: cons!AIA_SCHEMA_MODE_SPAN,\n  operation: cons!AIA_PROMPT_OPERATION_MODE_MULTIMODAL,\n  returnJson: true\n) & \"\n```\n\n------------\n\n## Instructions\n\n-   For each data element in `<extractedData>`, identify the corresponding `spanId`(s) from the `<document>` where the data was found.\n-   Enrich the input JSON by adding a `spanId` key to each element. The value should be a single span ID or a list of IDs.\n-   For tables, carefully review the document to find and add any rows that were missed during the initial extraction.\n-   Your output should be the complete, enriched JSON object.\""
    },
    "_a-0000e79d-2c73-8000-97b9-01ef9001ef90_71617": {
      "name": "SHRD_Merge",
      "type": "Expression Rule",
      "sail_code": "if(\n  a!isNullOrEmpty(ri!object),\n  ri!source,\n  if(\n    a!isNullOrEmpty(ri!source),\n    null,\n    rule!SHRD_MergeInner(\n      object: if(a!isNullOrEmpty(ri!object ), null, #\"SYSTEM_SYSRULES_fromJson_v1\"(#\"SYSTEM_SYSRULES_toJson_v1\"(ri!object))),\n      source: if(a!isNullOrEmpty(ri!source), null, #\"SYSTEM_SYSRULES_fromJson_v1\"(#\"SYSTEM_SYSRULES_toJson_v1\"(ri!source)))\n    )\n  )\n)"
    },
    "_a-0000ee3d-1f5c-8000-9ba4-011c48011c48_14361": {
      "name": "AIA_ConvertIsoToDate",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_fromJson_v1\"(\n  \"{\"\"a\"\":\"\"\" & ri!value & \"\"\"}\"\n).a"
    },
    "_a-0000ee21-294f-8000-9bb6-011c48011c48_158769": {
      "name": "AIA_Extraction_GetBoundingBoxesForExtraction",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n  recordType: recordType!AIA Extraction Bounding Boxes,\n  filters: #\"SYSTEM_SYSRULES_queryFilter\"(\n    field: recordType!AIA Extraction Bounding Boxes.extractionId,\n    operator: \"=\",\n    value: ri!ExtractionInstance[recordType!AIA Extraction Instance.id]\n  ),\n  pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n    startIndex: 1,\n    batchSize: 1000,\n    sort: #\"SYSTEM_SYSRULES_sortInfo\"(\n      field: recordType!AIA Extraction Bounding Boxes.minPage,\n      ascending: true\n    )\n  )\n).data"
    },
    "_a-0000ee3e-060c-8000-9bb8-011c48011c48_203441": {
      "name": "SHRD_ReadDocumentContent",
      "type": "Expression Rule",
      "sail_code": "/*readdocumentcontent(ri!document)*/\n\nqueryfile(\n  ri!document,\n  \"TEXT\",\n  now()\n).result"
    }
  }
}