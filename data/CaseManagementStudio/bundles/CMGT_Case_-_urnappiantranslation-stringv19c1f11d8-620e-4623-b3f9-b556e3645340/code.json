{
  "_metadata": {
    "bundle_id": "CMGT_Case_-_urnappiantranslation-stringv19c1f11d8-620e-4623-b3f9-b556e3645340"
  },
  "objects": {
    "_a-0000e98b-cfe0-8000-9ba5-011c48011c48_22352": {
      "name": "CMGT_UTIL_QueryRecord",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  /*Chosen return type*/\n  local!returnType: a!defaultValue(ri!returnType, \"OBJECT_ARRAY\"),\n  /*Determine the query parameters to use by the return type*/\n  local!queryParams: a!match(\n    value: local!returnType,\n    equals: \"OBJECT_ARRAY\",\n    then: a!map(\n      castToType: if(\n        a!isNullOrEmpty(ri!groupByFields),\n        #\"urn:appian:function:v1:a:listtype?okey=a!listType\"(ri!recordType),\n        'type!{http://www.appian.com/ae/types/2009}Map?list'\n      ),\n      fetchTotalCount: false,\n      isArray: true,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: 1,\n        batchSize: a!defaultValue(\n          ri!pagingInfo.batchSize,\n          cons!CMGT_INT_BATCH_SIZE_MAX\n        ),\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"SINGLE_OBJECT\",\n    then: a!map(\n      castToType: if(\n        a!isNullOrEmpty(ri!groupByFields),\n        ri!recordType,\n        'type!{http://www.appian.com/ae/types/2009}Map'\n      ),\n      fetchTotalCount: false,\n      isArray: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: 1,\n        batchSize: 1,\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"DATA_SUBSET\",\n    then: a!map(\n      castToType: 'type!{http://www.appian.com/ae/types/2009}DataSubset',\n      fetchTotalCount: true,\n      isArray: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n        startIndex: a!defaultValue(ri!pagingInfo.startIndex, 1),\n        batchSize: a!defaultValue(\n          ri!pagingInfo.batchSize,\n          cons!CMGT_INT_BATCH_SIZE_MAX\n        ),\n        sort: { ri!pagingInfo.sort, ri!sort }\n      )\n    ),\n    equals: \"TOTAL_COUNT\",\n    then: a!map(\n      castToType: 'type!{http://www.appian.com/ae/types/2009}Integer',\n      fetchTotalCount: true,\n      isArray: false,\n      pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(startIndex: 1, batchSize: 0)\n    ),\n    default: fn!error(\n      \"Invalid returnType, must be one of: OBJECT_ARRAY, SINGLE_OBJECT, DATA_SUBSET, TOTAL_COUNT\"\n    )\n  ),\n  if(\n    /*Early exit for skip execution*/\n    ri!executeWhen = false,\n    cast(\n      local!queryParams.castToType,\n      if(local!queryParams.isArray, {}, null)\n    ),\n    a!localVariables(\n      /*Run the query*/\n      local!queryResult: a!refreshVariable(\n        value: #\"SYSTEM_SYSRULES_queryRecordType_v2\"(\n          recordType: ri!recordType,\n          fields: if(\n            a!isNullOrEmpty(ri!groupByFields),\n            reject(\n              a!isNullOrEmpty,\n              a!flatten(\n                {\n                  ri!fields,\n                  index(ri!relatedRecordData, \"relationship\", {})\n                }\n              )\n            ),\n            #\"SYSTEM_SYSRULES_aggregationFields\"(\n              groupings: #\"SYSTEM_SYSRULES_forEach\"(\n                items: ri!groupByFields,\n                expression: #\"SYSTEM_SYSRULES_grouping\"(field: fv!item, alias: tostring(fv!item))\n              ),\n              measures: #\"SYSTEM_SYSRULES_measure\"(\n                field: ri!groupByFields[1],\n                function: \"COUNT\",\n                alias: \"count\"\n              )\n            )\n          ),\n          filters: #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n            operator: \"AND\",\n            ignoreFiltersWithEmptyValues: true,\n            logicalExpressions: {\n              ri!logicalExpressions,\n              if(\n                and(\n                  a!isNotNullOrEmpty(ri!searchFields),\n                  a!isNotNullOrEmpty(ri!searchTerm)\n                ),\n                #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n                  operator: \"AND\",\n                  logicalExpressions: #\"SYSTEM_SYSRULES_forEach\"(\n                    items: split(trim(ri!searchTerm), \" \"),\n                    expression: a!localVariables(\n                      local!splitSearchTerm: fv!item,\n                      #\"SYSTEM_SYSRULES_queryLogicalExpression\"(\n                        operator: \"OR\",\n                        filters: #\"SYSTEM_SYSRULES_forEach\"(\n                          items: ri!searchFields,\n                          expression: #\"SYSTEM_SYSRULES_queryFilter\"(\n                            field: fv!item,\n                            operator: \"includes\",\n                            value: local!splitSearchTerm\n                          )\n                        )\n                      )\n                    )\n                  )\n                ),\n                {}\n              )\n            },\n            filters: ri!filters\n          ),\n          pagingInfo: if(\n            a!isNullOrEmpty(ri!groupByFields),\n            local!queryParams.pagingInfo,\n            #\"urn:appian:function:v1:a:update\"(\n              local!queryParams.pagingInfo,\n              \"sort\",\n              null\n            )\n          ),\n          fetchTotalCount: local!queryParams.fetchTotalCount,\n          relatedRecordData: if(\n            a!isNullOrEmpty(ri!groupByFields),\n            ri!relatedRecordData,\n            {}\n          )\n        ),\n        refreshOnVarChange: ri!triggerRefresh,\n        refreshAfter: { \"RECORD_ACTION\" }\n      ),\n      /*Format the output*/\n      local!output: a!match(\n        value: local!returnType,\n        equals: \"OBJECT_ARRAY\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult.data\n        ),\n        equals: \"SINGLE_OBJECT\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult.data\n        ),\n        equals: \"DATA_SUBSET\",\n        then: cast(\n          local!queryParams.castToType,\n          local!queryResult\n        ),\n        equals: \"TOTAL_COUNT\",\n        then: local!queryResult.totalCount,\n        default: null\n      ),\n      local!output\n    )\n  )\n)"
    },
    "0009ec2f-2bbb-8000-1585-7f0000014e7a": {
      "name": "CMGT_Portal_Case_UpdateContact",
      "type": "Process Model",
      "sail_code": "// Input: ?\n=pv!eventHistory\n\n// Input: ?\n=recordType!CMGT_EventHistory_Case\n\n// Output: ?\nrule!CMGT_Portal_UpdateContact_SetEvents(\n  caseContacts: pv!caseContacts,\n  initiator: pp!initiator\n)\n\n// Output: ?\nrule!CMGT_Portal_CaseContact_SetMetaData(\n  portalCaseContacts:pv!caseContacts,\n  initiator:pp!initiator\n)\n\n// Input: ?\n=pv!caseContacts\n\n// Input: ?\n=recordType!CMGT_Portal_CaseContact"
    },
    "_a-0000ebf3-df94-8000-9cc3-011c48011c48_2378423": {
      "name": "CMGT_QR_GetPortalCaseContact",
      "type": "Expression Rule",
      "sail_code": "rule!CMGT_UTIL_QueryRecord(\n  recordType: recordType!CMGT_Portal_CaseContact,\n  returnType: ri!returnType,\n  executeWhen: ri!executeWhen,\n  triggerRefresh: ri!triggerRefresh,\n  filters: {\n    ri!additionalFilters,\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.portalCaseContactId,\n      operator: \"in\",\n      value: ri!portalCaseContactId\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.caseId,\n      operator: \"=\",\n      value: ri!caseId\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.firstName,\n      operator: \"=\",\n      value: ri!firstName\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.lastName,\n      operator: \"=\",\n      value: ri!lastName\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_Portal_CaseContact.isActive,\n      operator: \"=\",\n      value: ri!isActive\n    )\n  },\n  fields: ri!fields,\n  pagingInfo: ri!pagingInfo,\n  sort: a!defaultValue(\n    value: ri!sort,\n    default: #\"SYSTEM_SYSRULES_sortInfo\"(\n      field: recordType!CMGT_Portal_CaseContact.portalCaseContactId,\n      ascending: true\n    )\n  ),\n  relatedRecordData: ri!relatedRecordData,\n  logicalExpressions: ri!additionalLogicalExpression,\n  groupByFields: ri!groupByFields,\n  searchTerm: ri!searchTerm,\n  searchFields: ri!searchFields\n)\n"
    },
    "_a-0000e9ae-873e-8000-9baf-011c48011c48_97439": {
      "name": "CMGT_QR_GetUser",
      "type": "Expression Rule",
      "sail_code": "rule!CMGT_UTIL_QueryRecord(\n  recordType: #\"urn:appian:record-type:v1:SYSTEM_RECORD_TYPE_USER\",\n  returnType: ri!returnType,\n  executeWhen: ri!executeWhen,\n  filters: {\n    ri!additionalFilters,\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: #\"urn:appian:record-field:v1:SYSTEM_RECORD_TYPE_USER/SYSTEM_RECORD_TYPE_USER_FIELD_username\",\n      operator: \"in\",\n      value: ri!username\n    )\n  },\n  fields: ri!fields,\n  relatedRecordData: ri!relatedRecordData,\n  pagingInfo: ri!pagingInfo,\n  sort: ri!sort,\n  triggerRefresh: ri!triggerRefresh,\n  logicalExpressions: ri!additionalLogicalExpression,\n  groupByFields: ri!groupByFields,\n  searchTerm: ri!searchTerm,\n  searchFields: ri!searchFields\n)"
    },
    "_a-0000ec2b-3e9f-8000-9cd4-011c48011c48_2728613": {
      "name": "CMGT_Portal_Case_RecordAction_UpdateContact",
      "type": "Interface",
      "sail_code": "#\"SYSTEM_SYSRULES_formLayout_v1\"(\n  label: #\"urn:appian:translation-string:v1:9c1f11d8-620e-4623-b3f9-b556e3645340\",\n  contents: {\n    #\"SYSTEM_SYSRULES_sectionLayout_v1\"(\n      label: \"\",\n      contents: {\n        #\"SYSTEM_SYSRULES_columnsLayout\"(\n          columns: {\n            #\"SYSTEM_SYSRULES_columnLayout\"(\n              contents: {\n                #\"SYSTEM_SYSRULES_textField\"(\n                  label: #\"urn:appian:translation-string:v1:08fe6b07-b6f3-44a9-8d43-9a87b4c5ab1f\",\n                  labelPosition: \"ABOVE\",\n                  value: ri!caseContact[recordType!CMGT_Portal_CaseContact.firstName],\n                  saveInto: a!save(\n                    ri!caseContact[recordType!CMGT_Portal_CaseContact.firstName],\n                    trim(save!value)\n                  ),\n                  refreshAfter: \"UNFOCUS\",\n                  characterLimit: cons!CMGT_INT_MAX_CHAR_LIMIT_MEDIUM,\n                  showCharacterCount: false,\n                  required: true,\n                  validations: {}\n                ),\n                #\"SYSTEM_SYSRULES_textField\"(\n                  label: #\"urn:appian:translation-string:v1:41327863-bf56-4365-9a84-273ead0ea3bc\",\n                  labelPosition: \"ABOVE\",\n                  value: ri!caseContact[recordType!CMGT_Portal_CaseContact.email],\n                  saveInto: a!save(\n                    ri!caseContact[recordType!CMGT_Portal_CaseContact.email],\n                    trim(save!value)\n                  ),\n                  refreshAfter: \"UNFOCUS\",\n                  required: true,\n                  validations: {\n                    rule!CMGT_UTIL_ValidateEmail(\n                      ri!caseContact[recordType!CMGT_Portal_CaseContact.email]\n                    )\n                  }\n                )\n              }\n            ),\n            #\"SYSTEM_SYSRULES_columnLayout\"(\n              contents: {\n                #\"SYSTEM_SYSRULES_textField\"(\n                  label: #\"urn:appian:translation-string:v1:bd01e818-d19e-4004-b4ca-1cfcb7e93ff5\",\n                  labelPosition: \"ABOVE\",\n                  value: ri!caseContact[recordType!CMGT_Portal_CaseContact.lastName],\n                  saveInto: a!save(\n                    ri!caseContact[recordType!CMGT_Portal_CaseContact.lastName],\n                    trim(save!value)\n                  ),\n                  refreshAfter: \"UNFOCUS\",\n                  characterLimit: cons!CMGT_INT_MAX_CHAR_LIMIT_MEDIUM,\n                  showCharacterCount: false,\n                  required: true,\n                  validations: {}\n                )\n              }\n            )\n          }\n        )\n      }\n    )\n  },\n  buttons: #\"SYSTEM_SYSRULES_ButtonLayout\"(\n    primaryButtons: {\n      #\"SYSTEM_SYSRULES_buttonWidget_v1\"(\n        label: #\"urn:appian:translation-string:v1:ed6aeca3-cea3-4a07-af07-ca5cfbc4de81\",\n        submit: true,\n        style: \"SOLID\"\n      )\n    },\n    secondaryButtons: {\n      #\"SYSTEM_SYSRULES_buttonWidget_v1\"(\n        label: #\"urn:appian:translation-string:v1:22002bd7-608c-4514-9521-3216df22c0c2\",\n        saveInto: a!save(ri!caseContact, null),\n        submit: true,\n        style: \"OUTLINE\",\n        validate: false\n      )\n    }\n  )\n)"
    },
    "_a-0000e99c-1217-8000-9ba9-011c48011c48_52143": {
      "name": "CMGT_UTIL_ValidateEmail",
      "type": "Expression Rule",
      "sail_code": "/*  Email Address Validation for Appian 7+  */\n/*  Allows the 'name' to contain letters, numbers, plus period and special characters: _ - + ' & %  */\n/*  Allows the 'domain' to contain only letters, numbers, period and dash.  */\n/*When the case is created from the portal and if that email is used for account creation, only then below validation should be displayed in portal else existing validation should be displayed\nPlease enter a valid email address. Email address may only contain letters, numbers, and the following special characters: @ . _ - */\na!localVariables(\n  local!validationMessage: #\"urn:appian:translation-string:v1:b90bb29b-f3c4-4405-a032-741e69f0ed63\",\n  if(\n    a!isNullOrEmpty(ri!textInput),\n    null,\n    a!localVariables(\n      local!localPart: index(split(trim(ri!textInput), \"@\"), 1, {}),\n      local!domainPart: index(split(trim(ri!textInput), \"@\"), 2, {}),\n      {\n        if(\n          or(\n            len(trim(ri!textInput)) > 255,\n            length(split(trim(ri!textInput), \" \")) > 1,\n            count(split(ri!textInput, \"@\")) <> 2\n          ),\n          local!validationMessage,\n          if(\n            or(\n              length(split(local!domainPart, \".\")) < 2,\n              contains(split(local!localPart, \".\"), \"\"),\n              contains(split(local!domainPart, \".\"), \"\"),\n            ),\n            local!validationMessage,\n            null\n          )\n        )\n      }\n    )\n  )\n)"
    },
    "_a-0000e9d3-70bf-8000-9bbd-011c48011c48_180481": {
      "name": "CMGT_UTIL_RejectBlank",
      "type": "Expression Rule",
      "sail_code": "cast(\n  runtimetypeof(a!flatten(ri!array)),\n  reject(a!isNullOrEmpty(_), a!flatten(ri!array))\n)"
    },
    "_a-0000eaab-5303-8000-9c24-011c48011c48_994738": {
      "name": "CMGT_formatEventInitiator",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!user: rule!CMGT_QR_GetUser(\n    username: ri!initiator,\n    returnType: \"SINGLE_OBJECT\"\n  ),\n  if(\n    rule!CMGT_UTIL_IsBlank(local!user),\n    ri!initiator,\n    if(\n      or(\n        local!user[#\"urn:appian:record-field:v1:SYSTEM_RECORD_TYPE_USER/SYSTEM_RECORD_TYPE_USER_FIELD_isServiceAccount\"] = true,\n        #\"urn:appian:function:v1:a:isusermemberofgroup?okey=a!isUserMemberOfGroup\"(\n          username: ri!initiator,\n          groups: cons!CMGT_GRP_SERVICE_ACCOUNTS\n        )\n      ),\n      cons!CMGT_TXT_AUTOMATED_SYSTEM,\n      ri!initiator\n    )\n  )\n)"
    },
    "_a-0000e9fa-aa45-8000-9bda-011c48011c48_293777": {
      "name": "CMGT_CaseEventHistory_Constructor",
      "type": "Expression Rule",
      "sail_code": "recordType!CMGT_EventHistory_Case(\n  recordType!CMGT_EventHistory_Case.caseId: ri!caseId,\n  recordType!CMGT_EventHistory_Case.timestamp: a!defaultValue(value: ri!timestamp, default: now()),\n  recordType!CMGT_EventHistory_Case.username: rule!CMGT_formatEventInitiator(initiator: ri!initiator),\n  recordType!CMGT_EventHistory_Case.caseEventTypeId: ri!eventTypeId,\n  recordType!CMGT_EventHistory_Case.details: if(\n    a!isNotNullOrEmpty(ri!details),\n    #\"SYSTEM_SYSRULES_toJson_v1\"(\n      value: ri!details,\n      removeNullOrEmptyFields: false\n    ),\n    null\n  )\n)"
    },
    "_a-0000ec2b-3e9f-8000-9cd4-011c48011c48_2730252": {
      "name": "CMGT_Portal_UpdateContact_SetEvents",
      "type": "Expression Rule",
      "sail_code": "a!flatten(\n  #\"SYSTEM_SYSRULES_forEach\"(\n    items: ri!caseContacts,\n    expression: a!localVariables(\n      local!oldCaseContact: rule!CMGT_QR_GetPortalCaseContact(\n        returnType: \"SINGLE_OBJECT\",\n        portalCaseContactId: fv!item[recordType!CMGT_Portal_CaseContact.portalCaseContactId],\n      ),\n      rule!CMGT_UTIL_RejectBlank(\n        if(\n          local!oldCaseContact <> fv!item,\n          rule!CMGT_CaseEventHistory_Constructor(\n            caseId: fv!item[recordType!CMGT_Portal_CaseContact.caseId],\n            initiator: ri!initiator,\n            eventTypeId: cons!CMGT_PORTAL_REFID_EVENT_TYPE_UPDATE_CASE_CONTACT,\n            timestamp: now(),\n            details: a!map(\n              firstName: tostring(\n                fv!item[recordType!CMGT_Portal_CaseContact.firstName]\n              ),\n              lastName: tostring(\n                fv!item[recordType!CMGT_Portal_CaseContact.lastName]\n              ),\n              email: tostring(\n                fv!item[recordType!CMGT_Portal_CaseContact.email]\n              )\n            )\n          ),\n          null\n        )\n      )\n    )\n  )\n)"
    },
    "_a-0000e990-c462-8000-9ba7-011c48011c48_33778": {
      "name": "CMGT_UTIL_SetRecordFields",
      "type": "Expression Rule",
      "sail_code": "/*\nFuture enhancement ideas:\n1 Parameter to skip update if the field isn't present in the object\n--- This would also apply to nested fields, as in, don't set a relationship field if the entire relationship object isn't there because it will instantiate it\n2 Parameter to overwrite based on more enhanced logic\n3 Allow list types for the `value`\n4 Allow reuse to apply setting metadata for nested relationships, but using their own set metadata rule\n--- e.g. CMGT_Entity_SetMetaData can be used in both the Case process and the individual Entity process\n*/\nif(\n  a!isNullOrEmpty(ri!record),\n  ri!record,\n  a!localVariables(\n    local!allUpdates: rule!CMGT_UTIL_RejectBlank(a!flatten(\n      {\n        ri!alwaysOverwrite,\n        ri!childRelationships,\n        #\"SYSTEM_SYSRULES_forEach\"(\n          items: ri!neverOverwrite,\n          expression: #\"urn:appian:function:v1:a:update\"(\n            fv!item,\n            \"value\",\n            /*Specifically using this instead of a!defaultValue() to account for the `{null}` value*/\n            if(\n              rule!CMGT_UTIL_IsBlank(ri!record[fv!item.field]),\n              fv!item.value,\n              ri!record[fv!item.field]\n            )\n          )\n        )\n      }\n    )),\n    local!onlyChangedUpdates: a!flatten(\n      #\"SYSTEM_SYSRULES_forEach\"(\n        items: local!allUpdates,\n        expression: if(\n          or(\n            tostring(ri!record[fv!item.field]) = tostring(fv!item.value),\n            toboolean(fv!item.applyWhen) = false\n          ),\n          {},\n          fv!item\n        )\n      )\n    ),\n    if(\n      a!isNullOrEmpty(local!onlyChangedUpdates),\n      ri!record,\n      #\"urn:appian:function:v1:a:update\"(\n        data: ri!record,\n        index: local!onlyChangedUpdates.field,\n        value: local!onlyChangedUpdates.value\n      )\n    )\n  )\n)"
    },
    "_a-0000ebe1-6999-8000-9cbe-011c48011c48_2312376": {
      "name": "CMGT_Portal_CaseContact_SetMetaData",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_forEach\"(\n  items: ri!portalCaseContacts,\n  expression: rule!CMGT_UTIL_SetRecordFields(\n    record: fv!item,\n    /*Always set these fields with each update*/\n    alwaysOverwrite: {\n      a!map(\n        field: recordType!CMGT_Portal_CaseContact.modifiedBy,\n        value: ri!initiator\n      ),\n      a!map(\n        field: recordType!CMGT_Portal_CaseContact.modifiedOn,\n        value: now()\n      )\n    },\n    /*Only modify these fields if they are currently null*/\n    neverOverwrite: {\n      a!map(\n        field: recordType!CMGT_Portal_CaseContact.createdBy,\n        value: ri!initiator\n      ),\n      a!map(\n        field: recordType!CMGT_Portal_CaseContact.createdOn,\n        value: now()\n      ),\n      a!map(\n        field: recordType!CMGT_Portal_CaseContact.isActive,\n        value: true\n      )\n    }\n  )\n)"
    },
    "_a-0000e990-c462-8000-9ba7-011c48011c48_25890": {
      "name": "CMGT_UTIL_IsBlank",
      "type": "Expression Rule",
      "sail_code": "length(a!flatten(ri!value)) = 0"
    }
  }
}