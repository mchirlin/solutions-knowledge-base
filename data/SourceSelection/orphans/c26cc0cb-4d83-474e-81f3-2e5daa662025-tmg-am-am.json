{
  "uuid": "c26cc0cb-4d83-474e-81f3-2e5daa662025-tmg-am-am",
  "name": "AS_GSS_TMG_BL_constructTemplateAudit",
  "type": "Expression Rule",
  "description": "Create common dictionary for template audit",
  "sail_code": "rule!AS_CO_UT_cast(\n  type: 'type!{http://www.appian.com/ae/types/2009}Dictionary?list',\n  value: {\n    /*When the field changes are null, an empty audit dictionary is constructed [Used for reactivated and deactivated templates*/\n    if(\n      contains(\n        {\n          cons!AS_ADT_ENUM_AUDIT_ACTION_CODE_DEACTIVATE,\n          cons!AS_ADT_ENUM_AUDIT_ACTION_CODE_REACTIVATE\n        },\n        ri!auditTemplate.auditActionCode\n      ),\n      {\n        templateAuditId: ri!auditTemplate.templateAuditId,\n        itemId: ri!auditTemplate.templateId,\n        actionCode: ri!auditTemplate.auditActionCode,\n        username: ri!auditTemplate.username,\n        timestamp: ri!auditTemplate.timestamp,\n        fieldChanges: null\n      },\n      {}\n    ),\n    /*Template simple field changes*/\n    if(\n      rule!AS_CO_UT_isBlank(ri!auditTemplate.simpleFieldChanges),\n      {},\n      #\"SYSTEM_SYSRULES_forEach\"(\n        items: rule!AS_CO_UT_cast(\n          type: 'type!{urn:com:appian:types:AS:GSS:TMG}AS_GSS_TMG_A_R_Template_Field?list',\n          value: ri!auditTemplate.simpleFieldChanges\n        ),\n        expression: {\n          templateAuditId: fv!item.templateAuditId,\n          itemId: ri!auditTemplate.templateId,\n          actionCode: \n          /* To display the simple field changes made while Deactivating / Reactivating, the audit code is marked as \"MODIFY\"*/\n          if(\n            contains(\n              {\n                cons!AS_ADT_ENUM_AUDIT_ACTION_CODE_DEACTIVATE,\n                cons!AS_ADT_ENUM_AUDIT_ACTION_CODE_REACTIVATE\n              },\n              ri!auditTemplate.auditActionCode\n            ),\n            cons!AS_ADT_ENUM_AUDIT_ACTION_CODE_MODIFY,\n            ri!auditTemplate.auditActionCode\n          ),\n          username: ri!auditTemplate.username,\n          timestamp: ri!auditTemplate.timestamp,\n          fieldChanges: {\n            fieldName: fv!item.fieldName,\n            oldValue: fv!item.oldValue,\n            newValue: fv!item.newValue\n          }\n        }\n      )\n    ),\n    /*Template Task Changes*/\n    #\"SYSTEM_SYSRULES_forEach\"(\n      items: rule!AS_CO_UT_cast(\n        type: 'type!{urn:com:appian:types:AS:GSS:TMG}AS_GSS_TMG_A_R_TemplateTask?list',\n        value: ri!auditTemplate.templateTasksChanges\n      ),\n      expression: a!localVariables(\n        local!templateTaskChange: fv!item,\n        /*Template Task Simple Field Changes*/\n        {\n          #\"SYSTEM_SYSRULES_forEach\"(\n            items: rule!AS_CO_UT_cast(\n              type: 'type!{urn:com:appian:types:AS:GSS:TMG}AS_GSS_TMG_A_R_TemplateTask_Field?list',\n              value: local!templateTaskChange.simpleFieldChanges\n            ),\n            expression: {\n              templateAuditId: ri!auditTemplate.templateAuditId,\n              itemId: local!templateTaskChange.templateTaskId,\n              actionCode: local!templateTaskChange.auditActionCode,\n              username: local!templateTaskChange.username,\n              timestamp: local!templateTaskChange.timestamp,\n              fieldChanges: {\n                fieldName: fv!item.fieldName,\n                oldValue: fv!item.oldValue,\n                newValue: fv!item.newValue\n              }\n            }\n          ),\n          /*Template Task Precedent Changes*/\n          #\"SYSTEM_SYSRULES_forEach\"(\n            items: rule!AS_CO_UT_cast(\n              type: 'type!{urn:com:appian:types:AS:GSS:TMG}AS_GSS_TMG_A_R_TemplateTask_Precedent?list',\n              value: local!templateTaskChange.templateTaskPrecedentsChanges\n            ),\n            expression: a!localVariables(\n              local!templateTaskPrecedentsChanges: fv!item,\n              #\"SYSTEM_SYSRULES_forEach\"(\n                items: rule!AS_CO_UT_cast(\n                  type: 'type!{urn:com:appian:types:AS:GSS:TMG}AS_GSS_TMG_A_R_TemplateTask_Precedent_Field?list',\n                  value: local!templateTaskPrecedentsChanges.simpleFieldChanges\n                ),\n                expression: {\n                  templateAuditId: ri!auditTemplate.templateAuditId,\n                  itemId: local!templateTaskChange.templateTaskId,\n                  actionCode: local!templateTaskPrecedentsChanges.auditActionCode,\n                  username: local!templateTaskPrecedentsChanges.username,\n                  timestamp: local!templateTaskPrecedentsChanges.timestamp,\n                  fieldChanges: {\n                    fieldName: fv!item.fieldName,\n                    oldValue: fv!item.oldValue,\n                    newValue: fv!item.newValue\n                  }\n                }\n              )\n            )\n          )\n        }\n      )\n    )\n  }\n)",
  "calls": [
    {
      "name": "AS_CO_UT_cast",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "AS_CO_UT_isBlank",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "AS_ADT_ENUM_AUDIT_ACTION_CODE_DEACTIVATE",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "AS_ADT_ENUM_AUDIT_ACTION_CODE_REACTIVATE",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "AS_ADT_ENUM_AUDIT_ACTION_CODE_MODIFY",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    }
  ],
  "called_by": []
}