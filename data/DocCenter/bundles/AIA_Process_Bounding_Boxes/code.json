{
  "_metadata": {
    "bundle_id": "AIA_Process_Bounding_Boxes"
  },
  "objects": {
    "_a-0000ec94-6ee6-8000-9ba9-011c48011c48_39426": {
      "name": "AIA_Extraction_ProcessTextractOutput",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!useBoundingBoxes: rule!AIA_Extraction_UseBoundingBoxes(\n    ExtractionInstance: ri!ExtractionInstance\n  ),\n  local!pageOffset: a!defaultValue(\n    ri!SectionInstance[recordType!AIA Extraction Instance Section.startPage],\n    1\n  ) - 1 + (ri!batch - 1) * cons!AIA_PAGE_BATCH_SIZE_ADVANCED_IDP,\n  /*add important information to the raw Textract outputs and unify data keys*/\n  local!signatures: #\"SYSTEM_SYSRULES_forEach\"(\n    ri!SignatureResults,\n    #\"urn:appian:function:v1:a:update\"(\n      fv!item,\n      {\n        \"type\",\n        \"height\",\n        \"topCentroid\",\n        \"leftCentroid\",\n        \"topCentroid2DP\",\n        \"leftCentroid2DP\"\n      },\n      {\n        \"signature\",\n        fv!item.boundingBox.height,\n        fv!item.boundingBox.top + fv!item.boundingBox.height / 2,\n        fv!item.boundingBox.left + fv!item.boundingBox.width / 2,\n        roundup(\n          fv!item.boundingBox.top + fv!item.boundingBox.height / 2,\n          2\n        ),\n        roundup(\n          fv!item.boundingBox.left + fv!item.boundingBox.width / 2,\n          2\n        )\n      }\n    )\n  ),\n  local!checkboxes: #\"SYSTEM_SYSRULES_forEach\"(\n    ri!CheckboxesResults,\n    #\"urn:appian:function:v1:a:update\"(\n      fv!item,\n      {\n        \"checkboxId\",\n        \"type\",\n        \"height\",\n        \"topCentroid\",\n        \"leftCentroid\",\n        \"topCentroid2DP\",\n        \"leftCentroid2DP\"\n      },\n      {\n        fv!index,\n        \"checkbox\",\n        fv!item.keyBoundingBox.height,\n        fv!item.keyBoundingBox.top + fv!item.keyBoundingBox.height / 2,\n        fv!item.keyBoundingBox.left + fv!item.keyBoundingBox.width / 2,\n        roundup(\n          fv!item.keyBoundingBox.top + fv!item.keyBoundingBox.height / 2,\n          2\n        ),\n        roundup(\n          fv!item.keyBoundingBox.left + fv!item.keyBoundingBox.width / 2,\n          2\n        )\n      }\n    )\n  ),\n  local!tables: #\"SYSTEM_SYSRULES_forEach\"(\n    ri!TableResults,\n    a!localVariables(\n      local!pageNumber: fv!item.pageNumber,\n      local!tableId: fv!index,\n      #\"urn:appian:function:v1:a:update\"(\n        #\"urn:appian:function:v1:a:update\"(\n          fv!item,\n          {\n            \"type\",\n            \"height\",\n            \"topCentroid\",\n            \"leftCentroid\",\n            \"topCentroid2DP\",\n            \"leftCentroid2DP\"\n          },\n          {\n            \"table\",\n            todecimal(fv!item.boundingBox.height),\n            todecimal(fv!item.boundingBox.top) + todecimal(fv!item.boundingBox.height) / 2,\n            todecimal(fv!item.boundingBox.left) + todecimal(fv!item.boundingBox.width) / 2,\n            roundup(\n              todecimal(fv!item.boundingBox.top) + todecimal(fv!item.boundingBox.height) / 2,\n              2\n            ),\n            roundup(\n              todecimal(fv!item.boundingBox.left) + todecimal(fv!item.boundingBox.width) / 2,\n              2\n            )\n          }\n        ),\n        \"data\",\n        #\"SYSTEM_SYSRULES_forEach\"(\n          /*go through each row*/\n          fv!item.data,\n          a!localVariables(\n            local!keys: rule!AIA_Extraction_GetRowKeys(fv!item),\n            /*reform the map*/\n            reduce(\n              #\"urn:appian:function:v1:a:update\",\n              fv!item,\n              a!localVariables(\n                local!row: fv!item,\n                merge(\n                  local!keys,\n                  /*go through each column and update map*/\n                  #\"SYSTEM_SYSRULES_forEach\"(\n                    local!keys,\n                    a!localVariables(\n                      local!cell: index(local!row, fv!item, {}),\n                      local!tableCell: #\"urn:appian:function:v1:a:update\"(\n                        local!cell,\n                        {\n                          \"type\",\n                          \"height\",\n                          \"topCentroid\",\n                          \"leftCentroid\",\n                          \"topCentroid2DP\",\n                          \"leftCentroid2DP\",\n                          \"pageNumber\",\n                          \"tableId\",\n                        },\n                        {\n                          \"tableCell\",\n                          todecimal(local!cell.boundingBox.height),\n                          todecimal(local!cell.boundingBox.top) + todecimal(local!cell.boundingBox.height) / 2,\n                          todecimal(local!cell.boundingBox.left) + todecimal(local!cell.boundingBox.width) / 2,\n                          roundup(\n                            todecimal(local!cell.boundingBox.top) + todecimal(local!cell.boundingBox.height) / 2,\n                            2\n                          ),\n                          roundup(\n                            todecimal(local!cell.boundingBox.left) + todecimal(local!cell.boundingBox.width) / 2,\n                            2\n                          ),\n                          local!pageNumber,\n                          local!tableId\n                        }\n                      ),\n                      /*if there is a checkbox match,*/\n                      /*put it in the tableCell for printing later*/\n                      local!checkboxMatch: rule!AIA_Extraction_MatchTextractOutputSingle(\n                        itemToMatch: local!tableCell,\n                        /* only look at check boxes on the same page with the same key */\n                        listToMatch: index(\n                          local!checkboxes,\n                          intersection(\n                            wherecontains(\n                              trim(clean(local!tableCell.value)),\n                              trim(clean(local!checkboxes.key))\n                            ),\n                            wherecontains(\n                              tointeger(local!pageNumber),\n                              tointeger(local!checkboxes.pageNumber)\n                            )\n                          )\n                        )\n                      ),\n                      #\"urn:appian:function:v1:a:update\"(\n                        local!tableCell,\n                        \"checkboxText\",\n                        if(\n                          a!isNullOrEmpty(local!checkboxMatch),\n                          \"\",\n                          \"<checkbox>\" & index(local!checkboxMatch, 1, {}).key & \": \" & index(local!checkboxMatch, 1, {}).value & \"</checkbox>\"\n                        )\n                      )\n                    )\n                  )\n                )\n              )\n            )\n          )\n        )\n      )\n    )\n  ),\n  /* TODO - remove this */\n  local!rawText: if(\n    a!isNullOrEmpty(\n      index(\n        index(ri!RawTextResults, 1, null),\n        \"type\",\n        null\n      )\n    ),\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!RawTextResults,\n      #\"urn:appian:function:v1:a:update\"(\n        fv!item,\n        \"type\",\n        cons!AIA_TEXTRACT_BLOCK_LINE\n      )\n    ),\n    ri!RawTextResults\n  ),\n  local!lines: todatasubset(\n    append(\n      if(\n        a!isNullOrEmpty(local!rawText),\n        {},\n        #\"SYSTEM_SYSRULES_forEach\"(\n          index(\n            local!rawText,\n            wherecontains(\n              cons!AIA_TEXTRACT_BLOCK_LINE,\n              touniformstring(local!rawText.type)\n            )\n          ),\n          #\"urn:appian:function:v1:a:update\"(\n            fv!item,\n            {\n              \"height\",\n              \"topCentroid\",\n              \"leftCentroid\",\n              \"topCentroid2DP\",\n              \"leftCentroid2DP\"\n            },\n            {\n              todecimal(fv!item.boundingBox.height),\n              todecimal(fv!item.boundingBox.top) + todecimal(fv!item.boundingBox.height) / 2,\n              todecimal(fv!item.boundingBox.left) + todecimal(fv!item.boundingBox.width) / 2,\n              roundup(\n                todecimal(fv!item.boundingBox.top) + todecimal(fv!item.boundingBox.height) / 2,\n                2\n              ),\n              roundup(\n                todecimal(fv!item.boundingBox.left) + todecimal(fv!item.boundingBox.width) / 2,\n                2\n              )\n            }\n          )\n        )\n      ),\n      local!signatures\n    ),\n    /*order the raw text, first by page, then top centroid and left centroid*/\n    #\"SYSTEM_SYSRULES_pagingInfo\"(\n      startIndex: 1,\n      batchSize: - 1,\n      sort: {\n        #\"SYSTEM_SYSRULES_sortInfo\"(field: \"pageNumber\", ascending: true),\n        #\"SYSTEM_SYSRULES_sortInfo\"(field: \"topCentroid\", ascending: true),\n        #\"SYSTEM_SYSRULES_sortInfo\"(field: \"leftCentroid2DP\", ascending: true)\n      }\n    )\n  ).data,\n  local!words: todatasubset(\n    if(\n      a!isNullOrEmpty(local!rawText),\n      {},\n      #\"SYSTEM_SYSRULES_forEach\"(\n        index(\n          local!rawText,\n          wherecontains(\n            cons!AIA_TEXTRACT_BLOCK_WORD,\n            touniformstring(local!rawText.type)\n          )\n        ),\n        remove(\n          #\"urn:appian:function:v1:a:update\"(\n            fv!item,\n            { \"id\", \"geometry\", \"pageNumber\" },\n            {\n              rule!AIA_Extraction_GenerateUuid(line: fv!item, index: fv!index),\n              fv!item.boundingBox,\n              fv!item.pageNumber + local!pageOffset\n            }\n          ),\n          \"boundingBox\"\n        )\n      )\n    ),\n    #\"SYSTEM_SYSRULES_pagingInfo\"(\n      startIndex: 1,\n      batchSize: - 1,\n      sort: {\n        #\"SYSTEM_SYSRULES_sortInfo\"(field: \"pageNumber\", ascending: true),\n        #\"SYSTEM_SYSRULES_sortInfo\"(field: \"topCentroid\", ascending: true),\n        #\"SYSTEM_SYSRULES_sortInfo\"(field: \"leftCentroid2DP\", ascending: true)\n      }\n    )\n  ).data,\n  /*find where the raw text matches a signature, checkbox or table in pageNumber, then do a distance formula*/\n  local!linesWithMatches: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      local!lines,\n      rule!AIA_Extraction_MatchTextractOutput(\n        lineToMatch: fv!item,\n        signatures: local!signatures,\n        checkboxes: local!checkboxes,\n        tables: local!tables\n      )\n    )\n  ),\n  local!addMissing: if(\n    a!isNotNullOrEmpty(local!checkboxes),\n    append(\n      local!linesWithMatches,\n      index(\n        local!checkboxes,\n        difference(\n          local!checkboxes.checkboxId,\n          tointeger(\n            reject(\n              fn!isnull,\n              local!linesWithMatches.checkboxId\n            )\n          )\n        )\n      )\n    ),\n    local!linesWithMatches\n  ),\n  /*also should we compare the previous line or the previous new line?*/\n  /*determine if each line should be considered a new line or not*/\n  local!linesWithIsNewLine: #\"SYSTEM_SYSRULES_forEach\"(\n    local!addMissing,\n    #\"urn:appian:function:v1:a:update\"(\n      fv!item,\n      \"isNewLine\",\n      if(\n        fv!isFirst,\n        false,\n        /*if the jump between the previous line and current line is greater than 75% of the height of the text box, consider it a new line*/\n        if(\n          and(\n            fv!item.pageNumber = local!addMissing[fv!index - 1].pageNumber,\n            abs(\n              fv!item.topCentroid - local!addMissing[fv!index - 1].topCentroid\n            ) < fv!item.height * 0.75\n          ),\n          false,\n          true\n        )\n      )\n    )\n  ),\n  /*create line numbers based on whether it should be a new line or not*/\n  local!linesWithLineNumbers: #\"SYSTEM_SYSRULES_forEach\"(\n    local!linesWithIsNewLine,\n    #\"urn:appian:function:v1:a:update\"(\n      fv!item,\n      \"lineNumber\",\n      sum(\n        local!linesWithIsNewLine[enumerate(fv!index) + 1].isNewLine\n      )\n    )\n  ),\n  /*sort the lines according to the line numbers*/\n  local!sortedLines: todatasubset(\n    local!linesWithLineNumbers,\n    #\"SYSTEM_SYSRULES_pagingInfo\"(\n      startIndex: 1,\n      batchSize: - 1,\n      sort: {\n        #\"SYSTEM_SYSRULES_sortInfo\"(field: \"pageNumber\", ascending: true),\n        #\"SYSTEM_SYSRULES_sortInfo\"(field: \"lineNumber\", ascending: true),\n        #\"SYSTEM_SYSRULES_sortInfo\"(field: \"leftCentroid2DP\", ascending: true)\n      }\n    )\n  ).data,\n  /*after sorting, remove all table cells and replace with full table only*/\n  local!linesReplacingTables: #\"SYSTEM_SYSRULES_forEach\"(\n    local!sortedLines,\n    /*if this line is a tableCell with matched table*/\n    if(\n      a!isNotNullOrEmpty(index(fv!item, \"tableId\", null)),\n      /*if this tableCell is the first one matching the table*/\n      if(\n        fv!index = index(\n          wherecontains(\n            index(fv!item, \"tableId\", null),\n            index(local!sortedLines, \"tableId\", null)\n          ),\n          1,\n          null\n        ),\n        /*if so, output the whole table*/\n        local!tables[index(fv!item, \"tableId\", null)],\n        /*otherwise, remove the tableCell line as we already have the table*/\n        {}\n      ),\n      /*output the existing line if not related to a table*/\n      fv!item\n    )\n  ),\n  local!length: length(local!linesReplacingTables),\n  local!uuids: if(\n    local!useBoundingBoxes,\n    apply(\n      rule!AIA_Extraction_GenerateUuid,\n      merge(\n        local!linesReplacingTables,\n        enumerate(local!length) + length(local!words)\n      )\n    ),\n    null\n  ),\n  local!inputDoc: rule!AIA_PLG_WriteFile(\n    content: joinarray(\n      #\"SYSTEM_SYSRULES_forEach\"(\n        local!linesReplacingTables,\n        a!localVariables(\n          local!text: a!match(\n            value: fv!item.type,\n            equals: \"signature\",\n            then: \"<signature present />\",\n            equals: \"checkbox\",\n            then: \"<checkbox>\" & fv!item.key & \": \" & fv!item.value & \"</checkbox>\",\n            equals: \"table\",\n            then: rule!AIA_Extraction_ProcessTextractTable(\n              table: fv!item,\n              uuids: local!uuids[fv!index].uuids,\n              useBoundingBoxes: local!useBoundingBoxes\n            ),\n            equals: \"line\",\n            then: fv!item.text,\n            default: fv!item.text\n          ),\n          if(\n            and(\n              local!useBoundingBoxes,\n              fv!item.type <> \"table\"\n            ),\n            concat(\n              \"<span id=\"\"\",\n              local!uuids[fv!index],\n              \"\"\">\",\n              local!text,\n              \"</span>\"\n            ),\n            local!text\n          )\n        )\n      ),\n      char(10)\n    ),\n    name: \"input-doc_\" & ri!batch,\n    extension: \"txt\",\n    folder: cons!AIA_FOLDER_CLEANUP_DOCS\n  ).document,\n  local!boundingBoxDoc: if(\n    local!useBoundingBoxes,\n    rule!AIA_PLG_WriteFile(\n      content: #\"SYSTEM_SYSRULES_toJson_v1\"(\n        a!flatten(\n          {\n            #\"SYSTEM_SYSRULES_forEach\"(\n              local!linesReplacingTables,\n              if(\n                fv!item.type = \"table\",\n                a!localVariables(\n                  local!table: fv!item,\n                  local!index: fv!index,\n                  #\"SYSTEM_SYSRULES_forEach\"(\n                    remove(\n                      enumerate(length(index(fv!item, \"data\", null))) + 1,\n                      index(fv!item, \"tableHeaderRows\", null)\n                    ),\n                    a!localVariables(\n                      local!row: index(local!table, \"data\", fv!item, null),\n                      local!keys: rule!AIA_Extraction_GetRowKeys(local!row),\n                      a!map(\n                        type: \"row\",\n                        pageNumber: local!table.pageNumber + local!pageOffset,\n                        /*text: fv!item.text,*/\n                        /* Calculate row bounding box \n                           Left and Top from first cell\n                           Width (cLastLeft - c1Left) + cLastWidth\n                        */\n                        geometry: {\n                          top: local!row[local!keys[1]].boundingBox.top,\n                          left: local!row[local!keys[1]].boundingBox.left,\n                          width: local!row[local!keys[length(local!keys)]].boundingBox.left - local!row[local!keys[1]].boundingBox.left + local!row[local!keys[length(local!keys)]].boundingBox.width,\n                          height: local!row[local!keys[length(local!keys)]].boundingBox.top - local!row[local!keys[1]].boundingBox.top + local!row[local!keys[length(local!keys)]].boundingBox.height\n                        },\n                        id: local!uuids[local!index].uuids[fv!index]\n                      )\n                    )\n                  )\n                ),\n                a!map(\n                  type: fv!item.type,\n                  pageNumber: fv!item.pageNumber + local!pageOffset,\n                  text: fv!item.text,\n                  geometry: if(\n                    fv!item.type = \"checkbox\",\n                    fv!item.valueBoundingBox,\n                    fv!item.boundingBox\n                  ),\n                  id: local!uuids[fv!index],\n                  confidenceScore: fv!item.confidenceScore\n                )\n              )\n            ),\n            local!words\n          }\n        )\n      ),\n      name: \"bounding-boxes_\" & ri!batch,\n      extension: \"json\",\n      folder: cons!AIA_FOLDER_CLEANUP_DOCS\n    ).document,\n    null\n  ),\n  recordType!AIA Extraction Bounding Boxes(\n    recordType!AIA Extraction Bounding Boxes.extractionId: ri!ExtractionInstance[recordType!AIA Extraction Instance.id],\n    recordType!AIA Extraction Bounding Boxes.sectionId: ri!SectionInstance[recordType!AIA Extraction Instance Section.id],\n    recordType!AIA Extraction Bounding Boxes.minPage: if(\n      a!isNullOrEmpty(local!linesReplacingTables),\n      null,\n      min(\n        index(\n          local!linesReplacingTables,\n          \"pageNumber\",\n          1\n        )\n      ) + local!pageOffset,\n      \n    ),\n    recordType!AIA Extraction Bounding Boxes.maxPage: if(\n      a!isNullOrEmpty(local!linesReplacingTables),\n      null,\n      max(\n        index(\n          local!linesReplacingTables,\n          \"pageNumber\",\n          1\n        )\n      ) + local!pageOffset\n    ),\n    recordType!AIA Extraction Bounding Boxes.batch: ri!batch,\n    recordType!AIA Extraction Bounding Boxes.boundingBoxesDocumentId: local!boundingBoxDoc,\n    recordType!AIA Extraction Bounding Boxes.inputDocumentId: local!inputDoc\n  )\n)"
    },
    "_a-0000ed69-99d8-8000-9ba6-011c48011c48_55136": {
      "name": "AIA_Extraction_UseBoundingBoxes",
      "type": "Expression Rule",
      "sail_code": "a!defaultValue(\n  ri!ExtractionInstance[recordType!AIA Extraction Instance.modelVersion.extractionModel.useBoundingBoxes],\n  cons!AIA_BOOL_CAPTURE_BOUNDING_BOXES\n)"
    },
    "_a-0000eeb8-377a-8000-9c16-011c48011c48_167255": {
      "name": "AIA_UTIL_ProcessModelForEach",
      "type": "Expression Rule",
      "sail_code": "if(\n  rule!AIA_PLG_IsAutoscaleEnabled(),\n  cons!AIA_PM_FOR_EACH_LOOP,\n  cons!AIA_PM_FOR_EACH_MNI\n)"
    },
    "_a-0000ecb8-d1aa-8000-9c16-011c48011c48_155723": {
      "name": "AIA_Extraction_GenerateUuid",
      "type": "Expression Rule",
      "sail_code": "if(\n  ri!line.type <> \"table\",\n  left(fn!generateuuid(ri!index), 8),\n  a!map(\n    uuids: #\"SYSTEM_SYSRULES_forEach\"(\n      remove(\n        enumerate(\n          length(index(ri!line, \"data\", null))\n        ) + 1,\n        index(ri!line, \"tableHeaderRows\", null)\n      ),\n      left(fn!generateuuid(ri!index), 8)\n    )\n  )\n)"
    },
    "_a-0000ee21-294f-8000-9bb6-011c48011c48_184766": {
      "name": "AIA_PLG_WriteFile",
      "type": "Expression Rule",
      "sail_code": "with(\n  local!result: writefile(\n    ri!content,\n    ri!name,\n    ri!extension,\n    ri!folder,\n    ri!description\n  ),\n  if(\n    local!result.success,\n    local!result,\n    fn!error(local!result.error)\n  )\n)"
    },
    "_a-0000edd9-a94f-8000-9bb2-011c48011c48_154001": {
      "name": "AIA_CalculateAdvancedIdpBatch",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!batches: round(rule!AIA_CalculateAdvancedIdpBatches(document: ri!document), 2),\n  local!toRun: if(\n    ri!batch < local!batches,\n    cons!AIA_CONCURRENT_NUM_ADVANCED_IDP,\n    roundup(\n      round((local!batches - ri!batch + 1) * cons!AIA_CONCURRENT_NUM_ADVANCED_IDP, 2),\n      0\n    ),\n  ),\n  local!offset: (ri!batch - 1) * cons!AIA_CONCURRENT_NUM_ADVANCED_IDP + 1,\n  #\"SYSTEM_SYSRULES_forEach\"(\n    enumerate(local!toRun) + local!offset,\n    a!map(\n      name: document(ri!document, \"name\") & \"_\" & (  (fv!item - 1) * cons!AIA_PAGE_BATCH_SIZE_ADVANCED_IDP + 1) & \"-\" & (fv!item) * cons!AIA_PAGE_BATCH_SIZE_ADVANCED_IDP,\n      startPage: (fv!item - 1) * cons!AIA_PAGE_BATCH_SIZE_ADVANCED_IDP + 1,\n      endPage: fv!item * cons!AIA_PAGE_BATCH_SIZE_ADVANCED_IDP,\n      index: fv!item\n    )\n  )\n)"
    },
    "_a-0000edd9-a94f-8000-9bb2-011c48011c48_153929": {
      "name": "AIA_CalculateAdvancedIdpBatches",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!concurrentNum: cons!AIA_CONCURRENT_NUM_ADVANCED_IDP,\n  local!pageCount: rule!AIA_GetPageCount(ri!document),\n  local!pageCount / cons!AIA_PAGE_BATCH_SIZE_ADVANCED_IDP / local!concurrentNum\n)"
    },
    "_a-0000ed21-75ea-8000-9c68-011c48011c48_299614": {
      "name": "AIA_Extraction_MatchTextractOutput",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!signatureMatch: rule!AIA_Extraction_MatchTextractOutputSingle(\n    itemToMatch: ri!lineToMatch,\n    /*only look at signatures on the same page*/\n    listToMatch: index(\n      ri!signatures,\n      wherecontains(\n        tointeger(ri!lineToMatch.pageNumber),\n        tointeger(ri!signatures.pageNumber)\n      )\n    )\n  ),\n  local!checkboxMatch: rule!AIA_Extraction_MatchTextractOutputSingle(\n    itemToMatch: ri!lineToMatch,\n    /*only look at checkboxes on the same page with the same key*/\n    listToMatch: index(\n      ri!checkboxes,\n      intersection(\n        wherecontains(\n          trim(clean(ri!lineToMatch.text)),\n          trim(clean(ri!checkboxes.key))\n        ),\n        wherecontains(\n          tointeger(ri!lineToMatch.pageNumber),\n          tointeger(ri!checkboxes.pageNumber)\n        )\n      )\n    )\n  ),\n  /*for each table on the same page*/\n  local!tableMatch: a!flatten(\n    #\"SYSTEM_SYSRULES_forEach\"(\n      index(\n        ri!tables,\n        wherecontains(\n          tointeger(ri!lineToMatch.pageNumber),\n          tointeger(ri!tables.pageNumber)\n        )\n      ),\n      /*for each row*/\n      #\"SYSTEM_SYSRULES_forEach\"(\n        fv!item.data,\n        a!localVariables(\n          local!row: fv!item,\n          local!keys: rule!AIA_Extraction_GetRowKeys(row: fv!item),\n          rule!AIA_Extraction_MatchTextractOutputSingle(\n            itemToMatch: ri!lineToMatch,\n            /*only look at cells that match the value*/\n            listToMatch: index(\n              fv!item,\n              local!keys[wherecontains(\n                /*need to use some cleaning as there are often extra spaces or other characters*/\n                trim(clean(ri!lineToMatch.text)), trim(\n                  clean(index(local!row, local!keys, {}).value)\n                )\n              )],\n              null\n            ),\n            /*relax the threshold on tables slightly*/\n            threshold: 0.05\n          )\n        )\n      )\n    )\n  ),\n  if(\n    /* Remove lines that match up with signatures as they'll be useless text */\n    and(\n      ri!lineToMatch.type = \"line\",\n      a!isNotNullOrEmpty(index(local!signatureMatch, 1, null)),\n    ),\n    {},\n    /*take the signature, then table, then checkbox, then normal line if no match*/\n    a!defaultValue(\n      local!signatureMatch,\n      /*some weird cases where multiple match?? eg. title broker contact twice, just take the first match I think should be fine*/\n      index(local!tableMatch, 1, null),\n      local!checkboxMatch,\n      ri!lineToMatch\n    )\n  )\n)"
    },
    "0006eceb-0045-8000-05d5-7f0000014e7a": {
      "name": "AIA Process Bounding Boxes",
      "type": "Process Model",
      "sail_code": "// Output: ?\nrule!AIA_CalculateAdvancedIdpBatch(\n  batch: pv!index,\n  document: pv!document\n)\n\n// Output: ?\n=rule!AIA_CalculateAdvancedIdpBatches( document: pv!document)\n\n// Input: ?\n=pv!index + 1\n\n// Output: ?\nrule!AIA_CalculateAdvancedIdpBatch(\n  batch: ac!index,\n  document: pv!document\n)\n\n// Output: ?\n{}\n\n// Input: ?\n=pv!document\n\n// Output: ?\nAC!ErrorMessage\n\n// Output: ?\nAC!Success\n\n// Output: ?\nrule!AIA_Extraction_ProcessTextractOutput(\n  ExtractionInstance: pv!ExtractionInstance,\n  SectionInstance: pv!SectionInstance,\n  RawTextResults: ac!RawTextResults,\n  batch: pv!batch\n)\n\n// Input: ?\n=pv!document\n\n// Output: ?\nAC!ErrorMessage\n\n// Output: ?\nAC!Success\n\n// Output: ?\nrule!AIA_Extraction_ProcessTextractOutput(\n  ExtractionInstance: pv!ExtractionInstance,\n  SectionInstance: pv!SectionInstance,\n  FormsKeyValuePairResults: ac!FormsKeyValuePairResults,\n  CheckboxesResults: ac!CheckboxesResults,\n  TableResults: ac!TableResults,\n  SignatureResults: ac!SignatureResults,\n  RawTextResults: ac!RawTextResults,\n  batch: pv!batch\n)\n\n// Input: ?\n=pv!BoundingBoxes\n\n// Input: ?\n=recordType!AIA Extraction Bounding Boxes\n\n// Input: ?\nrule!AIA_CreateAdvancedIdpValidation(\n  instanceId: pv!ExtractionInstance[recordType!AIA Extraction Instance.id],\n  instanceType: cons!AIA_MODEL_TYPE_VALUES[1],\n  errorMessage: pv!errorMessage\n)\n\n// Output: ?\nappian:record-relationship:v1:64322398-e457-4695-87d5-09794164cf77/e253e423-2caf-422e-ab44-4c7361a3470f\"]:ac!ProcessInfo.pv.Validation\n\n// Output: ?\nappian:record-field:v1:64322398-e457-4695-87d5-09794164cf77/df53ae63-a64a-4a79-ad4f-79ca0c54cd84\"]:false\n\n// Output: ?\nappian:record-field:v1:64322398-e457-4695-87d5-09794164cf77/df53ae63-a64a-4a79-ad4f-79ca0c54cd84\"]:rule!AIA_Extraction_UseBoundingBoxes(\n  ExtractionInstance: pv!ExtractionInstance\n)\n\n// Input: ?\n=pv!batchMaps.name\n\n// Input: ?\n=pv!document\n\n// Input: ?\n=pv!batchMaps.startPage\n\n// Input: ?\n=pv!batchMaps.endPage\n\n// Output: ?\n#\"SYSTEM_SYSRULES_forEach\"(\n  pv!batchMaps,\n  #\"urn:appian:function:v1:a:update\"(fv!item, \"documentId\", ac!NewDocumentsCreated[fv!index])\n)\n\n// Input: ?\nrule!AIA_UTIL_ProcessModelForEach()\n\n// Input: ?\na!map(\n  processModel: cons!AIA_PM_PROCESS_BOUNDING_BOXES,\n  processParameters: #\"SYSTEM_SYSRULES_forEach\"(\n    items: pv!splitMaps,\n    expression: a!map(\n      ExtractionInstance: pv!ExtractionInstance,\n      SectionInstance: pv!SectionInstance,\n      batch: fv!item.index,\n      document: fv!item.documentId\n    )\n  )\n)"
    },
    "_a-0000ee6e-3b90-8000-9bac-011c48011c48_85019": {
      "name": "AIA_IsExtractionInstance",
      "type": "Expression Rule",
      "sail_code": "runtimetypeof(\n  ri!Instance\n) = typeof(\n  recordType!AIA Extraction Instance()\n)"
    },
    "_a-0000ee6e-3b90-8000-9bac-011c48011c48_90047": {
      "name": "AIA_CreateValidationErrorMessage",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_toJson_v1\"(\n  a!map(\n    type: ri!type,\n    error: ri!error\n  )\n)"
    },
    "_a-0000ed21-75ea-8000-9c68-011c48011c48_299602": {
      "name": "AIA_Extraction_MatchTextractOutputSingle",
      "type": "Expression Rule",
      "sail_code": "a!flatten(\n  #\"SYSTEM_SYSRULES_forEach\"(\n    ri!listToMatch,\n    if(\n      /*use ratio of A4 page height to width to weight distances*/\n      /*if true, this indicates the two points are within 3% distance of one another*/\n      abs(\n        ri!itemToMatch.leftCentroid - fv!item.leftCentroid\n      ) + a!defaultValue(ri!verticalWeighting, 1.41) * abs(\n        ri!itemToMatch.topCentroid - fv!item.topCentroid\n      ) < a!defaultValue(ri!threshold, 0.03),\n      fv!item,\n      {}\n    )\n  )\n)"
    },
    "_a-0000ee52-8983-8000-9ba6-011c48011c48_27887": {
      "name": "AIA_GetDocumentMetadata",
      "type": "Expression Rule",
      "sail_code": "try(\n  a!match(\n    value: lower(document(ri!document, \"extension\")),\n    equals: \"pdf\",\n    then: getpdfmetadata(document: ri!document),\n    equals: \"eml\",\n    then: a!map(\n      pageCount: try(\n        tointeger(\n          len(\n            #\"SYSTEM_SYSRULES_fromJson_v1\"(reademlfile(ri!document)).body\n          ) / cons!AIA_EML_PAGE_CHAR_COUNT\n        ),\n        1\n      )\n    ),\n    default: a!map(pageCount: 1)\n  ),\n  a!map(pageCount: 1)\n)"
    },
    "_a-0000eeb3-c7af-8000-9c01-011c48011c48_157749": {
      "name": "AIA_PLG_IsAutoscaleEnabled",
      "type": "Expression Rule",
      "sail_code": "a!defaultValue(\n  toboolean(getenvironmentconfigs().isAutscaleEnabled),\n  false\n)"
    },
    "_a-0000ec2d-5396-8000-9bdc-011c48011c48_40839": {
      "name": "AIA_Test_GetLatestExtractionInstance",
      "type": "Expression Rule",
      "sail_code": "rule!AIA_Extraction_GetInstanceById(\n  identifier: #\"SYSTEM_SYSRULES_queryRecordType_v3\"(\n    recordType: recordType!AIA Extraction Instance,\n    pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n      startIndex: 1,\n      batchSize: 1,\n      sort: {\n        #\"SYSTEM_SYSRULES_sortInfo\"(\n          field: recordType!AIA Extraction Instance.id\n        )\n      }\n    )\n  ).data[recordType!AIA Extraction Instance.id],\n  additionalFields: {\n    recordType!AIA Extraction Instance.instanceUuid,\n    recordType!AIA Extraction Instance.modelVersion.versionId,\n    recordType!AIA Extraction Instance.modelVersion.modelId,\n    recordType!AIA Extraction Instance.modelVersion.uuid,\n    recordType!AIA Extraction Instance.modelVersion.extractionModel.key,\n    recordType!AIA Extraction Instance.documentFolderId,\n    recordType!AIA Extraction Instance.fieldCount,\n    recordType!AIA Extraction Instance.sections,\n    recordType!AIA Extraction Instance.boundingBoxes,\n    recordType!AIA Extraction Instance.responseDocumentId,\n    recordType!AIA Extraction Instance.sourceDocumentId\n  }\n)"
    },
    "_a-0000ecb2-34d9-8000-9c14-011c48011c48_155512": {
      "name": "AIA_Extraction_ProcessTextractTable",
      "type": "Expression Rule",
      "sail_code": "if(\n  a!isNullOrEmpty(ri!table),\n  \"\",\n  joinarray(\n    {\n      \"<table>\",\n      if(\n        a!isNullOrEmpty(index(ri!table, \"tableHeaderRows\", null)),\n        {},\n        char(9) & \"<thead>\"\n      ),\n      #\"SYSTEM_SYSRULES_forEach\"(\n        index(ri!table, \"tableHeaderRows\", null),\n        a!localVariables(\n          local!headerRow: index(ri!table, \"data\", fv!item, null),\n          local!keys: rule!AIA_Extraction_GetRowKeys(local!headerRow),\n          {\n            char(9) & char(9) & \"<tr>\",\n            #\"SYSTEM_SYSRULES_forEach\"(\n              index(\n                local!headerRow,\n                local!keys,\n                \"value\",\n                null\n              ),\n              char(9) & char(9) & char(9) & \"<th>\" & fv!item & \"</th>\"\n            ),\n            char(9) & char(9) & \"</tr>\"\n          }\n        )\n      ),\n      if(\n        a!isNullOrEmpty(index(ri!table, \"tableHeaderRows\", null)),\n        {},\n        char(9) & \"</thead>\"\n      ),\n      char(9) & \"<tbody>\",\n      #\"SYSTEM_SYSRULES_forEach\"(\n        remove(\n          enumerate(length(index(ri!table, \"data\", null))) + 1,\n          index(ri!table, \"tableHeaderRows\", null)\n        ),\n        a!localVariables(\n          local!row: index(ri!table, \"data\", fv!item, null),\n          local!keys: rule!AIA_Extraction_GetRowKeys(local!row),\n          {\n            char(9) & char(9) & \"<tr\" & if(\n              ri!useBoundingBoxes,\n              \" spanId=\"\"\" & ri!uuids[fv!index] & \"\"\">\",\n              \">\"\n            ),\n            #\"SYSTEM_SYSRULES_forEach\"(\n              /*we will also display null rows in the table*/\n              /*if checkbox text is present, use that, otherwise get the value*/\n              #\"SYSTEM_SYSRULES_forEach\"(\n                index(local!row, local!keys, null),\n                a!defaultValue(\n                  index(fv!item, \"checkboxText\", null),\n                  index(fv!item, \"value\", null)\n                )\n              ),\n              char(9) & char(9) & char(9) & \"<td>\" & fv!item & \"</td>\"\n            ),\n            char(9) & char(9) & \"</tr>\"\n          }\n        )\n      ),\n      char(9) & \"</tbody>\",\n      \"</table>\"\n    },\n    char(10)\n  )\n)"
    },
    "_a-0000ec44-cb49-8000-9be6-011c48011c48_82400": {
      "name": "AIA_GetPageCount",
      "type": "Expression Rule",
      "sail_code": "rule!AIA_GetDocumentMetadata(\n  document: ri!document\n).pageCount"
    },
    "_a-0000ee6e-3b90-8000-9bac-011c48011c48_76653": {
      "name": "AIA_CreateValidation",
      "type": "Expression Rule",
      "sail_code": "a!localVariables(\n  local!isExtraction: rule!AIA_IsExtractionInstance(\n    instance: ri!Instance\n  ),\n  recordType!AIA Instance Validation Error(\n    recordType!AIA Instance Validation Error.instanceId: a!defaultValue(\n      ri!instanceId,\n      if(\n        local!isExtraction,\n        ri!Instance[recordType!AIA Extraction Instance.id],\n        ri!Instance[recordType!AIA Classification Instance.id]\n      )\n    ),\n    recordType!AIA Instance Validation Error.instanceType: a!defaultValue(\n      ri!instanceType,\n      if(\n        local!isExtraction,\n        cons!AIA_MODEL_TYPE_VALUES[1],\n        cons!AIA_MODEL_TYPE_VALUES[2]\n      )\n    ),\n    recordType!AIA Instance Validation Error.typeId: ri!typeId,\n    recordType!AIA Instance Validation Error.message: ri!message,\n    recordType!AIA Instance Validation Error.severity: ri!severity\n  )\n)"
    },
    "_a-0000ecb8-d1aa-8000-9c16-011c48011c48_155954": {
      "name": "AIA_Extraction_GetRowKeys",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_forEach\"(\n  todatasubset(\n    #\"SYSTEM_SYSRULES_forEach\"(\n      a!keys(ri!row),\n      a!map(key: tointeger(fv!item))\n    ),\n    #\"SYSTEM_SYSRULES_pagingInfo\"(startIndex: 1, batchSize: -1, sort: #\"SYSTEM_SYSRULES_sortInfo\"(field: \"key\", ascending: true))\n  ).data,\n  \"c\" & fv!item.key\n)"
    },
    "_a-0000ee6e-3b90-8000-9bac-011c48011c48_89906": {
      "name": "AIA_CreateAdvancedIdpValidation",
      "type": "Expression Rule",
      "sail_code": "rule!AIA_CreateValidation(\n  typeId: cons!AIA_VALIDATION_TYPE_ID_EXECUTION,\n  instanceId: ri!instanceId,\n  instanceType: ri!instanceType,\n  message: rule!AIA_CreateValidationErrorMessage(\n    type: #\"urn:appian:translation-string:v1:ff252c53-64e4-4a99-8d23-8bc72a94e3fc\",\n    error: ri!errorMessage\n  ),\n  severity: a!defaultValue(ri!severity, cons!AIA_SEVERITY_CRITICAL)\n)"
    }
  }
}