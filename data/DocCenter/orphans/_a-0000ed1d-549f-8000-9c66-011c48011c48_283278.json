{
  "uuid": "_a-0000ed1d-549f-8000-9c66-011c48011c48_283278",
  "name": "AIA_RULE_Operation_ValidateField",
  "type": "Expression Rule",
  "description": "Expression rule that validates all fields",
  "sail_code": "a!localVariables(\n  local!invalidFields: reject(\n    fn!isnull,\n    #\"SYSTEM_SYSRULES_forEach\"(\n      ri!parameters.modelVersionFields,\n      a!localVariables(\n        local!field: fv!item,\n        if(\n          or(\n            /* No validation rules or options */\n            and(\n              a!isNullOrEmpty(local!field[recordType!AIA Extraction Model Version Field.optionRule]),\n              a!isNullOrEmpty(local!field[recordType!AIA Extraction Model Version Field.validationRule])\n            ),\n            and(\n              a!flatten(\n                a!localVariables(\n                  local!value: tostring(index(ri!parameters.instanceMap, local!field[recordType!AIA Extraction Model Version Field.key], null)),\n                  local!multiValue: if(\n                    /*for true text fields, want to avoid situation where toJson converts a numeral only text string into a integer*/\n                    /*i.e toJson(\"02\") -> 2*/\n                    and(\n                      /*field is type text*/\n                      local!field[recordType!AIA Extraction Model Version Field.type] = cons!AIA_EXTRACTION_FIELD_TYPES[1],\n                      /*value contains only number characters*/\n                      cleanwith(local!value, \"AIA_UTIL_NUMERAL_CHARACTERS\") = local!value\n                    ),\n                    /*if field is type text and the value contains only numeral characters, return as is in array without tojson*/\n                    { tostring(local!value) },\n                    /*else try json*/\n                    try(\n                      #\"SYSTEM_SYSRULES_fromJson_v1\"(local!value),\n                      /*if not json and not pure numeral text string, return pure value again (for dates, regular text, etc)*/\n                      { tostring(local!value) }\n                    )\n                  ),\n                  #\"SYSTEM_SYSRULES_forEach\"(\n                    local!multiValue,\n                    or(\n                      a!isNullOrEmpty(fv!item),\n                      /* Has an options rule and value is correct */ \n                      and(\n                        a!isNotNullOrEmpty(local!field[recordType!AIA Extraction Model Version Field.optionRule]),\n                        a!localVariables(\n                          local!options: rule!AIA_Extraction_GetFieldOptions(\n                            ModelVersionField: local!field\n                          ),\n                          contains(\n                            touniformstring(index(local!options, \"options\", {})),\n                            tostring(fv!item)\n                          )\n                        )\n                      ),\n                      /* Has a validation rule and value is correct */\n                      and(\n                        a!isNotNullOrEmpty(local!field[recordType!AIA Extraction Model Version Field.validationRule]),\n                        a!localVariables(\n                          local!validationRule: a!refreshVariable(\n                            refreshAlways: true,\n                            value: getrulereferencebyname(\n                              local!field[recordType!AIA Extraction Model Version Field.validationRule]\n                            )\n                          ),\n                          a!isNullOrEmpty(local!validationRule(value: fv!item))\n                        )\n                      )\n                    ) \n                  )\n                )\n              )\n            )\n          ),\n          null,\n          fv!item[recordType!AIA Extraction Model Version Field.label],\n        )\n      )\n    )\n  ),\n  local!invalidColumns: reject(\n    fn!isnull,\n    a!flatten(#\"SYSTEM_SYSRULES_forEach\"(\n      ri!parameters.modelVersionFields,\n      if(\n        a!isNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Field.columns]),\n        null,\n        a!localVariables(\n          local!field: fv!item,\n          #\"SYSTEM_SYSRULES_forEach\"(\n            local!field[recordType!AIA Extraction Model Version Field.columns],\n            if(\n              or(\n                /* No validation rules or options or columns */\n                and(\n                  a!isNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Field.optionRule]),\n                  a!isNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Field.validationRule])\n                ),\n                /* Has an options rule and value is correct */ \n                and(\n                  a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Field.optionRule]),\n                  a!localVariables(\n                    local!options: rule!AIA_Extraction_GetFieldOptions(\n                      ModelVersionField: fv!item\n                    ),\n                    and(\n                      #\"SYSTEM_SYSRULES_forEach\"(\n                        ri!parameters.instanceMap[local!field[recordType!AIA Extraction Model Version Field.key]][fv!item[recordType!AIA Extraction Model Version Field.key]],\n                        contains(\n                          touniformstring(index(local!options, \"options\", {})),\n                          tostring(fv!item)\n                        )\n                      )\n                    )\n                  )\n                ),\n                /* Has a validation rule and value is correct */\n                and(\n                  a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Model Version Field.validationRule]),\n                  a!localVariables(\n                    local!validationRule: a!refreshVariable(\n                      refreshAlways: true,\n                      value: getrulereferencebyname(\n                        fv!item[recordType!AIA Extraction Model Version Field.validationRule]\n                      )\n                    ),\n                    all(\n                      a!isNullOrEmpty,\n                      #\"SYSTEM_SYSRULES_forEach\"(\n                        ri!parameters.instanceMap[local!field[recordType!AIA Extraction Model Version Field.key]][fv!item[recordType!AIA Extraction Model Version Field.key]],\n                        local!validationRule(value: fv!item)\n                      )\n                    )\n                  )\n                )\n              ),\n              null,\n              local!field[recordType!AIA Extraction Model Version Field.label] & \" - \" & fv!item[recordType!AIA Extraction Model Version Field.label],\n            )\n          )\n        )\n      )   \n    ))\n  ),\n  local!invalidValues: union(\n    touniformstring(local!invalidFields),\n    touniformstring(local!invalidColumns)\n  ),\n  a!map(\n    result: a!isNullOrEmpty(local!invalidValues),\n    message: \"The following contain invalid values: \" & local!invalidValues,\n    severity: cons!AIA_SEVERITY_HIGH\n  )\n)",
  "calls": [
    {
      "name": "AIA_Extraction_GetFieldOptions",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "AIA_EXTRACTION_FIELD_TYPES",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "AIA_SEVERITY_HIGH",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    }
  ],
  "called_by": []
}