{
  "_metadata": {
    "bundle_id": "AIA_Extraction_Instance_Field_-_revertField"
  },
  "objects": {
    "0002ed00-d308-8000-0a90-7f0000014e7a": {
      "name": "AIA Revert Field",
      "type": "Process Model",
      "sail_code": "// Output: ?\nrule!AIA_Extraction_PostProcess(\n  ExtractionInstance: rule!AIA_Extraction_GetInstanceByIdForReconciliation(identifier: pv!instanceId)\n)\n\n// Input: ?\nif(\n  pv!Field[recordType!AIA Extraction Instance Field.modelVersionField.type] = cons!AIA_EXTRACTION_FIELD_TYPE_TABLE,\n  #\"urn:appian:function:v1:a:update\"(\n    data: pv!Field,\n    index: {\n      recordType!AIA Extraction Instance Field.overrideValue,\n      recordType!AIA Extraction Instance Field.rows\n    },\n    value: {\n      null,\n      #\"SYSTEM_SYSRULES_forEach\"(\n        items: 1,\n        expression: reject(\n          fn!isnull,\n          #\"SYSTEM_SYSRULES_forEach\"(\n            items: pv!Field[recordType!AIA Extraction Instance Field.rows],\n            expression: a!match(\n              value: fv!item[recordType!AIA Extraction Instance Field Row.overrideValue],\n              whenTrue: or(\n                fv!value = cons!AIA_ROW_REMOVED,\n                fv!value = cons!AIA_ROW_OVERRIDDEN\n              ),\n              then: a!localVariables(\n                local!row: fv!item,\n                #\"urn:appian:function:v1:a:update\"(\n                  data: local!row,\n                  index: {\n                    recordType!AIA Extraction Instance Field Row.overrideValue,\n                    recordType!AIA Extraction Instance Field Row.cells\n                  },\n                  value: {\n                    null,\n                    #\"SYSTEM_SYSRULES_forEach\"(\n                      items: 1,\n                      expression: #\"SYSTEM_SYSRULES_forEach\"(\n                        items: local!row[recordType!AIA Extraction Instance Field Row.cells],\n                        expression: #\"urn:appian:function:v1:a:update\"(\n                          data: fv!item,\n                          index: {\n                            recordType!AIA Extraction Instance Field Row Cell.overrideNull,\n                            recordType!AIA Extraction Instance Field Row Cell.overrideValue\n                          },\n                          value: { null, null }\n                        )\n                      )\n                    )\n                  }\n                )\n              ),\n              whenTrue: fv!value = cons!AIA_ROW_ADDED,\n              then: if(\n                a!isNullOrEmpty(\n                  fv!item[recordType!AIA Extraction Instance Field Row.id]\n                ),\n                /* newly added and not saved row */\n                null,\n                #\"urn:appian:function:v1:a:update\"(\n                  data: fv!item,\n                  index: recordType!AIA Extraction Instance Field Row.overrideValue,\n                  value: cons!AIA_ROW_DELETED\n                )\n              ),\n              default: fv!item\n            )\n          )\n        )\n      )\n    }\n  ),\n  #\"urn:appian:function:v1:a:update\"(\n    data: pv!Field,\n    index: {recordType!AIA Extraction Instance Field.overrideNull, recordType!AIA Extraction Instance Field.overrideValue, recordType!AIA Extraction Instance Field.overrideBoundingBox},\n    value: {null, null, null}\n  )\n)\n\n// Input: ?\n=recordType!AIA Extraction Instance Field\n\n// Output: ?\nac!RecordsUpdated\n\n// Input: ?\n=pv!ExtractionInstance\n\n// Input: ?\n=recordType!AIA Extraction Instance\n\n// Output: ?\nAC!RecordsUpdated\n\n// Output: ?\nrule!AIA_Extraction_GetValidationsToClear(\n  InstanceField: pv!Field\n)\n\n// Input: ?\n={pv!Validations}\n\n// Input: ?\n={recordType!AIA Instance Validation Error}"
    },
    "_a-0000ecf1-11b9-8000-9c4e-011c48011c48_203500": {
      "name": "AIA_EXTRACTION_INSTANCE_FIELDS",
      "type": "Expression Rule",
      "sail_code": "{\n  /* Extraction Instance */\n  recordType!AIA Extraction Instance.modelVersionId,\n  recordType!AIA Extraction Instance.documentId,\n  recordType!AIA Extraction Instance.statusId,\n  recordType!AIA Extraction Instance.hasBoundingBoxes,\n  recordType!AIA Extraction Instance.boundingBoxesDocumentId,\n  recordType!AIA Extraction Instance.modifiedBy,\n  recordType!AIA Extraction Instance.modifiedOn,\n  /* Temporary */\n  recordType!AIA Extraction Instance.pageCount,\n  recordType!AIA Extraction Instance.documentFolderId,\n  /* Extraction Fields */\n  recordType!AIA Extraction Instance.fields.modelVersionFieldId,\n  recordType!AIA Extraction Instance.fields.extractedValue,\n  recordType!AIA Extraction Instance.fields.overrideValue,\n  recordType!AIA Extraction Instance.fields.overrideNull,\n  recordType!AIA Extraction Instance.fields.boundingBox,\n  recordType!AIA Extraction Instance.fields.overrideBoundingBox,\n  recordType!AIA Extraction Instance.fields.confidence,\n  recordType!AIA Extraction Instance.fields.totalCells,\n  /* Extraction Fields > Rows */\n  recordType!AIA Extraction Instance.fields.rows.overrideValue,\n  recordType!AIA Extraction Instance.fields.rows.boundingBox,\n  /* Extraction Fields > Rows > Cells */\n  recordType!AIA Extraction Instance.fields.rows.cells.modelVersionFieldId,\n  recordType!AIA Extraction Instance.fields.rows.cells.extractedValue,\n  recordType!AIA Extraction Instance.fields.rows.cells.overrideValue,\n  recordType!AIA Extraction Instance.fields.rows.cells.overrideNull,\n  recordType!AIA Extraction Instance.fields.rows.cells.confidence,\n\n  /* Extraction Fields > Model Version Field */  \n  recordType!AIA Extraction Instance.fields.modelVersionField.key,\n  recordType!AIA Extraction Instance.fields.modelVersionField.isNotTracked,\n  \n  /* Extraction Fields > Model Version Field > Columns */  \n  recordType!AIA Extraction Instance.fields.modelVersionField.columns.key,\n  recordType!AIA Extraction Instance.fields.modelVersionField.columns.isNotTracked,\n\n  /* Extraction Fields > Rows > Cell > Column */  \n  #\"urn:appian:record-relationship:v1:64322398-e457-4695-87d5-09794164cf77/8d64a7fc-95d1-4c81-b1d8-f583dafbf127/dbb0701f-9e25-4d41-accc-959fc64a808d/69a05e41-75be-4506-ae42-ae78ac0d6b9a/9537b867-3cf8-4a1b-b019-fc98a6c4b090\",\n  \n  /* Extraction Fields > Model Version */  \n  recordType!AIA Extraction Instance.modelVersion,\n}"
    },
    "_a-0000ee78-c4db-8000-9bae-011c48011c48_91402": {
      "name": "AIA_Extraction_GetValidationsToClear",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_forEach\"(\n  #\"SYSTEM_SYSRULES_queryRecordType_v3\"(\n    recordType: recordType!AIA Instance Validation Error,\n    fields: {\n      recordType!AIA Instance Validation Error.isAccepted,\n      recordType!AIA Instance Validation Error.isIgnored\n    },\n    filters: {\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!AIA Instance Validation Error.instanceFieldId,\n        operator: \"=\",\n        value: ri!InstanceField[recordType!AIA Extraction Instance Field.id]\n      ),\n      #\"SYSTEM_SYSRULES_queryFilter\"(\n        field: recordType!AIA Instance Validation Error.typeId,\n        operator: \"=\",\n        value: cons!AIA_VALIDATION_TYPE_ID_AI_REVIEW\n      )\n    },\n    pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n      1,\n      1\n    )\n  ).data,\n  #\"urn:appian:function:v1:a:update\"(\n    fv!item,\n    {\n      recordType!AIA Instance Validation Error.isAccepted,\n      recordType!AIA Instance Validation Error.isIgnored\n    },\n    {\n      null,\n      null\n    }\n  )\n)\n  "
    },
    "_a-0001eccb-4552-8000-9c3e-011c48011c48_161219": {
      "name": "AIA_Extraction_GetInstanceByIdForReconciliation",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_queryRecordByIdentifier\"(\n  recordType: recordType!AIA Extraction Instance,\n  identifier: ri!identifier,\n  fields: a!flatten(\n    {\n      rule!AIA_EXTRACTION_INSTANCE_FIELDS(),\n      \n      /* Fields used in AIA_Extraction_CreateUpdateInstance */\n      recordType!AIA Extraction Instance.documentFolderId,\n      recordType!AIA Extraction Instance.sourceDocumentId,\n      recordType!AIA Extraction Instance.createdOn,\n      recordType!AIA Extraction Instance.createdBy,\n      recordType!AIA Extraction Instance.testInstance,\n      recordType!AIA Extraction Instance.statusId,\n      recordType!AIA Extraction Instance.hasBoundingBoxes,\n      recordType!AIA Extraction Instance.boundingBoxesDocumentId,\n      recordType!AIA Extraction Instance.responseDocumentId,\n      recordType!AIA Extraction Instance.pageCount,\n      recordType!AIA Extraction Instance.inputTokens,\n      recordType!AIA Extraction Instance.outputTokens,\n      recordType!AIA Extraction Instance.wasStp,\n      \n      recordType!AIA Extraction Instance.modelVersion.extractionModel.uuid\n    }\n  )\n)"
    },
    "_a-0000ec9e-8ba1-8000-9c08-011c48011c48_146666": {
      "name": "AIA_Extraction_PostProcess",
      "type": "Expression Rule",
      "sail_code": "if(\n  not(\n    contains(\n      cons!AIA_INSTANCE_STATUS_RECONCILED_ALL,\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.statusId]\n    )\n  ),\n  /*accuracy calculations only run after reconcile, so if not reconcile status, no change*/\n  ri!ExtractionInstance,\n  a!localVariables(\n    local!fields: #\"SYSTEM_SYSRULES_forEach\"(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.fields],\n      #\"urn:appian:function:v1:a:update\"(\n        #\"urn:appian:function:v1:a:update\"(\n          fv!item,\n          recordType!AIA Extraction Instance Field.result,\n          a!match(\n            value: fv!item[recordType!AIA Extraction Instance Field.extractedValue],\n            whenTrue: or(\n              fv!item[recordType!AIA Extraction Instance Field.modelVersionField.isNotTracked],\n              and(\n                a!isNotNullOrEmpty(\n                  fv!item[recordType!AIA Extraction Instance Field.rows]\n                ),\n                length(\n                  fv!item[recordType!AIA Extraction Instance Field.rows]\n                ) > 0\n              )\n            ),\n            then: null,\n            /* TP - Extraction not null and not overridden */\n            whenTrue: and(\n              a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.extractedValue]),\n              a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideValue]),\n              or(\n                a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideNull]),\n                fv!item[recordType!AIA Extraction Instance Field.overrideNull] = false\n              )\n            ),\n            then: cons!AIA_FIELD_RESULT_TRUE_POSITIVE,\n            /* TN - Extraction is null and not overridden */\n            whenTrue: and(\n              a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.extractedValue]),\n              a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideValue])\n            ),\n            then: cons!AIA_FIELD_RESULT_TRUE_NEGATIVE,\n            /* FP - Extraction is not null and is overridden */\n            whenTrue: and(\n              a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.extractedValue]),\n              or(\n                a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideValue]),\n                fv!item[recordType!AIA Extraction Instance Field.overrideNull] = true\n              )\n            ),\n            then: cons!AIA_FIELD_RESULT_FALSE_POSITIVE,\n            /* FN - Extraction is null and is overridden */\n            whenTrue: and(\n              a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.extractedValue]),\n              or(\n                a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideValue]),\n                fv!item[recordType!AIA Extraction Instance Field.overrideNull] = true\n              )\n            ),\n            then: cons!AIA_FIELD_RESULT_FALSE_NEGATIVE,\n            default: null\n          )\n        ),\n        recordType!AIA Extraction Instance Field.rows,\n        #\"SYSTEM_SYSRULES_forEach\"(\n          fv!item[recordType!AIA Extraction Instance Field.rows],\n          #\"urn:appian:function:v1:a:update\"(\n            fv!item,\n            recordType!AIA Extraction Instance Field Row.cells,\n            #\"SYSTEM_SYSRULES_forEach\"(\n              fv!item[recordType!AIA Extraction Instance Field Row.cells],\n              #\"urn:appian:function:v1:a:update\"(\n                fv!item,\n                recordType!AIA Extraction Instance Field Row Cell.result,\n                a!match(\n                  value: fv!item,\n                  whenTrue: fv!item[recordType!AIA Extraction Instance Field Row Cell.column.isNotTracked],\n                  then: null,\n                  /* TP - Extraction not null and not overridden */\n                  whenTrue: and(\n                    a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                    and(\n                      a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideValue]),\n                      or(\n                        a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideNull]),\n                        fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideNull] = false\n                      )\n                    )\n                  ),\n                  then: cons!AIA_FIELD_RESULT_TRUE_POSITIVE,\n                  /* TN - Extraction is null and not overridden */\n                  whenTrue: and(\n                    a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                    a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideValue])\n                  ),\n                  then: cons!AIA_FIELD_RESULT_TRUE_NEGATIVE,\n                  /* FP - Extraction is not null and is overridden */\n                  whenTrue: and(\n                    a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                    or(\n                      a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideValue]),\n                      fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideNull] = true\n                    )\n                  ),\n                  then: cons!AIA_FIELD_RESULT_FALSE_POSITIVE,\n                  /* FN - Extraction is null and is overridden */\n                  whenTrue: and(\n                    a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                    or(\n                      a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideValue]),\n                      fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideNull] = true\n                    )\n                  ),\n                  then: cons!AIA_FIELD_RESULT_FALSE_NEGATIVE,\n                  default: null\n                )\n              )\n            )\n          )\n        )\n      )\n    ),\n    local!allResults: touniformstring(\n      reject(\n        fn!isnull,\n        a!flatten(\n          {\n            local!fields[recordType!AIA Extraction Instance Field.result],\n            local!fields[recordType!AIA Extraction Instance Field.rows.cells.result]\n          }\n        )\n      )\n    ),\n    local!confusion: a!map(\n      tp: length(\n        index(\n          local!allResults,\n          wherecontains(\n            cons!AIA_FIELD_RESULT_TRUE_POSITIVE,\n            local!allResults\n          )\n        )\n      ),\n      tn: length(\n        index(\n          local!allResults,\n          wherecontains(\n            cons!AIA_FIELD_RESULT_TRUE_NEGATIVE,\n            local!allResults\n          )\n        )\n      ),\n      fp: length(\n        index(\n          local!allResults,\n          wherecontains(\n            cons!AIA_FIELD_RESULT_FALSE_POSITIVE,\n            local!allResults\n          )\n        )\n      ),\n      fn: length(\n        index(\n          local!allResults,\n          wherecontains(\n            cons!AIA_FIELD_RESULT_FALSE_NEGATIVE,\n            local!allResults\n          )\n        )\n      )\n    ),\n    local!recall: try(\n      local!confusion.tp / (local!confusion.tp + local!confusion.fn),\n      null\n    ),\n    local!precision: try(\n      local!confusion.tp / (local!confusion.tp + local!confusion.fp),\n      null\n    ),\n    local!accuracy: try(\n      (local!confusion.tp + local!confusion.tn) / (\n        local!confusion.tp + local!confusion.tn + local!confusion.fp + local!confusion.fn\n      ),\n      null\n    ),\n    local!f1: try(\n      (2 * local!recall * local!precision) / (local!recall + local!precision),\n      null\n    ),\n    #\"urn:appian:function:v1:a:update\"(\n      #\"urn:appian:function:v1:a:update\"(\n        ri!ExtractionInstance,\n        recordType!AIA Extraction Instance.fields,\n        local!fields\n      ),\n      {\n        recordType!AIA Extraction Instance.accuracy,\n        recordType!AIA Extraction Instance.precision,\n        recordType!AIA Extraction Instance.recall,\n        recordType!AIA Extraction Instance.f1\n      },\n      {\n        local!accuracy,\n        local!precision,\n        local!recall,\n        local!f1\n      }\n    )\n  )\n)"
    }
  }
}