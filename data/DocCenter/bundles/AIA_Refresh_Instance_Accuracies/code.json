{
  "_metadata": {
    "bundle_id": "AIA_Refresh_Instance_Accuracies"
  },
  "objects": {
    "_a-0000ecf1-11b9-8000-9c4e-011c48011c48_203500": {
      "name": "AIA_EXTRACTION_INSTANCE_FIELDS",
      "type": "Expression Rule",
      "sail_code": "{\n  /* Extraction Instance */\n  recordType!AIA Extraction Instance.modelVersionId,\n  recordType!AIA Extraction Instance.documentId,\n  recordType!AIA Extraction Instance.statusId,\n  recordType!AIA Extraction Instance.hasBoundingBoxes,\n  recordType!AIA Extraction Instance.boundingBoxesDocumentId,\n  recordType!AIA Extraction Instance.modifiedBy,\n  recordType!AIA Extraction Instance.modifiedOn,\n  /* Temporary */\n  recordType!AIA Extraction Instance.pageCount,\n  recordType!AIA Extraction Instance.documentFolderId,\n  /* Extraction Fields */\n  recordType!AIA Extraction Instance.fields.modelVersionFieldId,\n  recordType!AIA Extraction Instance.fields.extractedValue,\n  recordType!AIA Extraction Instance.fields.overrideValue,\n  recordType!AIA Extraction Instance.fields.overrideNull,\n  recordType!AIA Extraction Instance.fields.boundingBox,\n  recordType!AIA Extraction Instance.fields.overrideBoundingBox,\n  recordType!AIA Extraction Instance.fields.confidence,\n  recordType!AIA Extraction Instance.fields.totalCells,\n  /* Extraction Fields > Rows */\n  recordType!AIA Extraction Instance.fields.rows.overrideValue,\n  recordType!AIA Extraction Instance.fields.rows.boundingBox,\n  /* Extraction Fields > Rows > Cells */\n  recordType!AIA Extraction Instance.fields.rows.cells.modelVersionFieldId,\n  recordType!AIA Extraction Instance.fields.rows.cells.extractedValue,\n  recordType!AIA Extraction Instance.fields.rows.cells.overrideValue,\n  recordType!AIA Extraction Instance.fields.rows.cells.overrideNull,\n  recordType!AIA Extraction Instance.fields.rows.cells.confidence,\n\n  /* Extraction Fields > Model Version Field */  \n  recordType!AIA Extraction Instance.fields.modelVersionField.key,\n  recordType!AIA Extraction Instance.fields.modelVersionField.isNotTracked,\n  \n  /* Extraction Fields > Model Version Field > Columns */  \n  recordType!AIA Extraction Instance.fields.modelVersionField.columns.key,\n  recordType!AIA Extraction Instance.fields.modelVersionField.columns.isNotTracked,\n\n  /* Extraction Fields > Rows > Cell > Column */  \n  #\"urn:appian:record-relationship:v1:64322398-e457-4695-87d5-09794164cf77/8d64a7fc-95d1-4c81-b1d8-f583dafbf127/dbb0701f-9e25-4d41-accc-959fc64a808d/69a05e41-75be-4506-ae42-ae78ac0d6b9a/9537b867-3cf8-4a1b-b019-fc98a6c4b090\",\n  \n  /* Extraction Fields > Model Version */  \n  recordType!AIA Extraction Instance.modelVersion,\n}"
    },
    "_a-0001eccb-4552-8000-9c3e-011c48011c48_161219": {
      "name": "AIA_Extraction_GetInstanceByIdForReconciliation",
      "type": "Expression Rule",
      "sail_code": "#\"SYSTEM_SYSRULES_queryRecordByIdentifier\"(\n  recordType: recordType!AIA Extraction Instance,\n  identifier: ri!identifier,\n  fields: a!flatten(\n    {\n      rule!AIA_EXTRACTION_INSTANCE_FIELDS(),\n      \n      /* Fields used in AIA_Extraction_CreateUpdateInstance */\n      recordType!AIA Extraction Instance.documentFolderId,\n      recordType!AIA Extraction Instance.sourceDocumentId,\n      recordType!AIA Extraction Instance.createdOn,\n      recordType!AIA Extraction Instance.createdBy,\n      recordType!AIA Extraction Instance.testInstance,\n      recordType!AIA Extraction Instance.statusId,\n      recordType!AIA Extraction Instance.hasBoundingBoxes,\n      recordType!AIA Extraction Instance.boundingBoxesDocumentId,\n      recordType!AIA Extraction Instance.responseDocumentId,\n      recordType!AIA Extraction Instance.pageCount,\n      recordType!AIA Extraction Instance.inputTokens,\n      recordType!AIA Extraction Instance.outputTokens,\n      recordType!AIA Extraction Instance.wasStp,\n      \n      recordType!AIA Extraction Instance.modelVersion.extractionModel.uuid\n    }\n  )\n)"
    },
    "0007ee23-8b2c-8000-011f-7f0000014e7a": {
      "name": "AIA Refresh Instance Accuracies",
      "type": "Process Model",
      "sail_code": "// Output: ?\npv!batch + 1\n\n// Input: ?\n#\"SYSTEM_SYSRULES_forEach\"(\n  pv!ExtractionInstances,\n  rule!AIA_Extraction_PostProcess(\n    ExtractionInstance: rule!AIA_Extraction_GetInstanceByIdForReconciliation(\n      identifier: fv!item[recordType!AIA Extraction Instance.id]\n    )\n  )\n)\n\n// Input: ?\n=recordType!AIA Extraction Instance\n\n// Input: ?\n= #\"SYSTEM_SYSRULES_queryRecordType_v1\"( recordType: recordType!AIA Extraction Instance, fields: { recordType!AIA Extraction Instance.id }, filters: { #\"SYSTEM_SYSRULES_queryFilter\"( field: recordType!AIA Extraction Instance.modelVersionId, operator: \"=\", value: pv!modelVersionId ), #\"SYSTEM_SYSRULES_queryFilter\"( field: recordType!AIA Extraction Instance.accuracy, operator: \"not null\" ) }, pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(1, 0)).totalCount\n\n// Output: ?\nroundup(ac!totalCount / cons!AIA_MIGRATION_BATCH_SIZE, 0)\n\n// Output: ?\n#\"SYSTEM_SYSRULES_queryRecordType_v1\"(\n  recordType: recordType!AIA Extraction Instance,\n  fields: {\n    recordType!AIA Extraction Instance.id\n  },\n  filters: {\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!AIA Extraction Instance.modelVersionId,\n      operator: \"=\",\n      value: pv!modelVersionId\n    ),\n    #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!AIA Extraction Instance.accuracy,\n      operator: \"not null\"\n    )\n  },\n  pagingInfo: #\"SYSTEM_SYSRULES_pagingInfo\"(\n    startIndex: (pv!batch - 1) * cons!AIA_MIGRATION_BATCH_SIZE + 1,\n    batchSize: cons!AIA_MIGRATION_BATCH_SIZE,\n    sort: #\"SYSTEM_SYSRULES_sortInfo\"(field: recordType!AIA Extraction Instance.id, ascending: true)\n  )\n).data"
    },
    "_a-0000ec9e-8ba1-8000-9c08-011c48011c48_146666": {
      "name": "AIA_Extraction_PostProcess",
      "type": "Expression Rule",
      "sail_code": "if(\n  not(\n    contains(\n      cons!AIA_INSTANCE_STATUS_RECONCILED_ALL,\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.statusId]\n    )\n  ),\n  /*accuracy calculations only run after reconcile, so if not reconcile status, no change*/\n  ri!ExtractionInstance,\n  a!localVariables(\n    local!fields: #\"SYSTEM_SYSRULES_forEach\"(\n      ri!ExtractionInstance[recordType!AIA Extraction Instance.fields],\n      #\"urn:appian:function:v1:a:update\"(\n        #\"urn:appian:function:v1:a:update\"(\n          fv!item,\n          recordType!AIA Extraction Instance Field.result,\n          a!match(\n            value: fv!item[recordType!AIA Extraction Instance Field.extractedValue],\n            whenTrue: or(\n              fv!item[recordType!AIA Extraction Instance Field.modelVersionField.isNotTracked],\n              and(\n                a!isNotNullOrEmpty(\n                  fv!item[recordType!AIA Extraction Instance Field.rows]\n                ),\n                length(\n                  fv!item[recordType!AIA Extraction Instance Field.rows]\n                ) > 0\n              )\n            ),\n            then: null,\n            /* TP - Extraction not null and not overridden */\n            whenTrue: and(\n              a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.extractedValue]),\n              a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideValue]),\n              or(\n                a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideNull]),\n                fv!item[recordType!AIA Extraction Instance Field.overrideNull] = false\n              )\n            ),\n            then: cons!AIA_FIELD_RESULT_TRUE_POSITIVE,\n            /* TN - Extraction is null and not overridden */\n            whenTrue: and(\n              a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.extractedValue]),\n              a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideValue])\n            ),\n            then: cons!AIA_FIELD_RESULT_TRUE_NEGATIVE,\n            /* FP - Extraction is not null and is overridden */\n            whenTrue: and(\n              a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.extractedValue]),\n              or(\n                a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideValue]),\n                fv!item[recordType!AIA Extraction Instance Field.overrideNull] = true\n              )\n            ),\n            then: cons!AIA_FIELD_RESULT_FALSE_POSITIVE,\n            /* FN - Extraction is null and is overridden */\n            whenTrue: and(\n              a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.extractedValue]),\n              or(\n                a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field.overrideValue]),\n                fv!item[recordType!AIA Extraction Instance Field.overrideNull] = true\n              )\n            ),\n            then: cons!AIA_FIELD_RESULT_FALSE_NEGATIVE,\n            default: null\n          )\n        ),\n        recordType!AIA Extraction Instance Field.rows,\n        #\"SYSTEM_SYSRULES_forEach\"(\n          fv!item[recordType!AIA Extraction Instance Field.rows],\n          #\"urn:appian:function:v1:a:update\"(\n            fv!item,\n            recordType!AIA Extraction Instance Field Row.cells,\n            #\"SYSTEM_SYSRULES_forEach\"(\n              fv!item[recordType!AIA Extraction Instance Field Row.cells],\n              #\"urn:appian:function:v1:a:update\"(\n                fv!item,\n                recordType!AIA Extraction Instance Field Row Cell.result,\n                a!match(\n                  value: fv!item,\n                  whenTrue: fv!item[recordType!AIA Extraction Instance Field Row Cell.column.isNotTracked],\n                  then: null,\n                  /* TP - Extraction not null and not overridden */\n                  whenTrue: and(\n                    a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                    and(\n                      a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideValue]),\n                      or(\n                        a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideNull]),\n                        fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideNull] = false\n                      )\n                    )\n                  ),\n                  then: cons!AIA_FIELD_RESULT_TRUE_POSITIVE,\n                  /* TN - Extraction is null and not overridden */\n                  whenTrue: and(\n                    a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                    a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideValue])\n                  ),\n                  then: cons!AIA_FIELD_RESULT_TRUE_NEGATIVE,\n                  /* FP - Extraction is not null and is overridden */\n                  whenTrue: and(\n                    a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                    or(\n                      a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideValue]),\n                      fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideNull] = true\n                    )\n                  ),\n                  then: cons!AIA_FIELD_RESULT_FALSE_POSITIVE,\n                  /* FN - Extraction is null and is overridden */\n                  whenTrue: and(\n                    a!isNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.extractedValue]),\n                    or(\n                      a!isNotNullOrEmpty(fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideValue]),\n                      fv!item[recordType!AIA Extraction Instance Field Row Cell.overrideNull] = true\n                    )\n                  ),\n                  then: cons!AIA_FIELD_RESULT_FALSE_NEGATIVE,\n                  default: null\n                )\n              )\n            )\n          )\n        )\n      )\n    ),\n    local!allResults: touniformstring(\n      reject(\n        fn!isnull,\n        a!flatten(\n          {\n            local!fields[recordType!AIA Extraction Instance Field.result],\n            local!fields[recordType!AIA Extraction Instance Field.rows.cells.result]\n          }\n        )\n      )\n    ),\n    local!confusion: a!map(\n      tp: length(\n        index(\n          local!allResults,\n          wherecontains(\n            cons!AIA_FIELD_RESULT_TRUE_POSITIVE,\n            local!allResults\n          )\n        )\n      ),\n      tn: length(\n        index(\n          local!allResults,\n          wherecontains(\n            cons!AIA_FIELD_RESULT_TRUE_NEGATIVE,\n            local!allResults\n          )\n        )\n      ),\n      fp: length(\n        index(\n          local!allResults,\n          wherecontains(\n            cons!AIA_FIELD_RESULT_FALSE_POSITIVE,\n            local!allResults\n          )\n        )\n      ),\n      fn: length(\n        index(\n          local!allResults,\n          wherecontains(\n            cons!AIA_FIELD_RESULT_FALSE_NEGATIVE,\n            local!allResults\n          )\n        )\n      )\n    ),\n    local!recall: try(\n      local!confusion.tp / (local!confusion.tp + local!confusion.fn),\n      null\n    ),\n    local!precision: try(\n      local!confusion.tp / (local!confusion.tp + local!confusion.fp),\n      null\n    ),\n    local!accuracy: try(\n      (local!confusion.tp + local!confusion.tn) / (\n        local!confusion.tp + local!confusion.tn + local!confusion.fp + local!confusion.fn\n      ),\n      null\n    ),\n    local!f1: try(\n      (2 * local!recall * local!precision) / (local!recall + local!precision),\n      null\n    ),\n    #\"urn:appian:function:v1:a:update\"(\n      #\"urn:appian:function:v1:a:update\"(\n        ri!ExtractionInstance,\n        recordType!AIA Extraction Instance.fields,\n        local!fields\n      ),\n      {\n        recordType!AIA Extraction Instance.accuracy,\n        recordType!AIA Extraction Instance.precision,\n        recordType!AIA Extraction Instance.recall,\n        recordType!AIA Extraction Instance.f1\n      },\n      {\n        local!accuracy,\n        local!precision,\n        local!recall,\n        local!f1\n      }\n    )\n  )\n)"
    }
  }
}