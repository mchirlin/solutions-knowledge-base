{
  "uuid": "_a-0000ecbe-e702-8000-9cf8-011c48011c48_3247377",
  "name": "CMGT_Automation_ModifyWorkflowEventConstructor",
  "type": "Expression Rule",
  "description": "construct the events that should be written during the modify workflow action for automations",
  "sail_code": "a!localVariables(\n  local!originalAutomationGoToBranches: rule!CMGT_QR_GetTaskBranch(\n    additionalFilters: #\"SYSTEM_SYSRULES_queryFilter\"(\n      field: recordType!CMGT_TaskBranch.beforeTaskInstanceUuid,\n      operator: \"=\",\n      value: ri!task[recordType!CMGT_Task.taskInstanceUuid]\n    )\n  ),\n  local!automationSpecificNewBranches: rule!CMGT_UTIL_Filter(\n    records: ri!newAutomationGoToBranches,\n    field: recordType!CMGT_TaskBranch.beforeTaskInstanceUuid,\n    value: ri!task[recordType!CMGT_Task.taskInstanceUuid]\n  ),\n  if(\n    rule!CMGT_UTIL_IsBlank(ri!originalTask),\n    /*new automation added*/\n    rule!CMGT_TaskEventHistory_Constructor(\n      taskId: ri!task[recordType!CMGT_Task.taskId],\n      initiator: ri!initiator,\n      eventTypeId: cons!CMGT_REFID_EVENT_TYPE_TASK_ADD_ACTIVITY,\n      details: a!map(\n        automationType: ri!automationType,\n        taskBehaviorType: ri!task[recordType!CMGT_Task.taskBehaviorType.label]\n      ),\n      \n    ),\n    if(\n      ri!task[recordType!CMGT_Task.isActive] = 0,\n      /*automation removed from workflow*/\n      rule!CMGT_TaskEventHistory_Constructor(\n        taskId: ri!task[recordType!CMGT_Task.taskId],\n        initiator: ri!initiator,\n        eventTypeId: cons!CMGT_REFID_EVENT_TYPE_TASK_REMOVE_ACTIVITY,\n        details: a!map(\n          value: ri!task[recordType!CMGT_Task.title],\n          taskBehaviorType: ri!task[recordType!CMGT_Task.taskBehaviorType.label],\n          automationType: ri!automationType\n        ),\n        \n      ),\n      /*check on any changes in the automation fields*/\n      rule!CMGT_UTIL_RejectBlank(\n        {\n          /*Check name(title) */\n          if(\n            ri!task[recordType!CMGT_Task.title] <> ri!originalTask[recordType!CMGT_Task.title],\n            rule!CMGT_TaskEventHistory_Constructor(\n              taskId: ri!task[recordType!CMGT_Task.taskId],\n              initiator: ri!initiator,\n              eventTypeId: cons!CMGT_REFID_EVENT_TYPE_TASK_UPDATE_NAME,\n              details: a!map(\n                originalValue: ri!originalTask[recordType!CMGT_Task.title],\n                newValue: ri!task[recordType!CMGT_Task.title],\n                automationType: ri!automationType,\n                taskBehaviorType: ri!task[recordType!CMGT_Task.taskBehaviorType.label]\n              )\n            ),\n            null\n          ),\n          if(\n            or(\n              or(\n                /*added additional rule with condition*/\n                length(\n                  {\n                    ri!task[recordType!CMGT_Task.conditionSet]\n                  }\n                ) <> length(\n                  {\n                    ri!originalTask[recordType!CMGT_Task.conditionSet]\n                  }\n                ),\n                /*added additional conditions within an existing condition set*/\n                length(\n                  a!flatten(\n                    ri!task[#\"urn:appian:record-relationship:v1:ee5aa46d-0228-430f-a794-1134a11fbcc0/5189c3ac-98e2-4a82-8598-2e9561baec9d/64b891e4-359b-48b4-9f47-2a3af4695c34/52813580-ecf3-49c7-be71-568ab452d54a\"]\n                  )\n                ) <> length(\n                  a!flatten(\n                    ri!originalTask[#\"urn:appian:record-relationship:v1:ee5aa46d-0228-430f-a794-1134a11fbcc0/5189c3ac-98e2-4a82-8598-2e9561baec9d/64b891e4-359b-48b4-9f47-2a3af4695c34/52813580-ecf3-49c7-be71-568ab452d54a\"]\n                  )\n                ),\n                /*adding additional go tos for a condition set/ the if no rule is met path*/\n                length(local!automationSpecificNewBranches) <> length(local!originalAutomationGoToBranches)\n              ),\n              /*removing existing go tos for a condition set / the if no rule is met path or changing the existing branch values*/\n              or(\n                a!flatten(\n                  #\"SYSTEM_SYSRULES_forEach\"(\n                    items: local!automationSpecificNewBranches,\n                    expression: a!localVariables(\n                      local!automationSpecificOriginalBranch: rule!CMGT_UTIL_Filter(\n                        records: local!originalAutomationGoToBranches,\n                        field: recordType!CMGT_TaskBranch.taskBranchId,\n                        value: fv!item[recordType!CMGT_TaskBranch.taskBranchId]\n                      ),\n                      {\n                        fv!item[recordType!CMGT_TaskBranch.beforeTaskInstanceUuid] <> local!automationSpecificOriginalBranch[recordType!CMGT_TaskBranch.beforeTaskInstanceUuid],\n                        fv!item[recordType!CMGT_TaskBranch.afterTaskInstanceUuid] <> local!automationSpecificOriginalBranch[recordType!CMGT_TaskBranch.afterTaskInstanceUuid],\n                        fv!item[recordType!CMGT_TaskBranch.conditionSetUuid] <> local!automationSpecificOriginalBranch[recordType!CMGT_TaskBranch.conditionSetUuid],\n                        fv!item[recordType!CMGT_TaskBranch.isActive] <> local!automationSpecificOriginalBranch[recordType!CMGT_TaskBranch.isActive],\n                        \n                      }\n                    )\n                  )\n                )\n              )/*changing the operator for a condition set*/\n              or(\n                a!flatten(\n                  #\"SYSTEM_SYSRULES_forEach\"(\n                    items: ri!task[recordType!CMGT_Task.conditionSet],\n                    expression: a!localVariables(\n                      local!originalChildConditionSet: rule!CMGT_UTIL_Filter(\n                        records: ri!originalTask[recordType!CMGT_Task.conditionSet],\n                        field: recordType!CMGT_ConditionSet.conditionSetId,\n                        value: fv!item[recordType!CMGT_ConditionSet.conditionSetId]\n                      ),\n                      a!flatten(\n                        {\n                          fv!item[recordType!CMGT_ConditionSet.parentConditionSetUuid] <> local!originalChildConditionSet[recordType!CMGT_ConditionSet.parentConditionSetUuid],\n                          fv!item[recordType!CMGT_ConditionSet.operatorCode] <> local!originalChildConditionSet[recordType!CMGT_ConditionSet.operatorCode],\n                          fv!item[recordType!CMGT_ConditionSet.isActive] <> local!originalChildConditionSet[recordType!CMGT_ConditionSet.isActive],\n                          /*updating the field, operator, or value for a condition*/\n                          #\"SYSTEM_SYSRULES_forEach\"(\n                            items: fv!item[recordType!CMGT_ConditionSet.condition],\n                            expression: a!localVariables(\n                              local!currentItem: fv!item,\n                              local!originalCondition: rule!CMGT_UTIL_Filter(\n                                records: a!flatten(\n                                  {\n                                    local!originalChildConditionSet[recordType!CMGT_ConditionSet.condition]\n                                  }\n                                ),\n                                field: recordType!CMGT_Condition.conditionId,\n                                value: local!currentItem[recordType!CMGT_Condition.conditionId]\n                              ),\n                              {\n                                local!currentItem[recordType!CMGT_Condition.fieldPathJson] <> local!originalCondition[recordType!CMGT_Condition.fieldPathJson],\n                                local!currentItem[recordType!CMGT_Condition.operator] <> local!originalCondition[recordType!CMGT_Condition.operator],\n                                local!currentItem[recordType!CMGT_Condition.valueJson] <> local!originalCondition[recordType!CMGT_Condition.valueJson],\n                                local!currentItem[recordType!CMGT_Condition.valueType] <> local!originalCondition[recordType!CMGT_Condition.valueType],\n                                local!currentItem[recordType!CMGT_Condition.isActive] <> toboolean(\n                                  local!originalCondition[recordType!CMGT_Condition.isActive]\n                                )\n                              }\n                            )\n                          )\n                        }\n                      )\n                    )\n                  )\n                )\n              )\n            ),\n            rule!CMGT_TaskEventHistory_Constructor(\n              taskId: ri!task[recordType!CMGT_Task.taskId],\n              initiator: ri!initiator,\n              eventTypeId: cons!CMGT_REFID_EVENT_TYPE_TASK_UPDATE_ACTIVITY,\n              /*We are capturing condition set details only when there is any change in the condition set(Both Go to branches or Conditions).This data will\n              be used in task summary*/\n              details: a!map(\n                conditionSetsGoesTo: rule!CMGT_UTIL_Distinct(\n                  rule!CMGT_UTIL_RejectBlank(\n                    {\n                      a!flatten(\n                        #\"SYSTEM_SYSRULES_forEach\"(\n                          items: local!automationSpecificNewBranches,\n                          expression: a!localVariables(\n                            local!automationSpecificOriginalBranch: rule!CMGT_UTIL_Filter(\n                              records: local!originalAutomationGoToBranches,\n                              field: recordType!CMGT_TaskBranch.taskBranchId,\n                              value: fv!item[recordType!CMGT_TaskBranch.taskBranchId]\n                            ),\n                            if(\n                              or(\n                                a!isNullOrEmpty(\n                                  fv!item[recordType!CMGT_TaskBranch.taskBranchId]\n                                ),\n                                fv!item[recordType!CMGT_TaskBranch.afterTaskInstanceUuid] <> local!automationSpecificOriginalBranch[recordType!CMGT_TaskBranch.afterTaskInstanceUuid],\n                                fv!item[recordType!CMGT_TaskBranch.isActive] <> local!automationSpecificOriginalBranch[recordType!CMGT_TaskBranch.isActive],\n                                \n                              ),\n                              a!defaultValue(\n                                fv!item[recordType!CMGT_TaskBranch.conditionSetUuid],\n                                \"EMPTY\"\n                              ),\n                              null\n                            )\n                          )\n                        )\n                      )\n                    }\n                  )\n                ),\n                conditionSetData: rule!CMGT_UTIL_Distinct(\n                  rule!CMGT_UTIL_RejectBlank(\n                    {\n                      a!flatten(\n                        #\"SYSTEM_SYSRULES_forEach\"(\n                          items: ri!task[recordType!CMGT_Task.conditionSet],\n                          expression: a!localVariables(\n                            local!originalChildConditionSet: rule!CMGT_UTIL_Filter(\n                              records: ri!originalTask[recordType!CMGT_Task.conditionSet],\n                              field: recordType!CMGT_ConditionSet.conditionSetId,\n                              value: fv!item[recordType!CMGT_ConditionSet.conditionSetId]\n                            ),\n                            if(\n                              or(\n                                a!flatten(\n                                  {\n                                    /*added additional conditions within an existing condition set*/\n                                    length(\n                                      a!flatten(\n                                        fv!item[recordType!CMGT_ConditionSet.condition]\n                                      )\n                                    ) <> length(\n                                      a!flatten(\n                                        rule!CMGT_UTIL_Filter(\n                                          records: ri!originalTask[recordType!CMGT_Task.conditionSet],\n                                          field: recordType!CMGT_ConditionSet.conditionSetId,\n                                          value: fv!item[recordType!CMGT_ConditionSet.conditionSetId]\n                                        )[recordType!CMGT_ConditionSet.condition]\n                                      )\n                                    ),\n                                    fv!item[recordType!CMGT_ConditionSet.parentConditionSetUuid] <> local!originalChildConditionSet[recordType!CMGT_ConditionSet.parentConditionSetUuid],\n                                    fv!item[recordType!CMGT_ConditionSet.operatorCode] <> local!originalChildConditionSet[recordType!CMGT_ConditionSet.operatorCode],\n                                    fv!item[recordType!CMGT_ConditionSet.isActive] <> toboolean(\n                                      local!originalChildConditionSet[recordType!CMGT_ConditionSet.isActive]\n                                    ),\n                                    /*updating the field, operator, or value for a condition*/\n                                    #\"SYSTEM_SYSRULES_forEach\"(\n                                      items: index(\n                                        fv!item,\n                                        recordType!CMGT_ConditionSet.condition,\n                                        {}\n                                      ),\n                                      expression: a!localVariables(\n                                        local!currentItem: fv!item,\n                                        local!originalCondition: rule!CMGT_UTIL_Filter(\n                                          records: a!flatten(\n                                            {\n                                              local!originalChildConditionSet[recordType!CMGT_ConditionSet.condition]\n                                            }\n                                          ),\n                                          field: recordType!CMGT_Condition.conditionId,\n                                          value: local!currentItem[recordType!CMGT_Condition.conditionId]\n                                        ),\n                                        {\n                                          index(\n                                            local!currentItem,\n                                            recordType!CMGT_Condition.fieldPathJson,\n                                            null\n                                          ) <> index(\n                                            local!originalCondition,\n                                            recordType!CMGT_Condition.fieldPathJson,\n                                            null\n                                          ),\n                                          index(\n                                            local!currentItem,\n                                            recordType!CMGT_Condition.operator,\n                                            null\n                                          ) <> index(\n                                            local!originalCondition,\n                                            recordType!CMGT_Condition.operator,\n                                            null\n                                          ),\n                                          index(\n                                            local!currentItem,\n                                            recordType!CMGT_Condition.valueJson,\n                                            null\n                                          ) <> index(\n                                            local!originalCondition,\n                                            recordType!CMGT_Condition.valueJson,\n                                            null\n                                          ),\n                                          index(\n                                            local!currentItem,\n                                            recordType!CMGT_Condition.valueType,\n                                            null\n                                          ) <> index(\n                                            local!originalCondition,\n                                            recordType!CMGT_Condition.valueType,\n                                            null\n                                          ),\n                                          index(\n                                            local!currentItem,\n                                            recordType!CMGT_Condition.isActive,\n                                            null\n                                          ) <> toboolean(\n                                            index(\n                                              local!originalCondition,\n                                              recordType!CMGT_Condition.isActive,\n                                              null\n                                            )\n                                          )\n                                        }\n                                      )\n                                    )\n                                  }\n                                )\n                              ),\n                              fv!item[recordType!CMGT_ConditionSet.conditionSetId],\n                              null\n                            )\n                          )\n                        )\n                      )\n                    }\n                  )\n                ),\n                taskBehaviorType: ri!task[recordType!CMGT_Task.taskBehaviorType.label],\n                automationType: ri!automationType\n              )\n            ),\n            null\n          )\n        }\n      )\n    )\n  )\n)",
  "calls": [
    {
      "name": "CMGT_QR_GetTaskBranch",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "CMGT_UTIL_Filter",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "CMGT_UTIL_IsBlank",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "CMGT_TaskEventHistory_Constructor",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "CMGT_UTIL_RejectBlank",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "CMGT_UTIL_Distinct",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    },
    {
      "name": "CMGT_REFID_EVENT_TYPE_TASK_ADD_ACTIVITY",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "CMGT_REFID_EVENT_TYPE_TASK_REMOVE_ACTIVITY",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "CMGT_REFID_EVENT_TYPE_TASK_UPDATE_NAME",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "CMGT_REFID_EVENT_TYPE_TASK_UPDATE_ACTIVITY",
      "type": "Constant",
      "dep_type": "USES_CONSTANT"
    },
    {
      "name": "CMGT_TaskBranch",
      "type": "Record Type",
      "dep_type": "USES_RECORD_TYPE"
    },
    {
      "name": "CMGT_Task",
      "type": "Record Type",
      "dep_type": "USES_RECORD_TYPE"
    },
    {
      "name": "CMGT_ConditionSet",
      "type": "Record Type",
      "dep_type": "USES_RECORD_TYPE"
    },
    {
      "name": "CMGT_Condition",
      "type": "Record Type",
      "dep_type": "USES_RECORD_TYPE"
    }
  ],
  "called_by": [
    {
      "name": "CMGT_Task_SetEvents",
      "type": "Expression Rule",
      "dep_type": "CALLS"
    }
  ]
}